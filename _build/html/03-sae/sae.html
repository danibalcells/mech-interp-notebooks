
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Sparse Autoencoders &amp; Superposition &#8212; Dani Balcells&#39;s Mechanistic Interpretability Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03-sae/sae';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Frequency-Domain Analysis and Fourier Transforms" href="../00-basic-concepts/01-fourier-transform.html" />
    <link rel="prev" title="Mechanistic Interpretability Notebooks" href="../intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Dani Balcells's Mechanistic Interpretability Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Mechanistic Interpretability Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">In progress</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Sparse Autoencoders &amp; Superposition</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00-basic-concepts/01-fourier-transform.html">Frequency-Domain Analysis and Fourier Transforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Research Reproductions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01-grokking-modular-addition/01-grokking-modular-addition.html">Grokking Modular Addition</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Thoughts &amp; Essays</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../02-thoughts-essays/2023-02-24-klara-and-the-sun.html">Klara and the Sun</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/danielbalcells/mech-interp-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/03-sae/sae.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Sparse Autoencoders & Superposition</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monday-4-29-24">Monday 4/29/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tuesday-4-30-24">Tuesday 4/30/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thursday-5-2-24">Thursday 5/2/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monday-5-6-24">Monday 5/6/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tuesday-5-7-24">Tuesday 5/7/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#messy-from-here-on">Messy from here on</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hf-dataset">HF dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gelu-model">GELU Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sae">SAE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-activation-dataset">Generating activation dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plugging-sae-into-transformer">Plugging SAE into transformer</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="sparse-autoencoders-superposition">
<h1>Sparse Autoencoders &amp; Superposition<a class="headerlink" href="#sparse-autoencoders-superposition" title="Link to this heading">#</a></h1>
<section id="monday-4-29-24">
<h2>Monday 4/29/24<a class="headerlink" href="#monday-4-29-24" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Paired with Peter Kang.</p></li>
<li><p>Read <a class="reference external" href="https://transformer-circuits.pub/2023/monosemantic-features">Towards Monosemanticity</a>.</p></li>
<li><p>We started out (too ambitiously) trying to implement and train a one-layer transformer from scratch simply for the purposes of this study.</p></li>
<li><p>We realized that would be worthy of its own separate study and notebook, and that the main purpose of this study is to study superposition and to implement SAEs, so we chose to use an off-the shelf model from TransformerLens.</p></li>
<li><p>At first we wanted to train it ourselves. We ran into some annoying bugs with HF datasets that wouldn’t let us iterate over the dataset for training.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">DataCollatorWithPadding</span>
<span class="kn">from</span> <span class="nn">transformer_lens</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">ActivationCache</span><span class="p">,</span> <span class="n">HookedTransformer</span><span class="p">,</span> <span class="n">HookedTransformerConfig</span>
<span class="kn">from</span> <span class="nn">transformer_lens.hook_points</span> <span class="kn">import</span> <span class="n">HookPoint</span>
<span class="kn">import</span> <span class="nn">wandb</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;JeanKaddour/minipile&#39;</span><span class="p">)</span>
<span class="c1"># dataset.save_to_disk(&#39;minipile&#39;)</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="n">HookedTransformerConfig</span><span class="p">(</span>
    <span class="n">n_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">d_model</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">n_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">d_head</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">n_ctx</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
    <span class="n">tokenizer_name</span><span class="o">=</span><span class="s1">&#39;EleutherAI/gpt-neox-20b&#39;</span><span class="p">,</span>
    <span class="n">act_fn</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">)</span>
<span class="n">pretrained_gelu_model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;gelu-1l&#39;</span><span class="p">)</span>


<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> 
                                  <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                  <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                  <span class="n">report_to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">training_args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded pretrained model gelu-1l into HookedTransformer
Moving model to device:  mps
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/dani/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/accelerate/accelerator.py:432: FutureWarning:

Passing the following arguments to `Accelerator` is deprecated and will be removed in version 1.0 of Accelerate: dict_keys([&#39;dispatch_batches&#39;, &#39;split_batches&#39;, &#39;even_batches&#39;, &#39;use_seedable_sampler&#39;]). Please pass an `accelerate.DataLoaderConfiguration` instead: 
dataloader_config = DataLoaderConfiguration(dispatch_batches=None, split_batches=False, even_batches=True, use_seedable_sampler=True)
</pre></div>
</div>
</div>
</div>
<p>This call breaks when enumerating the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moving model to device:  mps
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
	- Avoid using `tokenizers` before the fork if possible
	- Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)
</pre></div>
</div>
<div class="output text_html">wandb version 0.16.6 is available!  To upgrade, please run:
 $ pip install wandb --upgrade</div><div class="output text_html">Tracking run with wandb version 0.13.10</div><div class="output text_html">Run data is saved locally in <code>/Users/dani/code/mech-interp-notebooks old/03-sae/wandb/run-20240506_144506-w9cbfk3m</code></div><div class="output text_html">Syncing run <strong><a href='https://wandb.ai/danibalcells/huggingface/runs/w9cbfk3m' target="_blank">usual-surf-8</a></strong> to <a href='https://wandb.ai/danibalcells/huggingface' target="_blank">Weights & Biases</a> (<a href='https://wandb.me/run' target="_blank">docs</a>)<br/></div><div class="output text_html"> View project at <a href='https://wandb.ai/danibalcells/huggingface' target="_blank">https://wandb.ai/danibalcells/huggingface</a></div><div class="output text_html"> View run at <a href='https://wandb.ai/danibalcells/huggingface/runs/w9cbfk3m' target="_blank">https://wandb.ai/danibalcells/huggingface/runs/w9cbfk3m</a></div><script type="application/vnd.jupyter.widget-view+json">{"model_id": "10822c7233b14a6cb171d6d2e92318ad", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Invalid key: 999976 is out of bounds for size 0
</pre></div>
</div>
<div class="output text_html">Waiting for W&B process to finish... <strong style="color:green">(success).</strong></div><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e17e7e35e2cb414781e1c6f28cd9e519", "version_major": 2, "version_minor": 0}</script><div class="output text_html"> View run <strong style="color:#cdcd00">usual-surf-8</strong> at: <a href='https://wandb.ai/danibalcells/huggingface/runs/w9cbfk3m' target="_blank">https://wandb.ai/danibalcells/huggingface/runs/w9cbfk3m</a><br/>Synced 5 W&B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)</div><div class="output text_html">Find logs at: <code>./wandb/run-20240506_144506-w9cbfk3m/logs</code></div></div>
</div>
<p>This reproduces the bug:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_train_dataloader</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Invalid key: 999976 is out of bounds for size 0
</pre></div>
</div>
</div>
</div>
<p>Might want to keep loking into it, or might be worth just working with a pretrained one-layer transformer, since, again, the main goal for this study is to train an SAE and use it to interpret activations.</p>
</section>
<section id="tuesday-4-30-24">
<h2>Tuesday 4/30/24<a class="headerlink" href="#tuesday-4-30-24" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Decided to use pretrained 1L transformer from TransformerLens.</p></li>
<li><p>Created SAE class.</p></li>
<li><p>Created dataset to train SAE by sampling MLP activations using minipile dataset.</p></li>
<li><p>Implemented basic SAE training loop.</p></li>
<li><p>Trained SAE.</p></li>
</ul>
<p>Loading pre-trained GELU model and creating SAE class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">einops</span>

<span class="kn">from</span> <span class="nn">transformer_lens</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">ActivationCache</span><span class="p">,</span> <span class="n">HookedTransformer</span><span class="p">,</span> <span class="n">HookedTransformerConfig</span>
<span class="kn">from</span> <span class="nn">transformer_lens.hook_points</span> <span class="kn">import</span> <span class="n">HookPoint</span>

<span class="n">gelu_model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;gelu-1l&#39;</span><span class="p">)</span>

<span class="n">sae_input_dim</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">d_mlp</span>
<span class="n">sae_hidden_dim</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">sae_input_dim</span>
<span class="n">sae_output_dim</span> <span class="o">=</span> <span class="n">sae_input_dim</span>

<span class="k">class</span> <span class="nc">SAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">input_dim</span><span class="o">=</span><span class="n">sae_input_dim</span><span class="p">,</span>
                 <span class="n">hidden_dim</span><span class="o">=</span><span class="n">sae_hidden_dim</span><span class="p">,</span>
                 <span class="n">init_range</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_range</span> <span class="o">=</span> <span class="n">init_range</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">relu</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">inputs_centered</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">inputs_centered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span>
                                  <span class="s1">&#39;batch input_dim, hidden_dim input_dim -&gt; batch hidden_dim&#39;</span><span class="p">)</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">act_input</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">act_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span><span class="p">,</span>
                               <span class="s1">&#39;batch hidden_dim, input_dim hidden_dim -&gt; batch input_dim&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded pretrained model gelu-1l into HookedTransformer
</pre></div>
</div>
</div>
</div>
<p>Helper tokenization functions, running sample text through model and caching activations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">strings_to_tokens</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">string</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">pad_sequence</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;we are so back lmao&#39;</span><span class="p">,</span> <span class="s1">&#39;omg&#39;</span><span class="p">,</span> <span class="s1">&#39;pad see ew&#39;</span><span class="p">]</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">strings_to_tokens</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>

<span class="n">gelu_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">logits</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">run_with_cache</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">decode</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[  664,   403,   594,   896,   298,   785,    80],
        [  297,    72,     0,     0,     0,     0,     0],
        [11022,   923,   299,    88,     0,     0,     0]])
[&#39;ausausausausausausaus&#39;, &#39;0stThe####&#39;, &#39;\r\ns\nendfrom##&#39;]
</pre></div>
</div>
</div>
</div>
<p>Running cached activations through SAE and verifying shapes match.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sae</span> <span class="o">=</span> <span class="n">SAE</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">acts</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="n">acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">acts_flat</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="s1">&#39;b s d_mlp -&gt; (b s) d_mlp&#39;</span><span class="p">)</span>

<span class="n">encodings</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">acts_flat</span><span class="p">)</span>
<span class="n">sae_output</span> <span class="o">=</span> <span class="n">sae</span><span class="p">(</span><span class="n">acts_flat</span><span class="p">)</span>
<span class="n">sae_output</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">sae_output</span><span class="p">,</span> <span class="s1">&#39;(b s) d_mlp -&gt; b s d_mlp&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original activations shape: </span><span class="si">{</span><span class="n">acts</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SAE output shape: </span><span class="si">{</span><span class="n">sae_output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original activations shape: torch.Size([3, 7, 2048])
SAE output shape: torch.Size([3, 7, 2048])
</pre></div>
</div>
</div>
</div>
<p>Generating SAE training dataset by caching MLP activations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">dataset_name</span> <span class="o">=</span> <span class="s1">&#39;JeanKaddour/minipile&#39;</span>
<span class="n">train_text</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[:1024]&#39;</span><span class="p">)</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">512</span>

<span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">tokenized_row</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">)</span>
    <span class="n">pad_length</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;token_type_ids&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="k">return</span> <span class="n">tokenized_row</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_text</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_row</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">all_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">_</span> <span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">run_with_cache</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">]</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="s1">&#39;batch sequence d_mlp -&gt; (batch sequence) d_mlp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">all_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">all_acts</span><span class="p">,</span> <span class="n">acts</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
<span class="c1"># t.save(all_acts.detach(), f=&#39;mlp_activations_64bs_512l_minipile1024_gelu1l.pkl&#39;)</span>
</pre></div>
</div>
</div>
</div>
<p>Training SAE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="n">sae</span><span class="p">,</span> <span class="n">l1_coeff</span><span class="o">=</span><span class="mf">0.006</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">sae_output</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">rec_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">acts</span> <span class="o">-</span> <span class="n">sae_output</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">l1_loss</span> <span class="o">=</span> <span class="n">l1_coeff</span> <span class="o">*</span> <span class="n">features</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rec_loss</span> <span class="o">+</span> <span class="n">l1_loss</span><span class="p">)</span>

<span class="n">rand_indices</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">all_acts</span> <span class="o">=</span> <span class="n">all_acts</span><span class="p">[</span><span class="n">rand_indices</span><span class="p">]</span>
<span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span>

<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">l1_coeff</span> <span class="o">=</span> <span class="mf">0.006</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">sae</span> <span class="o">=</span> <span class="n">SAE</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">sae</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">sae</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)):</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">batch_size</span>
    <span class="n">epoch_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">)):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">all_acts</span><span class="p">[</span><span class="n">i_batch</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:</span> <span class="p">(</span><span class="n">i_batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">get_loss</span><span class="p">(</span><span class="n">acts</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">sae</span><span class="o">=</span><span class="n">sae</span><span class="p">,</span> <span class="n">l1_coeff</span><span class="o">=</span><span class="n">l1_coeff</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">epoch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i_batch</span><span class="o">%</span><span class="k">100</span> == 0 or (i_batch &lt; 100 and i_batch % 10 == 0 and i==0)):
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">i_batch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting training loss.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="n">all_losses</span> <span class="o">=</span> <span class="n">losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">losses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">losses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">all_losses</span><span class="p">,</span> <span class="n">log_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">115</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">all_losses</span> <span class="o">=</span> <span class="n">losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">losses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">losses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">all_losses</span><span class="p">,</span> <span class="n">log_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;losses&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>One-hot SAE feature vectors don’t always get well reconstructed by decoding and encoding. We loop through features and measure a few ratios:</p>
<ul class="simple">
<li><p>Ratio between reconstructed value at one-hot encoded feature and the max value of that reconstruction.</p></li>
<li><p>Ratio between reconstructed value at one-hot encoded feature and mean value of all SAE reconstructions.</p></li>
<li><p>Same but with squares.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_features_roundtrip</span><span class="p">(</span><span class="n">sae</span><span class="p">):</span>
    <span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">max_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mean_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">square_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">test_feature_index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)):</span>
        <span class="n">test_feature</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">test_feature</span><span class="p">[</span><span class="n">test_feature_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">test_feature</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">test_mlp_activation</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">test_feature</span><span class="p">)</span>
        <span class="n">encoded_features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">test_mlp_activation</span><span class="p">)</span>
        <span class="n">max_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mean_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">square_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">max_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">mean_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">square_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">square_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="c1"># px.line(encoded_features[0].cpu().detach().numpy())</span>
    <span class="k">return</span> <span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span>

<span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span> <span class="o">=</span> <span class="n">test_features_roundtrip</span><span class="p">(</span><span class="n">sae</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">max_ratios</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 16384/16384 [01:30&lt;00:00, 180.98it/s]
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">114</span><span class="p">],</span> <span class="n">line</span> <span class="mi">23</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>     <span class="k">return</span> <span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span> <span class="o">=</span> <span class="n">test_features_roundtrip</span><span class="p">(</span><span class="n">sae</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">23</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">max_ratios</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;px&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="thursday-5-2-24">
<h2>Thursday 5/2/24<a class="headerlink" href="#thursday-5-2-24" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Used TransformerLens hooks to plug SAE after MLP in transformer.</p></li>
<li><p>Wrote some helper functions to compare performance with/without SAE.</p></li>
</ul>
<p>Plugging SAE into transformer using TransformerLens hooks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">sae</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;sae-0430.pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mlp_activations_64bs_512l_minipile1024_gelu1l.pkl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">feats</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_str</span> <span class="o">=</span> <span class="s1">&#39;Hello from the other side this is incredible&#39;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_str</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">input_str_tokenized</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>

<span class="n">mlp_acts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sae_feats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mlp_acts_reconstructed</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">save_mlp_acts_hook</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
    <span class="n">mlp_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sae_reconstruction_hook</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
    <span class="n">mlp_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">flat_value</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;b s d_mlp -&gt; (b s) d_mlp&#39;</span><span class="p">)</span>
    <span class="c1"># Encode MLP acts into SAE features</span>
    <span class="n">flat_sae_feats</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">flat_value</span><span class="p">)</span>
    <span class="n">reshaped_sae_feats</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">flat_sae_feats</span><span class="p">,</span> <span class="s1">&#39;(b s) hidden_dim -&gt; b s hidden_dim&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">sae_feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reshaped_sae_feats</span><span class="p">)</span>
    <span class="c1"># Decode SAE features to reconstruct MLP activations</span>
    <span class="n">flat_mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">flat_sae_feats</span><span class="p">)</span>
    <span class="n">reshaped_mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">flat_mlp_acts_reconstructed</span><span class="p">,</span>
                                                       <span class="s1">&#39;(b s) d_mlp -&gt; b s d_mlp&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">mlp_acts_reconstructed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reshaped_mlp_acts_reconstructed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reshaped_mlp_acts_reconstructed</span>


<span class="n">gelu_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>
<span class="n">logits_sae</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">run_with_hooks</span><span class="p">(</span>
    <span class="n">input_tokens</span><span class="p">,</span>
    <span class="n">fwd_hooks</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span>
        <span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">,</span>
        <span class="n">sae_reconstruction_hook</span>
    <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">logits_sae</span> <span class="o">=</span> <span class="n">logits_sae</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">mlp_acts</span> <span class="o">=</span> <span class="n">mlp_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sae_feats</span> <span class="o">=</span> <span class="n">sae_feats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">mlp_acts_reconstructed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>A few helper functions to start comparing performance with/without SAE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">top_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pos_top_tokens</span> <span class="o">=</span> <span class="n">sorted_inds</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span>
        <span class="n">pos_top_tokens_decoded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">top_k_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">top_k</span><span class="p">):</span>
            <span class="n">pos_top_tokens_decoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">pos_top_tokens</span><span class="p">[</span><span class="n">top_k_ind</span><span class="p">]))</span>
        <span class="n">top_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_top_tokens_decoded</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_tokens</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_tokens_orig</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
<span class="n">top_tokens_recons</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compare_top_tokens</span><span class="p">(</span><span class="n">input_str</span><span class="p">,</span> <span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">top_tokens_orig</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">top_tokens_recons</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">input_str_token</span><span class="p">,</span> <span class="n">top_k_orig</span><span class="p">,</span> <span class="n">top_k_recons</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_str</span><span class="p">,</span> 
                                                        <span class="n">top_tokens_orig</span><span class="p">,</span> 
                                                        <span class="n">top_tokens_recons</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input: </span><span class="si">{</span><span class="n">input_str_token</span><span class="si">}</span><span class="se">\t</span><span class="s1">Original top 5:</span><span class="si">{</span><span class="n">top_k_orig</span><span class="si">}</span><span class="se">\t</span><span class="s1">Reconstructed top 5:</span><span class="si">{</span><span class="n">top_k_recons</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">compare_top_tokens</span><span class="p">(</span><span class="n">input_str_tokenized</span><span class="p">,</span> <span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input: Hello	Original top 5:[&#39;0&#39;, &#39; I&#39;, &#39; Thanks&#39;, &#39;1&#39;, &#39; Thank&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; my&#39;, &#39; Thank&#39;, &#39;Hello&#39;, &#39;,&#39;]
Input: Ġfrom	Original top 5:[&#39; my&#39;, &#39; I&#39;, &#39;0&#39;, &#39; Welcome&#39;, &#39; 2&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39;0&#39;, &#39;D&#39;]
Input: Ġthe	Original top 5:[&#39; same&#39;, &#39; I&#39;, &#39; website&#39;, &#39; Welcome&#39;, &#39; name&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; my&#39;, &#39; course&#39;, &#39;Hi&#39;]
Input: Ġother	Original top 5:[&#39; website&#39;, &#39;Hello&#39;, &#39; course&#39;, &#39; part&#39;, &#39; blog&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39;I&#39;, &#39;Hi&#39;, &#39; my&#39;]
Input: Ġside	Original top 5:[&#39; of&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; and&#39;, &#39;0&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; of&#39;, &#39;I&#39;, &#39;Hello&#39;, &#39;Hi&#39;]
Input: Ġthis	Original top 5:[&#39;Hello&#39;, &#39; blog&#39;, &#39; is&#39;, &#39;Hi&#39;, &#39; I&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; my&#39;, &#39;Hello&#39;, &#39; blog&#39;, &#39; course&#39;]
Input: Ġis	Original top 5:[&#39; my&#39;, &#39;Hello&#39;, &#39; work&#39;, &#39; the&#39;, &#39; a&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39; the&#39;, &#39;,&#39;, &#39; blog&#39;]
Input: Ġincredible	Original top 5:[&#39; and&#39;, &#39; work&#39;, &#39;Hello&#39;, &#39; I&#39;, &#39;,&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;,&#39;, &#39;Hello&#39;, &#39; blog&#39;, &#39; and&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_crossentropy</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
    <span class="n">crossentropy</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">logits_sae</span><span class="p">,</span> 
                                                <span class="n">target</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crossentropy</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor(-453661.6250, device=&#39;mps:0&#39;, grad_fn=&lt;DivBackward1&gt;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="monday-5-6-24">
<h2>Monday 5/6/24<a class="headerlink" href="#monday-5-6-24" title="Link to this heading">#</a></h2>
<p>SAE with batch dimension.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">einops</span>

<span class="kn">from</span> <span class="nn">transformer_lens</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">ActivationCache</span><span class="p">,</span> <span class="n">HookedTransformer</span><span class="p">,</span> <span class="n">HookedTransformerConfig</span>
<span class="kn">from</span> <span class="nn">transformer_lens.hook_points</span> <span class="kn">import</span> <span class="n">HookPoint</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">gelu_model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;gelu-1l&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">sae_input_dim</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">d_mlp</span>
<span class="n">sae_hidden_dim</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">sae_input_dim</span>
<span class="n">sae_output_dim</span> <span class="o">=</span> <span class="n">sae_input_dim</span>

<span class="k">class</span> <span class="nc">SAEBaseline</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">input_dim</span><span class="o">=</span><span class="n">sae_input_dim</span><span class="p">,</span>
                 <span class="n">hidden_dim</span><span class="o">=</span><span class="n">sae_hidden_dim</span><span class="p">,</span>
                 <span class="n">init_range</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_range</span> <span class="o">=</span> <span class="n">init_range</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">relu</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">inputs_centered</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">inputs_centered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span>
                                  <span class="s1">&#39;batch seq input_dim, hidden_dim input_dim -&gt; batch seq hidden_dim&#39;</span><span class="p">)</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">act_input</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">act_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span><span class="p">,</span>
                               <span class="s1">&#39;batch seq hidden_dim, input_dim hidden_dim -&gt; batch seq input_dim&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded pretrained model gelu-1l into HookedTransformer
Moving model to device:  mps
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sae_flat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;sae-0430.pt&#39;</span><span class="p">)</span>
<span class="n">sae</span> <span class="o">=</span> <span class="n">SAE</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">sae</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">sae_flat</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<span class="n">all_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mlp_activations_64bs_512l_minipile1024_gelu1l.pkl&#39;</span><span class="p">)</span>
<span class="n">rand_indices</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">all_acts</span> <span class="o">=</span> <span class="n">all_acts</span><span class="p">[</span><span class="n">rand_indices</span><span class="p">]</span>
<span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([524288, 2048])
</pre></div>
</div>
</div>
</div>
<p>Eval functions including updated ones</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SAEActivationTracker</span><span class="p">:</span>
    <span class="n">mlp_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">feats</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reconstruction_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">hook</span><span class="p">,</span> <span class="n">sae</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp_acts</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">acts_reconstructed</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">acts_reconstructed</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">acts_reconstructed</span>
    
    <span class="k">def</span> <span class="nf">get_act_mse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp_acts_reconstructed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_acts</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">run_with_sae</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sae</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">sae_act_tracker</span><span class="p">):</span>
    <span class="n">hook_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">sae_act_tracker</span><span class="o">.</span><span class="n">reconstruction_hook</span><span class="p">,</span> <span class="n">sae</span><span class="o">=</span><span class="n">sae</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_with_hooks</span><span class="p">(</span>
        <span class="n">input_tokens</span><span class="p">,</span>
        <span class="n">fwd_hooks</span><span class="o">=</span><span class="p">[(</span>
           <span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">,</span>
           <span class="n">hook_fn</span>
        <span class="p">)]</span> 
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">logits</span>
    
<span class="k">def</span> <span class="nf">run_test_input</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_text</span><span class="p">):</span>
    <span class="n">input_tokens</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_text</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">input_str_tokenized</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>
    <span class="n">sae_act_tracker</span> <span class="o">=</span> <span class="n">SAEActivationTracker</span><span class="p">()</span>
    <span class="n">logits_sae</span> <span class="o">=</span> <span class="n">run_with_sae</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sae</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">sae_act_tracker</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">logits_sae</span><span class="p">,</span> <span class="n">sae_act_tracker</span>

<span class="k">def</span> <span class="nf">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">top_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pos_top_tokens</span> <span class="o">=</span> <span class="n">sorted_inds</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span>
        <span class="n">pos_top_tokens_decoded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">top_k_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">top_k</span><span class="p">):</span>
            <span class="n">pos_top_tokens_decoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">pos_top_tokens</span><span class="p">[</span><span class="n">top_k_ind</span><span class="p">]))</span>
        <span class="n">top_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_top_tokens_decoded</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_tokens</span>

<span class="k">def</span> <span class="nf">compare_top_tokens</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">input_tokens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="n">top_tokens_orig</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">top_tokens_recons</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">input_str_token</span><span class="p">,</span> <span class="n">top_k_orig</span><span class="p">,</span> <span class="n">top_k_recons</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">,</span> 
                                                        <span class="n">top_tokens_orig</span><span class="p">,</span> 
                                                        <span class="n">top_tokens_recons</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input: </span><span class="si">{</span><span class="n">input_str_token</span><span class="si">}</span><span class="se">\t</span><span class="s1">Original top 5:</span><span class="si">{</span><span class="n">top_k_orig</span><span class="si">}</span><span class="se">\t</span><span class="s1">Reconstructed top 5:</span><span class="si">{</span><span class="n">top_k_recons</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_crossentropy</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
    <span class="n">crossentropy</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">logits_sae</span><span class="p">,</span> 
                                                <span class="n">target</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crossentropy</span>

<span class="k">def</span> <span class="nf">test_features_roundtrip</span><span class="p">(</span><span class="n">sae</span><span class="p">):</span>
    <span class="n">max_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mean_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">square_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">test_feature_index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)):</span>
        <span class="n">test_feature</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">test_feature</span><span class="p">[</span><span class="n">test_feature_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">test_feature</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">test_feature</span><span class="p">,</span> <span class="s1">&#39;d_sae -&gt; 1 1 d_sae&#39;</span><span class="p">)</span>
        <span class="n">test_mlp_activation</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">test_feature</span><span class="p">)</span>
        <span class="n">encoded_features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">test_mlp_activation</span><span class="p">)</span>
        <span class="n">max_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mean_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">square_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test_feature_index</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">max_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">mean_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">square_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">square_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="c1"># px.line(encoded_features[0].cpu().detach().numpy())</span>
    <span class="k">return</span> <span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DEF_INPUT_TEXT</span> <span class="o">=</span> <span class="s1">&#39;Hello from the other side this is incredible&#39;</span>
<span class="k">def</span> <span class="nf">eval_sae_single_input</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_text</span><span class="o">=</span><span class="n">DEF_INPUT_TEXT</span><span class="p">):</span>
    <span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">input_text</span> <span class="o">=</span> <span class="n">DEF_INPUT_TEXT</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input text: </span><span class="si">{</span><span class="n">input_text</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logits</span><span class="p">,</span> <span class="n">logits_sae</span><span class="p">,</span> <span class="n">sae_act_tracker</span> <span class="o">=</span> <span class="n">run_test_input</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_text</span><span class="p">)</span>
    <span class="n">activation_mse</span> <span class="o">=</span> <span class="n">sae_act_tracker</span><span class="o">.</span><span class="n">get_act_mse</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE of MLP activation reconstruction: </span><span class="si">{</span><span class="n">activation_mse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">crossentropy</span> <span class="o">=</span> <span class="n">get_crossentropy</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Logit cross-entropy: </span><span class="si">{</span><span class="n">crossentropy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">compare_top_tokens</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="c1"># metrics = test_features_roundtrip(sae)</span>
<span class="n">eval_sae_single_input</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input text: Hello from the other side this is incredible
MSE of MLP activation reconstruction: 0.06152134761214256
Logit cross-entropy: -5.282353401184082
Input: Hello	Original top 5:[&#39;0&#39;, &#39; I&#39;, &#39; Thanks&#39;, &#39;1&#39;, &#39; Thank&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; my&#39;, &#39; Thank&#39;, &#39;Hello&#39;, &#39;,&#39;]
Input: Ġfrom	Original top 5:[&#39; my&#39;, &#39; I&#39;, &#39;0&#39;, &#39; Welcome&#39;, &#39; 2&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39;0&#39;, &#39;D&#39;]
Input: Ġthe	Original top 5:[&#39; same&#39;, &#39; I&#39;, &#39; website&#39;, &#39; Welcome&#39;, &#39; name&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; my&#39;, &#39; course&#39;, &#39;Hi&#39;]
Input: Ġother	Original top 5:[&#39; website&#39;, &#39;Hello&#39;, &#39; course&#39;, &#39; part&#39;, &#39; blog&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39;I&#39;, &#39;Hi&#39;, &#39; my&#39;]
Input: Ġside	Original top 5:[&#39; of&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; and&#39;, &#39;0&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; of&#39;, &#39;I&#39;, &#39;Hello&#39;, &#39;Hi&#39;]
Input: Ġthis	Original top 5:[&#39;Hello&#39;, &#39; blog&#39;, &#39; is&#39;, &#39;Hi&#39;, &#39; I&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; my&#39;, &#39;Hello&#39;, &#39; blog&#39;, &#39; course&#39;]
Input: Ġis	Original top 5:[&#39; my&#39;, &#39;Hello&#39;, &#39; work&#39;, &#39; the&#39;, &#39; a&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39; the&#39;, &#39;,&#39;, &#39; blog&#39;]
Input: Ġincredible	Original top 5:[&#39; and&#39;, &#39; work&#39;, &#39;Hello&#39;, &#39; I&#39;, &#39;,&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;,&#39;, &#39;Hello&#39;, &#39; blog&#39;, &#39; and&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="tuesday-5-7-24">
<h2>Tuesday 5/7/24<a class="headerlink" href="#tuesday-5-7-24" title="Link to this heading">#</a></h2>
<p>Simple reconstruction / cross-entropy eval with batches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">64</span>

<span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">tokenized_row</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">)</span>
    <span class="n">pad_length</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;token_type_ids&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="k">return</span> <span class="n">tokenized_row</span>

<span class="k">def</span> <span class="nf">eval_sae_batch</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">load_sample_training_dataset</span><span class="p">()</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_row</span><span class="p">)</span>
    <span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sae_act_tracker</span> <span class="o">=</span> <span class="n">SAEActivationTracker</span><span class="p">()</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">eval_dataloader</span><span class="p">))[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">logits_sae</span> <span class="o">=</span> <span class="n">run_with_sae</span><span class="p">(</span><span class="n">gelu_model</span><span class="p">,</span> <span class="n">sae</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">sae_act_tracker</span><span class="p">)</span>
    <span class="n">crossentropy</span> <span class="o">=</span> <span class="n">get_crossentropy</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">logits</span><span class="p">)</span>
    <span class="n">act_mse</span> <span class="o">=</span> <span class="n">sae_act_tracker</span><span class="o">.</span><span class="n">get_act_mse</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE of MLP activation reconstruction: </span><span class="si">{</span><span class="n">act_mse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Logit cross-entropy: </span><span class="si">{</span><span class="n">crossentropy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_sae_batch</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE of MLP activation reconstruction: 0.05483701825141907
Logit cross-entropy: 6.156724452972412
</pre></div>
</div>
</div>
</div>
<p>Parametrized training loop</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SAETrainingArgs</span><span class="p">:</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">l1_coeff</span> <span class="o">=</span> <span class="mf">0.006</span>
    <span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">sae_input_dim</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="n">sae_hidden_dim</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">2048</span>
    <span class="n">sae_init_range</span> <span class="o">=</span> <span class="mf">0.04</span>

<span class="k">class</span> <span class="nc">SAETrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">sae</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">SAETrainingArgs</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sae</span> <span class="o">=</span> <span class="n">sae</span> <span class="ow">or</span> <span class="n">SAEBaseline</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sae_input_dim</span><span class="p">,</span>
            <span class="n">hidden_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sae_hidden_dim</span><span class="p">,</span>
            <span class="n">init_range</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sae_init_range</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">forward_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">sae_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">sae_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sae_features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span>


    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sae_input</span><span class="p">,</span> <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span><span class="p">):</span>
        <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">sae_input</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">sae_output</span><span class="p">)</span>
        <span class="n">l1_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">l1_coeff</span> <span class="o">*</span> <span class="n">sae_features</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rec_loss</span> <span class="o">+</span> <span class="n">l1_loss</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">n_epochs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)):</span>
            <span class="n">n_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">epoch_losses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">)):</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span> <span class="p">(</span><span class="n">i_batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span><span class="p">)</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">epoch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i_batch</span><span class="o">%</span><span class="k">100</span> == 0 or (i_batch &lt; 100 and i_batch % 10 == 0 and i_epoch==0)):
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i_epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">i_batch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">SAETrainingArgs</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">SAETrainer</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">all_acts</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4c86d5f796c44e63b23d017668672f97", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b3218048675249b8b91daaadac08ae2d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/0: 8.059843063354492
0/10: 0.6643972992897034
0/20: 0.2511157691478729
0/30: 0.17078419029712677
0/40: 0.1337626874446869
0/50: 0.11448110640048981
0/60: 0.10468132048845291
0/70: 0.10155749320983887
0/80: 0.09741398692131042
0/90: 0.09736699610948563
0/100: 0.09556479007005692
0/200: 0.07525026798248291
0/300: 0.0641486644744873
0/400: 0.05799595266580582
0/500: 0.05352216958999634
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "502922d7ec2343ee892b2fd6301f0b5a", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/0: 0.05387045070528984
1/100: 0.04980052262544632
1/200: 0.04805203154683113
1/300: 0.04514504596590996
1/400: 0.04300673305988312
1/500: 0.041652925312519073
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2231a4574284404fa5123ce63078dc44", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/0: 0.04211990162730217
2/100: 0.04042728617787361
2/200: 0.039497096091508865
2/300: 0.03772585093975067
2/400: 0.03674452379345894
2/500: 0.036299630999565125
</pre></div>
</div>
</div>
</div>
<p>Eval trained model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_sae_batch</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2f2015d9fce34b41800e6987a9406325", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Truncation was not explicitly activated but `max_length` is provided a specific value, please use `truncation=True` to explicitly truncate examples to max length. Defaulting to &#39;longest_first&#39; truncation strategy. If you encode pairs of sequences (GLUE-style) with the tokenizer you can select this strategy more precisely by providing a specific strategy to `truncation`.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE of MLP activation reconstruction: 0.05411048233509064
Logit cross-entropy: 3.8706512451171875
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_sae_single_input</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input text: Hello from the other side this is incredible
MSE of MLP activation reconstruction: 0.05885123461484909
Logit cross-entropy: -5.33473539352417
Input: Hello	Original top 5:[&#39;0&#39;, &#39; I&#39;, &#39; Thanks&#39;, &#39;1&#39;, &#39; Thank&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; Thank&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; Thanks&#39;]
Input: Ġfrom	Original top 5:[&#39; my&#39;, &#39; I&#39;, &#39;0&#39;, &#39; Welcome&#39;, &#39; 2&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; My&#39;, &#39;my&#39;]
Input: Ġthe	Original top 5:[&#39; same&#39;, &#39; I&#39;, &#39; website&#39;, &#39; Welcome&#39;, &#39; name&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; my&#39;, &#39; blog&#39;, &#39;Hi&#39;]
Input: Ġother	Original top 5:[&#39; website&#39;, &#39;Hello&#39;, &#39; course&#39;, &#39; part&#39;, &#39; blog&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; my&#39;, &#39;Hi&#39;, &#39;I&#39;]
Input: Ġside	Original top 5:[&#39; of&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; and&#39;, &#39;0&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;I&#39;, &#39; of&#39;, &#39;Hello&#39;, &#39; my&#39;]
Input: Ġthis	Original top 5:[&#39;Hello&#39;, &#39; blog&#39;, &#39; is&#39;, &#39;Hi&#39;, &#39; I&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; my&#39;, &#39; blog&#39;, &#39;Hi&#39;]
Input: Ġis	Original top 5:[&#39; my&#39;, &#39;Hello&#39;, &#39; work&#39;, &#39; the&#39;, &#39; a&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39; the&#39;, &#39; blog&#39;, &#39;Hello&#39;]
Input: Ġincredible	Original top 5:[&#39; and&#39;, &#39; work&#39;, &#39;Hello&#39;, &#39; I&#39;, &#39;,&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39; blog&#39;, &#39; work&#39;, &#39;Hello&#39;, &#39; me&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span> <span class="o">=</span> <span class="n">test_features_roundtrip</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "95123b1f7a3147ef9c189d4d2e9dc783", "version_major": 2, "version_minor": 0}</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">82</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span> <span class="o">=</span> <span class="n">test_features_roundtrip</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">)</span>

<span class="nn">Cell In[46], line 82,</span> in <span class="ni">test_features_roundtrip</span><span class="nt">(sae)</span>
<span class="g g-Whitespace">     </span><span class="mi">80</span> <span class="n">mean_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span> <span class="n">square_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test_feature_index</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">82</span> <span class="n">max_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="g g-Whitespace">     </span><span class="mi">83</span> <span class="n">mean_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span> <span class="n">square_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">square_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">max_ratios</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>SAE improvements:</p>
<p>Decoder weight normalization</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sae</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">sae</span>
<span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">sae</span><span class="o">.</span><span class="n">W_d</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># sae.W_d.norm(dim=0).shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([1.7955, 1.8262, 1.8125,  ..., 1.8439, 1.7642, 1.4038], device=&#39;mps:0&#39;,
       grad_fn=&lt;NormBackward1&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">sae</span><span class="o">.</span><span class="n">W_d</span><span class="o">/</span><span class="n">sae</span><span class="o">.</span><span class="n">W_d</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor(1.0000, device=&#39;mps:0&#39;, grad_fn=&lt;SqrtBackward0&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SAEDecoderNorm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">input_dim</span><span class="o">=</span><span class="n">sae_input_dim</span><span class="p">,</span>
                 <span class="n">hidden_dim</span><span class="o">=</span><span class="n">sae_hidden_dim</span><span class="p">,</span>
                 <span class="n">init_range</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_range</span> <span class="o">=</span> <span class="n">init_range</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">relu</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">inputs_centered</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">inputs_centered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span>
                                  <span class="s1">&#39;batch seq input_dim, hidden_dim input_dim -&gt; batch seq hidden_dim&#39;</span><span class="p">)</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">act_input</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">act_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span><span class="p">,</span>
                               <span class="s1">&#39;batch seq hidden_dim, input_dim hidden_dim -&gt; batch seq input_dim&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">normalize_decoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">t</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    
<span class="k">class</span> <span class="nc">SAETrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">sae</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">SAETrainingArgs</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sae</span> <span class="o">=</span> <span class="n">sae</span> <span class="ow">or</span> <span class="n">SAEDecoderNorm</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sae_input_dim</span><span class="p">,</span>
            <span class="n">hidden_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sae_hidden_dim</span><span class="p">,</span>
            <span class="n">init_range</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sae_init_range</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">forward_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">sae_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">sae_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sae_features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span>


    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sae_input</span><span class="p">,</span> <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span><span class="p">):</span>
        <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">sae_input</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">sae_output</span><span class="p">)</span>
        <span class="n">l1_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">l1_coeff</span> <span class="o">*</span> <span class="n">sae_features</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rec_loss</span> <span class="o">+</span> <span class="n">l1_loss</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">n_epochs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)):</span>
            <span class="n">n_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">epoch_losses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">)):</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span> <span class="p">(</span><span class="n">i_batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">sae_features</span><span class="p">,</span> <span class="n">sae_output</span><span class="p">)</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sae</span><span class="o">.</span><span class="n">normalize_decoder</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">epoch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i_batch</span><span class="o">%</span><span class="k">100</span> == 0 or (i_batch &lt; 100 and i_batch % 10 == 0 and i_epoch==0)):
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i_epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">i_batch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_losses</span><span class="p">)</span>
        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">SAETrainingArgs</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">SAETrainer</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">all_acts</span><span class="p">,</span> <span class="n">sae</span><span class="o">=</span><span class="n">SAEDecoderNorm</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c94cfd52991c4b98a1847d329853d4c8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "57402346b3314e05bbeec3e508dc1534", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/0: 8.472856521606445
0/10: 0.3259585201740265
0/20: 0.15564392507076263
0/30: 0.11285214871168137
0/40: 0.09832911193370819
0/50: 0.09164901077747345
0/60: 0.08748806267976761
0/70: 0.08486773073673248
0/80: 0.0840553417801857
0/90: 0.07953515648841858
0/100: 0.07560604810714722
0/200: 0.05524487793445587
0/300: 0.04588102176785469
0/400: 0.040326450020074844
0/500: 0.037992388010025024
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5cad7d126b0148578400c7feff43c3f4", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/0: 0.036714326590299606
1/100: 0.033527374267578125
1/200: 0.03175676241517067
1/300: 0.029606865718960762
1/400: 0.027786705642938614
1/500: 0.02778378687798977
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "817a9f51747441459d177e835770954b", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/0: 0.026991648599505424
2/100: 0.025464870035648346
2/200: 0.024638455361127853
2/300: 0.023153522983193398
2/400: 0.021974408999085426
2/500: 0.02195832133293152
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_sae_batch</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "fc3853f00b5148e3a5e46a1c533492dd", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Truncation was not explicitly activated but `max_length` is provided a specific value, please use `truncation=True` to explicitly truncate examples to max length. Defaulting to &#39;longest_first&#39; truncation strategy. If you encode pairs of sequences (GLUE-style) with the tokenizer you can select this strategy more precisely by providing a specific strategy to `truncation`.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE of MLP activation reconstruction: 0.034565459936857224
Logit cross-entropy: -4.757816314697266
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_sae_single_input</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input text: Hello from the other side this is incredible
MSE of MLP activation reconstruction: 0.038368530571460724
Logit cross-entropy: -7.672155857086182
Input: Hello	Original top 5:[&#39;0&#39;, &#39; I&#39;, &#39; Thanks&#39;, &#39;1&#39;, &#39; Thank&#39;]	Reconstructed top 5:[&#39;Hello&#39;, &#39;Hi&#39;, &#39; Thank&#39;, &#39; I&#39;, &#39;0&#39;]
Input: Ġfrom	Original top 5:[&#39; my&#39;, &#39; I&#39;, &#39;0&#39;, &#39; Welcome&#39;, &#39; 2&#39;]	Reconstructed top 5:[&#39; my&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39;my&#39;, &#39;string&#39;]
Input: Ġthe	Original top 5:[&#39; same&#39;, &#39; I&#39;, &#39; website&#39;, &#39; Welcome&#39;, &#39; name&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; Hello&#39;, &#39;Hi&#39;, &#39; course&#39;]
Input: Ġother	Original top 5:[&#39; website&#39;, &#39;Hello&#39;, &#39; course&#39;, &#39; part&#39;, &#39; blog&#39;]	Reconstructed top 5:[&#39;Hello&#39;, &#39; I&#39;, &#39;Hi&#39;, &#39;I&#39;, &#39; Hello&#39;]
Input: Ġside	Original top 5:[&#39; of&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; and&#39;, &#39;0&#39;]	Reconstructed top 5:[&#39; I&#39;, &#39;Hello&#39;, &#39; of&#39;, &#39;Hi&#39;, &#39;I&#39;]
Input: Ġthis	Original top 5:[&#39;Hello&#39;, &#39; blog&#39;, &#39; is&#39;, &#39;Hi&#39;, &#39; I&#39;]	Reconstructed top 5:[&#39;Hello&#39;, &#39; I&#39;, &#39;Hi&#39;, &#39;?&#39;, &#39; is&#39;]
Input: Ġis	Original top 5:[&#39; my&#39;, &#39;Hello&#39;, &#39; work&#39;, &#39; the&#39;, &#39; a&#39;]	Reconstructed top 5:[&#39;Hello&#39;, &#39; my&#39;, &#39; the&#39;, &#39; working&#39;, &#39; a&#39;]
Input: Ġincredible	Original top 5:[&#39; and&#39;, &#39; work&#39;, &#39;Hello&#39;, &#39; I&#39;, &#39;,&#39;]	Reconstructed top 5:[&#39;Hello&#39;, &#39; I&#39;, &#39; work&#39;, &#39;,&#39;, &#39;?&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="n">max_ratios</span><span class="p">,</span> <span class="n">mean_ratios</span><span class="p">,</span> <span class="n">square_ratios</span> <span class="o">=</span> <span class="n">test_features_roundtrip</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">sae</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1d4aad89eccd4ea986d77b63e385f5c1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">max_ratios</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<hr class="docutils" />
<section id="messy-from-here-on">
<h2>Messy from here on<a class="headerlink" href="#messy-from-here-on" title="Link to this heading">#</a></h2>
<section id="hf-dataset">
<h3>HF dataset<a class="headerlink" href="#hf-dataset" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;JeanKaddour/minipile&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="s1">&#39;minipile&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f0ec4b44dc1d4f77920ca21f9d306113", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7e02358b1eec4a9186adf79f24ab1578", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8480f06e45dc45e1959259ceeda3a39c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">small_dataset_train</span>  <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span>
<span class="n">small_dataset_test</span>  <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error in callback &lt;bound method _WandbInit._resume_backend of &lt;wandb.sdk.wandb_init._WandbInit object at 0x49a8ea6d0&gt;&gt; (for pre_run_cell), with arguments args (&lt;ExecutionInfo object at 2b74d7cd0, raw_cell=&quot;small_dataset_train  = dataset[&#39;train&#39;].select(ran..&quot; store_history=True silent=False shell_futures=True cell_id=vscode-notebook-cell:/Users/dani/code/mech-interp-notebooks/03-sae/sae.ipynb#W3sZmlsZQ%3D%3D&gt;,),kwargs {}:
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="ne">TypeError</span>: _WandbInit._resume_backend() takes 1 positional argument but 2 were given
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error in callback &lt;bound method _WandbInit._pause_backend of &lt;wandb.sdk.wandb_init._WandbInit object at 0x49a8ea6d0&gt;&gt; (for post_run_cell), with arguments args (&lt;ExecutionResult object at 497bd6f10, execution_count=42 error_before_exec=None error_in_exec=None info=&lt;ExecutionInfo object at 2b74d7cd0, raw_cell=&quot;small_dataset_train  = dataset[&#39;train&#39;].select(ran..&quot; store_history=True silent=False shell_futures=True cell_id=vscode-notebook-cell:/Users/dani/code/mech-interp-notebooks/03-sae/sae.ipynb#W3sZmlsZQ%3D%3D&gt; result=None&gt;,),kwargs {}:
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="ne">TypeError</span>: _WandbInit._pause_backend() takes 1 positional argument but 2 were given
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">,</span> <span class="s2">&quot;mrpc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error in callback &lt;bound method _WandbInit._resume_backend of &lt;wandb.sdk.wandb_init._WandbInit object at 0x49a8ea6d0&gt;&gt; (for pre_run_cell), with arguments args (&lt;ExecutionInfo object at 49158b1d0, raw_cell=&quot;raw_datasets = load_dataset(&quot;glue&quot;, &quot;mrpc&quot;)&quot; store_history=True silent=False shell_futures=True cell_id=vscode-notebook-cell:/Users/dani/code/mech-interp-notebooks/03-sae/sae.ipynb#X23sZmlsZQ%3D%3D&gt;,),kwargs {}:
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="ne">TypeError</span>: _WandbInit._resume_backend() takes 1 positional argument but 2 were given
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c66da7e05e1a4a619a0cd8cf882a0184", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data: 100%|██████████| 649k/649k [00:00&lt;00:00, 1.29MB/s]
Downloading data: 100%|██████████| 75.7k/75.7k [00:00&lt;00:00, 549kB/s]
Downloading data: 100%|██████████| 308k/308k [00:00&lt;00:00, 3.64MB/s]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e07bfadb059a45a69bba0f77c38a7676", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1c78b2d93b1b42f3b22dff8fb58f8f6e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a755e11233ec44438bc5dd2b5978f5f6", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error in callback &lt;bound method _WandbInit._pause_backend of &lt;wandb.sdk.wandb_init._WandbInit object at 0x49a8ea6d0&gt;&gt; (for post_run_cell), with arguments args (&lt;ExecutionResult object at 49ac82e10, execution_count=30 error_before_exec=None error_in_exec=None info=&lt;ExecutionInfo object at 49158b1d0, raw_cell=&quot;raw_datasets = load_dataset(&quot;glue&quot;, &quot;mrpc&quot;)&quot; store_history=True silent=False shell_futures=True cell_id=vscode-notebook-cell:/Users/dani/code/mech-interp-notebooks/03-sae/sae.ipynb#X23sZmlsZQ%3D%3D&gt; result=None&gt;,),kwargs {}:
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="ne">TypeError</span>: _WandbInit._pause_backend() takes 1 positional argument but 2 were given
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([{&#39;text&#39;: &quot;Springfield seeks new fire levy\n\nWednesday\n\nOct 20, 2010 at 12:01 AM\n\nSPRINGFIELD — On Nov. 2, residents will choose whether or not to continue paying a little extra in property taxes to cover the cost of a 12-person fire engine crew.\n\nThe special levy renewal proposes reducing the amount property owners are currently paying by 4 cents per $1,000 of assessed value, thanks to an increase in property values and new construction in the city during the past four years.\n\nVoters first approved the fire levy in 2002. The levy has paid for adding a fifth fire engine crew of 12 firefighter-paramedics to the city’s ranks to fill a gap created in 1997 when the city added a fifth fire station in the Gateway area.\n\nThe new fire station was completed at about the time that statewide property tax-limiting measures cut the city’s general fund income by $1.6 million.\n\nAt first, firefighters tried to make do, moving an engine crew from the fire station at 28th Street and Centennial to Gateway and leaving just an ambulance crew at the more central station, city finance director Bob Duey said.\n\nBut the result was that emergency crew response times increased all across Springfield, so city councilors asked voters to support a special tax levy to fully staff the stations.\n\nVoters approved a four-year levy of 36 cents per $1,000 of assessed value, and renewed it in 2006 at 40 cents per $1,000. It will expire in June 2011, if it’s not renewed.\n\nSpringfield also pays for a portion of police department and municipal jail costs through a separate special levy.\n\nWith the fully staffed fire stations, response times have improved, city officials say. City records from 2007 through 2009 show that emergency crews arrive in five minutes or less 72 percent of the time.\n\nIn emergencies, timing is everything, said Mark Walker, deputy chief of EMS and community relations for the Springfield and Eugene fire departments.\n\nFor those experiencing heart attacks, the survival rate decreases 10 percent per minute until the patient receives CPR or advanced cardiac life support, Walker said.\n\nOnce a fire establishes itself and is in a free-burning phase, it doubles in size every minute, he said.\n\n“A one-minute delay might mean the difference between one room and two rooms being involved,” he said.\n\nCity Councilors voted in July to reduce the proposed levy rate to 36 cents, a move that’s possible because of recent growth both in homes and businesses in the city and an increase in assessed property values, Duey said.\n\nSpringfield property values increased 9 percent in 2008, 1.9 percent in 2009 and 6.4 percent in 2010, Duey said. He predicts 3 percent annual increases for the next five years.\n\nThe City Council doesn’t have a backup plan if voters fail to approve the levy, Duey said.\n\n“They don’t have an official position on that yet. ... Voters have been supportive twice in the past and we’re hoping they will be again,” he said.\n\nNever miss a story\n\nChoose the plan that&#39;s right for you.\nDigital access or digital and print delivery.\n\nOriginal content available for non-commercial use under a Creative Commons license, except where noted.\nThe Register-Guard ~ 3500 Chad Drive, Suite 600, Eugene, OR 97408 ~ Privacy Policy ~ Terms Of Service&quot;},
       {&#39;text&#39;: &quot;Is there an association between nosocomial infection rates and bacterial cross transmissions?\nSurveillance data of nosocomial infection rates are increasingly used for public reporting and interhospital comparisons. Approximately 15% of nosocomial infections on intensive care units are the result of patient-to-patient transmissions of the causative organisms. These exogenous infections could be prevented by adherence to basic infection control measures. The association between bacterial cross transmissions and nosocomial infection rates was analyzed. Prospective cohort study during 24 months. Eleven intensive care units from two university hospitals. All inpatients. None. Primary isolates of six indicator organisms (Acinetobacter baumannii, Enterococcus faecalis and E. faecium, Klebsiella pneumoniae, Pseudomonas aeruginosa, Staphylococcus aureus) cultured from clinical samples or methicillin-resistant S. aureus surveillance testing of all inpatients were genotyped. Indistinguishable isolates in &gt; or =2 patients defined potential episodes of transmissions. Surveillance of nosocomial infection rates was performed according to the German nosocomial infection surveillance system, Krankenhaus Infektions Surveillance System. Transmission events and nosocomial infection rates were pooled by intensive care unit to calculate Spearman&#39;s rank-correlation test. During 100,781 patient days, 100,829 microbiological specimens from 24,362 patients were sampled (average investigation density: 1.0 sample per patient and day) and 3419 primary indicator organisms were cultured. Altogether, 462 transmissions (incidence density of 4.6 transmissions per 1000 patient days; range, 1.4-8.4 days) and 1216 nosocomial infections (incidence density of 12.1 per 1000 patient days; range, 6.2-16.6 days) were discerned. Correlation analysis was unable to reveal any association between the incidence of cross transmissions and nosocomial infections, duration of hospitalization, or device use. Differences in nosocomial infection rates between study intensive care units are not explained solely by cross transmissions. Other factors, like the severity of the patient&#39;s underlying diseases, the patient&#39;s endogenous flora, or invasive procedures, likely have a dominant effect on the magnitude of nosocomial infection rates.&quot;},
       {&#39;text&#39;: &quot;This You Tube video made me smile as it has clips from so many great adaptations. This works on so many levels. The fact that this song was in the first Bridget Jones film (you know, the part where Hugh Grant and Colin Firth are having the most ridiculous fight over Bridget-grabbing clothes and kicking etc) makes you instantly bop your head and think of a couple of British cuties right off the bat. That and the wonderful editing of many of my favorite swoon worthy scenes really keeps me coming back to play this one again and again.\n\nHow many men did you recognize in this montage? I will start you out with JJ Field as Henry Tilney in Northanger Abbey. So cute with that little smirk.\n\nNext, in quick succession we have my personal fave right now, Richard Armitage as Mr. Thornton in North &amp; South.\n\nAnd then we have Anthony Howell as Roger Hamley in Wives and Daughters(oh, teach me some Biology, Roger).\n\nWe then have a peek at Rupert Penry-Jones as Captain Wentworth in the new Persuasion (I am half agony, half hope), and then I have to stick my neck out here and guess, JJ Field again in The Shadow in the North? Apparently, I have some shopping to do on Amazon! I love JJ, as does the creator of this video apparently.\n\nIf I only mention new faces at this point, we move on to the iconic Colin Firth as Mr. Darcy from Pride and Prejudice 1996 who we have in most of his best looks and ending in the tub with him (although no wet shirt scene?!?!)\n\nWe move on to Mr. Willoughby from Sense and Sensibility 1996 (otherwise known as Greg Wise/Mr. Emma Thompson).\n\nAnd then on to the new Colonel Brandon, David Morrisey from Sense and Sensibility2008 , very hot and understated.\n\nWe then of course have to give a nod to the original Colonel Brandon, the silky voiced Alan Rickman from the classicSense and Sensibility 1996.\n\nAnd then we have Mr. Willoughby from the latest Sense and Sensibility2008, Domenic Cooper, who just about loses his head in this video (perfectly timed with the lyrics).\n\nIf I have missed any cuties from this absolutely addictive You Tube video, please leave a comment. I think I missed David Tennant from the TV miniseries Cassanova, but this is not the Heath Ledger version of Cassanova also from 2005. This is another one I have to order, as I only know David Tennant from Doctor Who.\n\nFeel free to comment on what you love about this video, or what you would have added. I think this was done a few years ago, so there have been many great period dramas released since then. Have fun with this one and please share it with whoever you think it would bring a smile to.\nThank-you to the creator of this You Tube video, DreamyViper (aka Jiab). She has lots more stuff so check out her other videos via this link.\n\nTuesday, May 18, 2010\n\nI have been to Bath, the gorgeous city in England, twice in my lifetime. The first time was with my husband before we had kids. I had begged him to take me to England as I was pregnant with my first child and wanted to do something exciting before I got tied down with a baby. Good plan. Unfortunately, we were a bit naive in the trip planning department and only booked 8 days in London through a travel agent.\n\nFortunately, the agent booked us into a hotel on Curzon Street in Mayfair, London. Oh, had I only known at that time the literary history of that address. I now know that Curzon Street is where the social climber Becky Sharpe from Thackery’s novel Vanity Fair went to live after her marriage to the dashing Rawdon Crawley. That tony address where they could not afford the rent, but where Becky wanted to live and be seen giving all of her fabulous parties. It was also the address of Lord Henry Wotton of The Picture of Dorion Gray and the address of Jeeves&#39; club The Junior Ganymede Club for gentleman’s gentleman (valets). After my husband (the Squire) and I stumbled into a cab after the red-eye flight from Toronto and were taken to our lovely (and amazingly affordable) hotel on fairly swanky Curzon Street, we had no real idea where we were. After a well needed nap, we stumbled out on the street again, looking for a place to have supper. Thinking we should walk around first, we walked for about ten minutes through a beautiful park (Green Park) and then looked up to find (holy crap!), Buckingham Palace. Good travel agent.\n\nAnyhow, we ended up on the next day doing what most travelers do in a strange city, and that was to book a few bus tours. OK, that is what clueless travelers in 1991 did in a strange city. These are the kind of crazy tours where they take you to as many places possible in one day. One of these took us from London to Oxford, Stratford and Warwick Castle all in one day, and on another day we did Bath, Stonehenge and Salisbury Cathedral. Whew! At that point in my life, Bath was only a beautiful city with graceful Georgian architecture and a well preserved Roman bath. But even then, I felt ripped off with the mere 2 hours before we were piled back on the bus.\n\nMy second visit to Bath was much more satisfactory. This was in 2005 with my husband and 2 boys (then 13 and 10). We had all chosen something special to do on this trip (planned entirely by me this time) and my choice was to have 2 days in Bath. This was after I had spent the previous decade reading 19th century literature and watching many adaptations of said novels on screen. So Bath was a different and more familiar place to me. It was where Anne Elliot finally hooked up with Captain Wentworth. It was where Catherine Morland got her first taste of the delights and disappointments of society. And it was where Jane Austen spent many unhappy years not writing, but storing up many studies of various characters for future reference.\n\nSo, of course, I dragged my family around the Royal Crescent, through Royal Victoria Park, around the Roman Baths (well worth seeing a second time) and into the Abbey. We walked back to our hotel via Pulteney bridge, after tasting the disgusting sulfurous water at the Pump Room. Basically, I wore the poor things out. So after dropping the 3 of them back at the hotel for a late afternoon rest, I went back out alone, determined to squeeze the most enjoyment out of my time in Bath. I trotted off to the Jane Austen Centre at 40 Gay St. to immerse myself in all things Austen. I started to really regret not having my sister with me, when I saw a poor young dude dressed like Mr. Darcy outside the museum, meant to pull the lady tourists in. She and I would have laughed our posteriors off at that, but I only managed a smirk before I ducked into the building. (Apparently there is now a mannequin dressed as Miss Austen out front.)\n\nAfter soaking up as much as I could there, I headed off to the Assembly Rooms. Not much time left, as the sun was getting low in the sky, but I had to see them. I had to picture the crush of beautifully dressed dancers described in Northanger Abbey. I had to imagine the parading of characters around the ballroom and the tea room. Then down in the basement I went for a look around the Museum of Costume. At this point, I was half in heaven (as they had real Georgian gowns as well as costumes from various Austen films on display) and half in hell (as I was inwardly screaming for my sister to be at my side). In any case, after pressing my nose to the glass to study the antique gowns and then getting as close as I could to Jennifer Ehle’s red dress from Pride and Prejudice without drooling on it:\n\n(yes, the one in which she teases, “A man without fault?”), I made my way slowly back to the hotel for dinner in a pub with the guys. I think it was the Thursday night curry special at the local pub, which was delish, and I was full of the wonders of Bath for a few years more, at least.\n\nMoral of the story? I have now realized that if and when I return to the wondrous curved city, I will have my sister with me. And no men. My men are very relieved to hear this, as apparently I am a one woman bus tour!\n\nI think that one of the greatest things about these adaptations is that they make the novels so much more accessible. I just finished reading Mrs. Gaskell’s North and South for about the third time and was in tears again on the last few pages. Not only do I know that I wouldn’t have read this novel but for the adaptation, I also know that I enjoy it more because of the adaptation. It is as if I need a bridge to the “other world” of the 19th century and the adaptation gives me that. I am not an English scholar so I need a bit of a leg up, to picture the world and the relationships in my mind before I tackle the book. I usually then actually enjoy the book better than the film, although there are usually ways in which the films are as good if not superior to the original novel.In the case of North and South, which is quickly becoming my favourite novel/adaptation combo, the final scene with Margaret and Mr. Thornton is done equally well in novel and adaptation, even if the kissing at the train station is a bit unrealistic for mid-Victorian times. It is delicious to those of us watching in the 21st century so we can suspend our disbelief that Margaret would have been so indiscreet. But the much more discreet scene in the book makes me cry even more than the one in the film.\n\nIn any case, I think we can all agree that the readership of these old novels has surged in recent years because of all these lovely adaptations and the fact that some of us want the feeling we get from the films to continue, so we read the books. And we are rarely disappointed. So thank-you to the BBC and all the other filmmakers and screenplay writers for lighting a fire under those of us less likely to pick up a Classic novel without a little nudge.\n\nMy sister came up with a theory a few years ago which sounded very credible at the time. Apparently, there are only really 30 British actors and they rotate them through the roles as they are needed. OK, there are a few more than 30 but sometimes it seems really plausible. I mean Judi Dench, Helen Mirren and Hugh Grant alone can account for an alarming number of roles. My sister took this one step further and made up the game two degrees of Judi Dench.\n\nKind of like 6 degrees of Kevin Bacon, but if you use British actors, you can connect Judi in two degrees. Try it. It is scary. Ok, here goes. I picked a name that I thought hadn’t worked with Judi-Emma Thompson. Nope, one degree here. They did Kenneth Branaugh’s Henry V together in 1989. I will use Blake Ritson, Mr. Elton in the new Emma. He has worked with Michael Gambon in Emma who worked with Judi Dench in Cranford. Yowza!\n\nSo you see, if you watch enough BBC and British films, you will see the reuse of actors and you will have to try to forget that Hugh Bonneville was the scary Mr. Grandcourt in Daniel Deronda if he is to be believable as sweet but neglectful Mr. Bennet in Lost in Austen or dopey Mr. Rushworth in Mansfield Park 1999.\n\nSo they really have to be good actors if you have seen them many times before in other roles. Thankfully, most of them really are good actors and they make us forget and they make us believe.&quot;},
       {&#39;text&#39;: &quot;In the Supreme Court of Georgia\n\n\n                                           Decided: November 16, 2015\n\n\n                     S15A1334. DODSON v. DODSON.\n\n\n      MELTON, Justice.\n\n      We granted an application for interlocutory appeal to determine whether\n\nthe trial court erred when it denied enforcement of a prenuptial agreement\n\nbetween Ricky Dodson (Husband) and Kelly Dodson (Wife) on the basis that\n\nHusband failed to establish that he made a full and fair disclosure of his\n\nfinancial condition. For the reasons set forth below, we affirm.\n\n      In relevant part, the record shows that the parties are pursuing a divorce,\n\nand Wife filed a motion to deny enforcement of a prenuptial agreement entered\n\ninto by the parties. After a hearing, the trial court analyzed the prenuptial\n\nagreement under the standard set forth in Scherer v. Scherer, 249 Ga. 635 (292\n\nSE2d 662) (1982), and found it to be unenforceable. Scherer holds that\n\n      the trial judge should employ basically three criteria in determining\n      whether to enforce such an agreement in a particular case: (1) was\n      the agreement obtained through fraud, duress or mistake, or through\n      misrepresentation or nondisclosure of material facts? (2) Is the\n      agreement unconscionable? (3) Have the facts and circumstances\n      changed since the agreement was executed, so as to make its\n      enforcement unfair and unreasonable?\n\x0c(Citation omitted.) Id. at 641 (3). “Whether an agreement is enforceable in light\n\nof these criteria is a decision made in the trial court&#39;s sound discretion. [Cit.]”\n\nAlexander v. Alexander, 279 Ga. 116, 117 (610 SE2d 48) (2005). “Under this\n\nstandard, we review the trial court&#39;s legal holdings de novo, and we uphold the\n\ntrial court&#39;s factual findings as long as they are not clearly erroneous, which\n\nmeans there is some evidence in the record to support them.” (Citations\n\nomitted.) Lawrence v. Lawrence, 286 Ga. 309, 310 (1) (687 SE2d 421) (2009).\n\n“[T]he trial court essentially sits in equity and has discretion to ‘approve the\n\nagreement in whole or in part, or refuse to approve it as a whole.’ [Cit.]”\n\nAlexander, supra, 279 Ga. at 117-118.\n\n      Although the trial court found that the prenuptial agreement satisfied all\n\nother parts of the Scherer test,1 it found that the agreement was unenforceable\n\ndue to the nondisclosure of material facts. In doing so, the trial court pointed to\n\na number of factors. First, the trial court noted that, although the prenuptial\n\nagreement lists all of Husband’s assets, it contains no values for these assets–\n\nincluding the value of Husband’s bank accounts and two closely-held businesses\n\nowned by him. At the hearing on Wife’s motion to deny enforcement, the trial\n\n      1\n          Wife did not contest these findings.\n                                         2\n\x0ccourt was presented with evidence regarding the nature and value of these\n\nassets, and the trial court made the determination that these values were material\n\nfacts that were necessary for a full and fair disclosure. See Lawrence, supra, 286\n\nGa. at 313 (4) (One of the requirements that a party seeking enforcement of a\n\nprenuptial ageement must meet in order “[t]o satisfy the first prong of the\n\nScherer test, . . . [is to] show . . . that there was ‘a full and fair disclosure of the\n\nassets of the parties prior to the execution of the antenuptial agreement’”)\n\n(citation and punctuation omitted). Second, the trial court determined that\n\nHusband did not allow Wife reasonable access to his bank accounts in order to\n\nascertain their value. Specifically, the trial court pointed to evidence that, though\n\nWife volunteered to assist Husband with accounting work related to his\n\nbusinesses, Husband declined Wife’s help and failed to disclose the values of\n\nthe business accounts to Wife. Finally, the trial court found that Wife simply did\n\nnot have information about or access to Husband’s business accounts at any\n\ntime and that “there was no evidence presented . . . that [Wife] could know the\n\nvalue of [Husband’s] accounts.” (Emphasis supplied.)2 Based on these findings,\n\n      2\n       This fact distinguishes the present case from Spurlin v. Spurlin, 289 Ga.\n818 (716 SE2d 209) (2011), in which a postnuptial agreement was enforced\nwhere the evidence showed that the wife had unrestricted access to the financial\nrecords of her husband. For similar reasons, it is also distinguishable from\n                                           3\n\x0cit cannot be said that the trial court abused its discretion in ruling that the\n\nprenuptial agreement at issue was unenforceable.\n\n      Nonetheless, pursuant to Mallen v. Mallen, 280 Ga. 43 (622 SE2d 812)\n\n(2005), Husband argues that the prenuptial agreement is enforceable because\n\nWife had a duty to inquire and investigate with regard to the value of all of his\n\nassets, including the bank accounts. This is erroneous as both a matter of fact\n\nand law. Factually, the trial court found that Husband did not give Wife\n\nreasonable access to his bank accounts, and there are facts of record supporting\n\nthis conclusion. Legally, we made clear in Blige v. Blige, 283 Ga. 65 (2) (656\n\nSE2d 822) (2008), that, in order to enforce a prenuptial agreement, the spouse\n\nseeking enforcement must show that the agreement contained full and fair\n\ndisclosure of his or her material assets. We further clarified that, in the absence\n\nof a full and fair disclosure, the other spouse does not have a general duty to\n\ninvestigate the assets of the other party. Id.\n\n      Husband also maintains that the law required only that he list all of his\n\nmaterial assets, not that he apprise Wife as to their values. This is an incorrect\n\n\n\nLawrence v. Lawrence, supra, because in that case the wife had garnered years\nof familiarity with her husband’s financial dealings prior to entering into a\nprenuptial agreement.\n                                         4\n\x0cand overly narrow interpretation of the law.3 What is absolutely required by\n\nScherer is a “full and fair disclosure.” See Lawrence, supra. As found by the\n\ntrial court in this case, the disclosure was neither full, because Wife had no real\n\nknowledge of the value of Husband’s bank accounts, nor fair, because Husband\n\nnever allowed Wife to have reasonable access to those accounts. As such,\n\n      [t]he evidence supports the trial court&#39;s finding that [Husband]\n      failed to make a full and fair disclosure of his assets, income, and\n      liabilities to [Wife] prior to the execution of the antenuptial\n      agreement, and nothing in Mallen or [Wife’s] actions or inactions\n      prior to the execution of the antenuptial agreement excuses\n      [Husband’s] nondisclosure.\n\nBlige, supra, 283 Ga. at 71-72 (2). Therefore, the trial court did not abuse its\n\ndiscretion by determining that the prenuptial agreement failed the first prong of\n\nthe Scherer test.\n\n      Judgment affirmed. All the Justices concur, except Blackwell, J., who\n\nconcurs in judgment only.\n\n\n\n\n      3\n        We again note that “attaching to the antenuptial agreement financial\nstatements showing both parties&#39; assets, liabilities, and income, while not\nnecessary, ‘is the most effective method of satisfying the statutory [disclosure]\nobligation in most circumstances,’” Lawrence, supra, 286 Ga. at 313 (4), citing\nBlige, supra, 283 Ga. at 69 n. 12.\n                                        5\n\x0c&quot;},
       {&#39;text&#39;: &quot;Infliximab and pediatric stricturing Crohn&#39;s disease: a possible alternative to surgery? Experience of seven cases.\nInfliximab (IFX) is one of the treatments of choice for the different phenotypes of pediatric Crohn&#39;s disease (CD). Although it was initially feared that anti-TNFα treatment might cause bowel stenosis, recent studies have validated the efficacy of IFX as an anti-stricturing agent. To assess the efficacy of IFX treatment for pediatric stricturing CD. Data were obtained on pediatric patients treated at our tertiary level Pediatrics Department (years 2000-2010). Indications for IFX therapy included persistent disease activity (PCDAI &gt; 20) unresponsive to corticosteroids and thiopurines. All patients treated with IFX underwent upper and lower intestinal endoscopy, abdominal ultrasound and magnetic resonance enterography. Among 44 pediatric CD patients, 21 were treated with IFX. Seven of these cases had luminal strictures and in 6 patients the inflammatory strictures disappeared after treatment with IFX. One child with ileal fibrotic stenosis (MR) required a surgical resection. Our data support the efficacy of IFX in pediatric CD, including the stricturing phenotype.&quot;},
       {&#39;text&#39;: &#39;Do future general surgery residents have adequate exposure to endocrine surgery during medical school?\nDuring their general surgical rotations, medical students should ideally have exposure to a wide breadth of surgical procedures, especially if they are interested in pursuing surgical careers. To determine their exposure to endocrine surgery during medical school, we surveyed students from more than 20 medical schools who interviewed for general surgery residency positions at our institution over a 2-year period. Questions focused on the total number of index surgical procedures observed during all of their medical school education. Of 211 surveys sent, 146 were returned (66%). The mean age of the students was 26.0 +/- 0.3 years, and 21% were women. The average times spent on general surgery and surgery subspecialty rotations during medical school were 11.1 +/- 0.6 weeks and 7.6 +/- 0.4 weeks, respectively. The mean number of thyroidectomies (2.8 +/- 0.3), parathyroidectomies (1.9 +/- 0.3), and adrenalectomies (0.5 +/- 0.1) observed by the medical students were significantly lower than operations such as mastectomies (9.4 +/- 0.3), coronary bypass surgeries (8.7 +/- 1.4), and laparoscopic cholecystectomies (10.0 +/- 0.7). Furthermore, of these 146 future surgical residents, 34% failed to observe a single thyroid resection, 42% did not see a parathyroidectomy, and 65% failed to see an adrenalectomy. In conclusion, future general surgery residents seem to observe a wide variety of surgical cases, but most have little or no exposure to endocrine surgery. This paucity of exposure may have significant educational and career ramifications.&#39;},
       {&#39;text&#39;: &#39;Cyberattack on the Department of Health and Human Services\n\nCybercriminals are targeting the U.S. Department of Health and Human Services (HHS) in an attempt to overload its website with hundreds of thousands of hits. As per the statement of HHS spokesperson, Caitlin B. Oakley, the HHS discovered more activity on the HHS cyberinfrastructure, which seems to be a Distributed Denial of Service (DDoS) attack attempt.\n\nThe people behind the attack did not succeed due to extra protections set up to abate DDoS attacks, which was part of the preparation of HHS and reaction to the COVID-19 pandemic. HHS has got an IT infrastructure having risk-based security controls. It has continuous tracking to identify and street deal with cybersecurity risks and vulnerabilities.\n\nThere was no data breach encountered and the function of HHS and federal networks are still normal. Federal cybersecurity experts are continually monitoring HHS computer networks and are ready to undertake suitable measures to safeguard those networks and minimize attacks if they happen. The federal government is looking into the attack to find out who was behind it.\n\nHHS Secretary, Alex Azar said that the HHS has set up very strong barriers so their networks were not penetrated or had degraded functions. There is no restriction on the capability or potential of the people to telework.\n\nThe White House National Security Council (NSC) tweeted recently that the information campaign suggesting that President Trump is going to order a national quarantine that will put the country on lockdown, just like in Italy and Spain is fake. It is uncertain if the text message campaign is related to the attempted DDoS attack.\n\nThere are furthermore a number of phishing campaigns that use fear of the SARS-CoV-2 and COVID-19 to propagate malware and steal sensitive data. The malicious email campaigns will most likely increase with the developing pandemic. If you get an email message associated with SARS-Cov-2 and COVID-19, confirm if the message is genuine prior to taking action.\n\nFor updated details and facts on SARS-Cov-2 and COVID-19, go to the Centers for Disease Control and Prevention (CDC) website.\n\nRansomware Attack on Illinois Public Health Network\n\nLast week, there was a cyberattack on the Champaign-Urbana Public Health District in Illinois, which allowed cybercriminals to deploy the Netwalker (MailTo) ransomware. The attack deactivated the public health district’s site on March 10, 2020. After a couple of hours, the investigators of the incident confirmed the ransomware attack.\n\nEven during the website outage, employees were able to access critical systems. There was no compromise of electronic medical records or other sensitive information. Six months ago, the medical records were moved to the cloud. The Champaign-Urbana Public Health District was retrieved.&#39;},
       {&#39;text&#39;: &#39;By Nico Zulli and Katdie Norton\n\nReporters\n\nInformation on class schedules, shuttle buses and grades is now available to Baylor students on the move.\n\nOsoMobile, a new mobile application from Baylor ITS, offers a way to access BearWeb and information from other existing apps.\n\n“I think it is the first true mobile app that brings in some of the data from BearWeb,” said Steven Kucera, director of information systems and services and the team supervisor for OsoMobile’s development. “It brings together many features for Baylor students.”\n\nThe app features a current course schedule, all past semesters’ final grades, current holds, student and faculty directory, a Baylor bus tracker that links to an existing bus tracking app called Ride Systems, a campus map that uses current location and a Baylor Lariat news feed. The app also includes the emergency numbers of campus police, the counseling center, health center and the help desk at Baylor.\n\nThe app functions by hooking into maps, news feeds and banner data, which is data from BearWeb, while keeping student information secure. Similar to Bearweb, users will be logged out after 15 minutes of inactivity.\n\n“OsoMobile interfaces with our student information systems in a way that keeps our academic records secure,” said Pattie Orr, vice president for information technology and dean of university libraries. “As vice president for information technology, I am concerned about keeping our data secure. OsoMobile provides a great combination of convenience and security.”\n\nThe app’s development process began in April of last year, pilot testing of the app began in October, almost two months prior to the actual release.\n\n“Anything we do in this department goes through extensive testing,” Kucera said. “During testing we discovered that it was slow and we did a lot of tweaking to make it faster.”\n\nITS collaborated with Ellucian, a technology solutions company, to develop the app.\n\n“We worked with a vendor to create an app that provides a framework, rather than trying to write an app ourselves,” said Becky King, associate vice president for information technology.\n\nKing also said the process of adding new features to the app starts with what Ellucian can deliver.\n\n“We then take collaboration and feedback from students into consideration, we prioritize and then implement,” she said.\n\nKing and Kucera said ITS is working with Baylor student government to channel student feedback appropriately.\n\n“We own the code and can make changes,” Kucera said. “But, we have to work with the vendor to see if it’s possible or feasible.”\n\nAt this point, no. 1 on the list of potential new features to OsoMobile is an integration with the Baylor ID card system. This would include the ability to check and update Bear Bucks, report stolen or lost ID cards, and perhaps even unlocking dorm room doors.\n\nKucera said the app could possibly be linked or have different funtionalities, but those additions have to go through a security officer to determine if there would be any threat or harm to information by including them in the app.\n\nITS is working on making the app as seamless as possible for the more than 350 active users who have downloaded the app so far.\n\n“We have had, and continue to have, pilot students test this new app to provide us with their feedback,” King said. “We want to continue to develop the app and we will take into account the feedback that we get.”\n\nKucera said the app is a product that will continue to grow. He said class registration is also a possibility for the app.\n\n“Registration is the queue from Ellucian,” he said. “But, that is down the road and has to be tested first to make sure it can handle the loads.”\n\nWhile the app has been designed with students in mind, ITS would ultimately like to address faculty and staff functionality as well.\n\n“I hope Baylor students, faculty and staff find that this new tool will help foster academic success,” Orr said.&#39;},
       {&#39;text&#39;: &#39;Kimberly Arigot Arrested for Sex with Teen Boys\n\nKimberly Arigot mugshot\n\n, 40, was arrested in Syracuse for having sex with three teenage boys, ages 15 to 17.\n\nArigot used her cell phone to send inappropriate text messages and nude photos to the boys, leading to two of the teens having sex with the her in multiple places, including her home. Investigators believe those relationships had been going on for a good part of the year.\n\nArigot, mother of a high school student, faces felony charges for unlawful sex and unlawful contact with minors, as well as providing alcohol to underage students.\n\nShe was released from jail after posting bail.\n\nView video below.\n\n\n\nVideo Courtesy of KSL.com&#39;},
       {&#39;text&#39;: &quot;Pages\n\n05 December 2011\n\nSort of missing my baking and decorating times when I don&#39;t have to. It&#39;s the other way around though when I have to . I wish I could sit down and blog for all my oustanding cakes and cupcakes.\n\nJosephine&#39;s 21st birthday cake, a 2-tiered bird cage themed cake in pink and white was another favourite cake of mine. Sally, Josephine&#39;s mom didn&#39;t forget me when it came to her daughter&#39;s special day of her life time -- 21st birthday. She had given her daughter a very precious memory by doing her a sweet and lovely birthday party.\n\nJosephine with family. There are also 21 pieces of special cupcakes plus 80 pieces of simple cupcakes prepared. All in pink and white in line with the party theme colours. Oh ya, the decoration was done by Creative Tropicana Sdn. Bhd. and pictures at the party were courtesy of the company.\n\nI managed to capture pictures of the cake at home. Love the white bird and buttrflies. They look so pure. Pink is the favourite colour of Josephine.&quot;},
       {&#39;text&#39;: &#39;\n748 F.Supp. 208 (1990)\nPARK SOUTH TENANTS CORPORATION, Plaintiff,\nv.\n200 CENTRAL PARK SOUTH ASSOCIATES, L.P., Bernard Spitzer, Jack Lipman and Melvin D. Lipman, Defendants.\nNo. 89 Civ. 8251 (WCC).\nUnited States District Court, S.D. New York.\nOctober 12, 1990.\nAs Amended October 17, 1990.\n*209 Teitelbaum, Hiller, Rodman, Paden &amp; Hibsher, P.C., New York City (Robert Hermann, of counsel), for plaintiff.\nLowenthal, Landau, Fischer &amp; Ziegler, P.C., New York City (Robert D. Levin, Annette Ferstenberg, Jonathan Honig, of counsel), for defendant.\n\nOPINION AND ORDER\nWILLIAM C. CONNER, District Judge.\nPlaintiff Park South Tenants Corporation brings this claim for damages, pursuant to Section 3607 of the Condominium and Cooperative Protection and Abuse Relief Act of 1980 (the &quot;Act&quot;), 15 U.S.C. § 3601 et seq, against defendants 200 Central Park South Associates (the &quot;Sponsor&quot;) and Bernard Spitzer, Jack Lipman and Melvin D. Lipman, as individuals and as directors of plaintiff (collectively, the &quot;Directors&quot;). Plaintiff further bases its claim for damages on defendants\&#39; alleged breach of their fiduciary duty to plaintiff. This action is presently before the Court on defendants\&#39; motion for summary judgment pursuant to Fed.R.Civ.P. 56(c) and for plaintiff\&#39;s cross-motion for partial summary judgment pursuant to Fed.R.Civ.P. 56(c).\n\nBackground\nOn January 16, 1984, the apartment building at 200 Central Park South was converted from a rental to a cooperative. Defendant 200 Central Park South Associates, a limited partnership whose general partners are Bernard Spitzer, Ann Spitzer, Jack Lipman and Melvin D. Lipman, offered for sale the shares appurtenant to 309 residential units. According to the terms of the offering plan (the &quot;Plan&quot;) dated May 2, 1983, which set out the details of the proposed transaction, defendant Sponsor offered for sale 310,118 of the 325,000 authorized shares of the cooperative. Complaint ¶ 5. A copy of the Plan was made available as part of the prospectus package provided each potential buyer by defendant Sponsor. The Plan was declared effective on January 16, 1984 with the sale of approximately 17 percent of the apartment units in the building at closing.\nOne of the provisions of the Plan was a leasing arrangement whereby defendant Sponsor entered into a master commercial lease (hereinafter the &quot;Lease&quot;) with plaintiff covering the indoor parking garage in the apartment building, two retail stores and nineteen professional offices at 200 Central Park South. Complaint, ¶ 7. The lease, as amended, is to run for fifty years from the closing, in ten five-year terms, unless terminated sooner by defendant Sponsor. It prescribes a single unapportioned rent of $400,000 per year for the first five-year term for all of the leased commercial space, increasing each term thereafter by 12 percent of any increase in operating expenses over plaintiff\&#39;s actual operating expenses for the first year of the preceding five-year term.\nAlong with plaintiff\&#39;s by-laws, section O of the Plan stipulates that there be no less than three nor more than seven directors. The Plan further provides that principals of defendant Sponsor or their designees who are in possession of shares in the cooperative that were transferred and not sold to them by defendant Sponsor (&quot;Holders of Unsold Shares&quot;) may not elect a majority of the members of the Board of Directors, after (a) fifty percent of the outstanding shares in the cooperative have been sold to persons other than such principals or designees of defendant Sponsor, or (b) five years from the closing date, whichever should occur first. Similarly, plaintiff\&#39;s governing documents reserve for defendant Sponsor the right to veto certain prescribed actions of plaintiff as long as any Holders of Unsold Shares, including defendant Sponsor, constitute at least 25 percent of the then-outstanding capital stock of the cooperative, for a period of up to five years after closing. Plaintiff, acting by the Board of Directors or otherwise and subject to the veto provisions, cannot, without the consent of the Holders of Unsold Shares, &quot;[e]nter into any new mortgage or contracts *210 of sale or lease of the land or the building, other than as set forth in the Plan.&quot; (By-laws, Art. XII, section 2(ii)).\nAt the first meeting of plaintiff\&#39;s shareholders, defendant Sponsor, along with defendant Directors, owned a substantial majority of plaintiff\&#39;s shares and was therefore able to exercise its voting block and elect a majority of plaintiff\&#39;s five directors. This situation continued until May 8, 1989 whereupon an unaffiliated Board of Directors was elected by the shareholders. Complaint ¶ 14. Defendant Sponsor was required to relinquish and thereafter did relinquish control of the board of Directors soon after January 16, 1989 \x97 five years from the date of the closing as required by the cooperative\&#39;s governing documents. On or about December 12, 1989, defendant Sponsor was notified by plaintiff that, pursuant to a vote of the shareholders representing 105 of the 120 apartment units and 107,331 of the 123,820 shares entitled to vote at a special meeting held on December 5, 1989, plaintiff elected to terminate that portion of the lease pertaining to the garage, effective ninety days from the date of the notice.[1] Complaint, ¶ 19. Defendant Sponsor relinquished control of the garage as of the end of March, 1990 without protest. Since April 1, 1990, a new garage operator has been managing the premises under an agreement cancellable on thirty days notice.\nPlaintiff commenced this action simultaneously with the delivery of the notice of termination on December 12, 1989 and alleges that defendant Sponsor, along with defendant Directors, interfered with plaintiff\&#39;s rights under 15 U.S.C. § 3607 from the inception of the Lease. Plaintiff further claims that while the Plan, which was accepted for filing by the New York State Department of Law, disclosed the basic terms of the lease, it failed to make reference to the provisions of the Act which concededly permit the termination of the lease by plaintiff and did not refer in any way to the possibility of such a termination by plaintiff or the consequences thereof. Plaintiff seeks relief in the form of damages from the defendants in an amount equal to the profits realized by defendant Sponsor through the operation of the garage from the closing [January 16, 1984] up to and including the effective date of the termination of the Garage portion of the Lease [March 13, 1990].\n\nDiscussion\n\nStandard for Summary Judgment\nA party seeking summary judgment must demonstrate that &quot;there is no genuine issue as to any material fact.&quot; Fed.R. Civ.P. 56(c); Knight v. U.S. Fire Insurance Company, 804 F.2d 9, 11 (2d Cir. 1986), cert. denied, 480 U.S. 932, 107 S.Ct. 1570, 94 L.Ed.2d 762 (1987). &quot;When the moving party has carried its burden under Rule 56(c), its opponent must do more than simply show that there is some metaphysical doubt as to the material facts.&quot; Matsushita Electrical Industrial Co. v. Zenith Radio Corp., 475 U.S. 574, 586, 106 S.Ct. 1348, 1355, 89 L.Ed.2d 538 (1986). It must establish that there is a &quot;genuine issue for trial.&quot; Id. at 587, 106 S.Ct. at 1356. &quot;In considering the motion, the court\&#39;s responsibility is not to resolve disputed issues of fact but to assess whether there are any factual issues to be tried, while resolving ambiguities and drawing reasonable inferences against the moving party.&quot; Knight 804 F.2d at 11. The inquiry under a motion for summary judgment is thus the same as that under a motion for directed verdict: &quot;whether the evidence presents a sufficient disagreement to require submission to a jury or whether it is so one-sided that one *211 party must prevail as matter of law.&quot; Anderson v. Liberty Lobby Inc., 477 U.S. 242, 251-52, 106 S.Ct. 2505, 2511-12, 91 L.Ed.2d 202 (1986).\n\nDefendants\&#39; Motion for Summary Judgment\nPlaintiff asserts that defendants violated 15 U.S.C. § 3607 &quot;[f]rom the time of the Closing up to and including the effective date of the termination of the Garage portion of the Lease ...&quot; Complaint ¶ 22. In requesting damages retroactive to the first day on which the garage portion of the Lease was executed, plaintiff argues that it was blocked from exercising its option to terminate the Lease pursuant to Section 3607 because defendant Sponsor was exercising what plaintiff terms &quot;special developer control&quot; from the inception of the leasing arrangement. Complaint, ¶ 22. In order for plaintiff\&#39;s claim to survive defendants\&#39; motion, the Court must find that, as a matter of law; (a) plaintiff\&#39;s accrual of the statutory right under Section 3607 to terminate the Lease occurred simultaneously with the execution of the Lease; and if such right accrued as of the inception of the Lease, that (b) defendants\&#39; actions from the date of closing until plaintiff\&#39;s termination of the Lease frustrated the aforementioned right of termination.\n\n(a) Statutory Background\nThe Condominium and Cooperative Protection and Abuse Relief Act of 1980 was promulgated to abate specific abusive practices occurring in the cooperative and condominium conversion process. See H.R. Conf. rep. No. 96-1420, 96th Cong., 2d Sess. 4 reprinted in 1980, U.S.Code Cong. &amp; Admin.News 3506, at 3707; see also Park East Apartments, Inc. v. 233 East 86th Street Corp., 139 Misc.2d 806, 529 N.Y. S.2d 674 (N.Y.Co.1988), withdrawn, 143 Misc.2d 60, 543 N.Y.S.2d 610 (App. Term, 1st Dept.1989). Section 3067 of the Act, in particular, was a response to the activities of many developers in the 1970\&#39;s who created &quot;sweetheart&quot; lease arrangements and self-dealing contracts as a condition of sale. See West 14th St. Commercial Corp. v. 5 West 14th Owners Corp., 815 F.2d 188, 198 (2nd Cir.), cert. denied, 484 U.S. 850, 108 S.Ct. 151, 98 L.Ed.2d 107 (1987).\nThe legislative history of the Act reveals the effort on the part of Congress to &quot;assure fair and equitable principles are followed in the establishment of ... cooperative opportunities ...&quot; 15 U.S.C. § 3601(a)(3). In order to stem the problems associated with &quot;sweetheart&quot; leases, the Act empowered cooperative associations with the right to cancel certain self-dealing leases or contracts during a specified window of time. See Cong. Record Vol. 126 (1980), Comments of Senator Stone at p. 16081. During a cooperative\&#39;s formative years, the association, by vote of its membership and pursuant to the requirements of Section 3607, has the right to cancel a self-dealing contract for a reasonable period of time (two years) after &quot;special developer control&quot;[2] is terminated. 15 U.S.C. § 3607(b).\nThe Act states that a cooperative association such as Park South Tenants Corporation has the right to terminate any contract that (1) provides for operation, maintenance or management of a cooperative association in a conversion project or of property serving the cooperative unit owners in such project; (2) is between such unit owners or such association and the developer or an affiliate of the developer; (3) was entered into while such association was controlled by the developer through special developer control or because the developer held a *212 majority of the votes in such association; and (4) is for a period of more than three years. 15 U.S.C. § 3607(a). All four elements must exist for a contract to be terminated under the statute. West 14th St. Commercial Corp. v. 5 West 14th Owners Corp., 815 F.2d at 197. It is clear and uncontested in the instant case that defendant Sponsor\&#39;s lease with plaintiff satisfies the elements enumerated above.\nA termination of a contract under Section 3607(a) must be done by a vote of owners of at least two-thirds of the units other than those owned by the developer. 15 U.S.C. § 3607(c). Moreover, there is a time limit under the statute for terminating a contract. Under the provision relevant to the present case, the termination must occur within two years following the date on which control by the developer over the cooperative association is terminated or upon which the developer owns twenty-five percent or less of the units in the conversion project, whichever occurs first. 15 U.S.C. § 3607(b).[3] This two-year &quot;window&quot; of time during which a self-dealing contract may be terminated on the initiative of an apartment association has been enforced in past opinions of this Court. See Elan Corporation v. Reade Street Tenants Corporation, Civ. No. 3131 (WCC), slip op., 1986 WL 13776 (S.D.N.Y. December 3, 1986); Tudor City Place Associates and 2 Tudor Garden Parking Corp. v. 2 Tudor City Tenants Corp., et al, 87 Civ. No. 5850 (TPG), slip op., 1990 WL 63809 (S.D.N.Y. May 9, 1990); 520 East 72nd Commercial Corp. v. 520 East 72nd Owners Corp., 691 F.Supp. 728 (S.D.N.Y.1988). Only upon a determination that an association\&#39;s rights under Section 3607 have been frustrated can the Court award damages pursuant to 15 U.S.C. § 3611.[4]\n\n(b) Plaintiff\&#39;s Right to Terminate a Lease Under Section 3607\nPlaintiff\&#39;s complaint before the Court is a product of §§ 3607 and 3611. The essential question, therefore, is whether plaintiff had a right to terminate the Lease under Section 3607(a) at any time prior to January 16, 1989, the date upon which defendant Sponsor relinquished &quot;special developer control.&quot; The clear answer is that it did not. The Court finds that Park South Tenants Corporation did not have a right to terminate the Lease with 200 Central Park South Associates pursuant to Section 3607 as of the inception of the Lease. In fact, the two-year &quot;window&quot; of time during which plaintiff could statutorily repudiate the Lease did not begin until defendant Sponsor relinquished &quot;special developer control&quot; over the cooperative soon after January 16, 1989. Just as the Court in Elan did not extend the two-year time period during which a cooperative could exercise its right to terminate a self-dealing contract, the Act does not give the Court the option to &quot;open&quot; such window at any point before (a) special developer control over the association is relinquished or (b) the developer owns 25% or less of the units in the conversion project.[5]\n*213 The Court can find no basis for plaintiff\&#39;s claim that its rights under Section 3607 were violated by the execution of the Lease or defendant Sponsor\&#39;s &quot;continuing exercise of the special developer control,&quot; complaint, ¶ 22, where Congress has explicitly laid out a timetable pursuant to which an actionable claim under Section 3607 may be initiated. See Brabert Realty Co. v. 20125 Owners Corp., 703 F.Supp. 314 (S.D.N.Y.1989) (the termination of a lease entered into while the cooperative association was controlled by a former owner-developer is timely if done within two years of the end of special developer control). Given the facts at hand, the Court disagrees with plaintiff\&#39;s submission in its memorandum of law in opposition to defendants\&#39; summary judgment motion that,\nwhere a developer imposes on a cooperative a garage lease which the cooperative would have the right and ability to terminate but for the fact that the developer arrogated to itself special powers both to control the governance of the cooperative and to block the cooperative from executing any other garage lease, the developer is liable in damages for the revenues the cooperative lost. Plaintiff\&#39;s Memorandum of Law in Opposition to Defendants\&#39; Motion for Summary Judgment, p. 7.\nThe &quot;control&quot; exercised by defendant Sponsor over plaintiff, as spelled out in the cooperative\&#39;s governing documents, was of the nature contemplated by the statute. While it is evident that defendant Sponsor\&#39;s right to vote the unit shares appurtenant to the unsold apartments in the cooperative did not constitute extraordinary control, the veto power accorded defendant Sponsor by the governing documents over such items as capital improvements, employee hiring, repairs, refinancing, augmentation of the reserve fund, provision of services, equipment procurement, and building leases falls within the Act\&#39;s definition of &quot;special developer control&quot; noted above. Accordingly, the Court will not place liability upon defendants for the defendant Sponsor\&#39;s exercise of control over the coop at a level contemplated by federal statute and, more importantly, not in conflict with any of plaintiff\&#39;s statutory rights. Only upon defendant Sponsor\&#39;s surrender of such control would plaintiff\&#39;s right of termination under Section 3607 have accrued\x97and only upon interference therewith, could a violation be alleged.\nLiability can attach to defendants for damages under the &quot;[a]dditional remedies&quot; provision of Section 3611(a) only if defendants frustrated plaintiff\&#39;s efforts to terminate the Lease. A &quot;violation&quot; of plaintiff\&#39;s rights under the nonjudicial termination procedure set out in Section 3607 exists only when a defendant\&#39;s behavior impedes the legitimate actions of a plaintiff undertaken as of right according to federal statute. Plaintiff asserts that such a position would lead to &quot;results clearly contrary to the goals and requirements of the Act.&quot; Plaintiff\&#39;s Memorandum, p. 15. The Court disagrees. Reflecting upon the language of the Act itself, see Dickerson v. New Banner Institute, Inc., 460 U.S. 103, 110, 103 S.Ct. 986, 990, 74 L.Ed.2d 845 (1983), and the purposes Congress sought to serve by its promulgation, United States v. Matteo, 718 F.2d 340, 341 (2d Cir.1983), it is clear that Congress did not intend to provide plaintiffs, such as the one presently before the Court, with the option of terminating a contract with a developer outside the specified two-year period. 15 U.S.C. § 3607(b).\nBy delaying the attachment of a cooperative\&#39;s right to terminate a self-dealing contract until the occurrence of either the developer\&#39;s relinquishment of control over the cooperative or the developer owning less than 25% or less of the units in the project, Congress recognized (a) that such leases enabled association members to purchase into the cooperative at substantially lower prices, see Elan Corporation v. Reade Street Tenants Corporation, Civ. No. 3131 (WCC), slip op. (S.D.N.Y. December 3, 1986), and (b) that at the nascent stages of the conversion, the sponsor would bear *214 much of the cost of these self-dealing arrangements to the extent that they owned a majority percentage of unsold units. To the first point, the Court takes note of the legislative history of 15 U.S.C. § 3608[6] wherein:\n... the [Congressional] Committee recognized the arguments of developers that, in some circumstances, the leases enabled units to be marketed at substantially lower prices and provided a significant portion of the builder\&#39;s profit in the project as a whole. Therefore, the Committee has specifically directed the courts to focus on these and other considerations in determining whether a lease should be adjudged unconscionable due to a gross disparity between the obligation incurred and the value received by the lessees. P.L. 96-399, 1980 U.S.Code Cong. and Admin.News, at 3559.\nThis Court does not take issue with plaintiff\&#39;s right under Section 3607 to terminate a lease between itself and defendant Sponsor. The Court is cognizant of the underhanded practices of many parties to transactions such as the one before the Court in which developers attempt to reap enormous profits from cooperative owners through &quot;sweetheart&quot; leases and self-dealing service arrangements. 520 East 72nd Commercial Corp. v. 520 East 72nd Owners Corp., 691 F.Supp. at 730 (S.D.N.Y.1988). However, Section 3611 was intended to provide damages only for interference with a cooperative\&#39;s right to terminate a contract under Section 3607. Defendants were respectful of plaintiff\&#39;s rights under Section 3607 and there was no interference with such rights. Defendant Sponsor did not dispute plaintiff\&#39;s notice of termination and yielded to plaintiff\&#39;s demands without contest. Accordingly, the Court grants defendants\&#39; motion for summary judgment on the claim under Sections 3607 and 3611.\n\nDefendants\&#39; Fiduciary Duty to Plaintiff\nBecause defendants\&#39; motion for summary judgment is granted, this Court no longer has pendent subject matter jurisdiction over plaintiff\&#39;s state law claim for breach of fiduciary duty. See United Mine Workers of America v. Gibbs, 383 U.S. 715, 86 S.Ct. 1130, 16 L.Ed.2d 218 (1966). The Court finds no diversity or other independent basis of jurisdiction to entertain such claim. Had the Court concluded that plaintiff\&#39;s claim under Section 3607 was legitimate, it would be obliged to accept jurisdiction over the state law fiduciary claims. W. 14th St. Commercial Corp. v. 5 W. 14th Owners Corp., 815 F.2d at 193 (2nd Cir.1987). However, as noted, that is not the case here. Accordingly, plaintiff\&#39;s state claim for breach of fiduciary duty is dismissed.\n\nCONCLUSION\nFor the reasons stated above, defendants\&#39; motion for summary judgment is granted as to the claim made under the Condominium and Cooperative Protection and Abuse Relief Act of 1980. The pendent state law claim is dismissed for lack of jurisdiction. This action is accordingly dismissed.\nSO ORDERED.\nNOTES\n[1]  At the special meeting held on December 5, 1989, shareholders representing 88 percent of the cooperative\&#39;s units and 87 percent of the appurtenant shares, other than those owned by defendant Sponsor or its affiliates, voted both their shares and their units in favor of the following resolution:\n\nRESOLVED that it is hereby determined, by the Corporation and by the shareholders representing two-thirds of the apartment units, other than the units owned by the developer-sponsor, 200 Central Park Associates, or its affiliates, to terminate so much of the commercial lease between the Corporation and the developer-sponsor dated January 16, 1984, ... directing the Secretary to give written notice of such termination to the developer-sponsor ... Complaint, ¶ 19.\n[2]  The Act defines &quot;Special Developer Control&quot; as:\n\n... any right arising under State law, cooperative or condominium instruments, the association\&#39;s bylaws, charter or articles of association or incorporation, or power of attorney or similar agreement, through which the developer may control or direct the unit owners\&#39; association or its executive board. A developer\&#39;s right to exercise the voting share allocated to any condominium or cooperative unit which he owns is not deemed a right of special developer control if the voting share allocated to that condominium or cooperative unit is the same voting share as would be allocated to the same condominium or cooperative unit were that unit owned by any other unit owner at that time; 15 U.S.C. § 3603(22).\n[3]  The operative provisions of the Act read:\n\nAny termination under this section may occur only during the two-year period beginning on the date on which \x97\n(1) special developer control over the association is terminated; or\n(2) the developer owns twenty-five percentum or less of the units in the conversion project, whichever occurs first. 15 U.S.C. Section 3607(b)\n[4]  15 U.S.C. § 3611 provides in relevant part:\n\nAdditional Remedies\nSuits at law or equity\n(a) Unless otherwise limited as in section 3607 or 3608 of this title, any person aggrieved by a violation of this chapter may sue at law or in equity.\nRecovery of actual damages\n(b) In any action authorized by this section for a violation of section 3607 or 3609 of this title where actual damages have been suffered, such damages may be awarded or such other relief granted as deemed fair, just, and equitable ...\n[5]  It should be further noted that Congress did not empower the courts through Section 3607 to declare unconscionable leases void ab initio as it did in Section 3608. Rather, Congress provided apartment associations, through the enactment of Section 3607, the option to terminate an allegedly self-dealing lease with a cooperative sponsor within a specified window of time and without judicial intervention. Absent specific pleading, plaintiff may not take advantage of the remedial provisions of a Section 3608 nullification in a Section 3607 termination. Accordingly, the Court does not consider the granting of &quot;additional remedies&quot; under Section 3611 to be appropriate in the instance where no right under Section 3607 was violated.\n[6]  The Court recognizes the distinction between Sections 3607 and 3608. The reference made here to the legislative history of the latter serves as a means of gaining some perspective and insight into the development of the Act and the intention of Congress at the time of its passage.\n&#39;},
       {&#39;text&#39;: &#39;Southlake: Carillon Parc Mixed-Use Project Going Forward After All\n\nFeatured Illustration (above): A previous rendering of the initially proposed boutique hotel next to the central park in Carillon Parc. The updated concept has a single, larger grand hotel but keeps a similar design. Image: O’Brien\n\nPosted: 10-8-19\n\nBy Edmond Ortiz\n\nSouthlake (Tarrant County)—Carillon Parc, a European-style mixed-use development involving a hotel, residential, retail and office space, is finally making strides more than one year after the city approved rezoning and a project concept.\n\nMany residents are wondering what has happened with the much-heralded, high-end development that will sit on a 42-acre site at the northeast corner of Texas Highway 114 and North White Chapel Boulevard.\n\nFor more than 10 years, local officials as well as residents in the nearby Carillon residential neighborhood have envisioned Carillon Parc as an opportunity to bring new housing, commercial and shopping opportunities north of downtown Southlake. But an absence of construction vehicles on the property had led many community members to believe the project had stopped.\n\nFormer Southlake Mayor John Terrell, a project partner, addressed City Council, saying rumors and reports that Carillon Parc had fallen through “were slightly exaggerated.”\n\n“We believe in it, we’re passionate about it,” Terrell said about the project in a council work session.\n\nAn aerial view of the planned Carillon Parc development seen from above Texas Highway 114 with North White Chapel Boulevard to the left (going north). The existing Carillon residential neighborhood is in the distant background. Image: O’Brien\n\nCreating “a unique experience” and a “sense of place” are goals in the Carillon Parc concept.\n\nThe concept aims to integrate pedestrian-focused destinations such as hospitality opportunities, restaurants, boutiques/artisan shops, health and wellness services, and public facilities, all of which would be unified around a central park with open spaces, amenities and pathways.\n\nThe entire development is divided into “districts”–an Office district, a Residential district, The Boulevard, The Piazza, The Parc, The Terrace, a Hotel/Wellness district, and a Library district so named because the town’s library will relocate there.\n\n“We’re trying to create something that is unlike anything else in North Texas,” Terrell said, “something that is experiential, something not based on national chain retailers or national chain restaurants.”\n\nThe original 2018 concept plan has undergone some modifications. The envisioned “grand hotel” has expanded the number of guestrooms from 200 to 259, and the ballroom space has been realigned to give better views of the surroundings.\n\nRendering of the Piazza and residential district looking toward the central park, hotel and library areas in Carillon Parc. Image: O’Brien\n\nInitial plans called for two hotels – one “grand hotel” and a boutique hotel, but an independent consultant hired to do a hotel study came back and said two hotels on the same property would not work, according to Terrell.\n\nSo, the developers jettisoned the boutique hotel and added those rooms to the larger hotel, which also has been reconfigured to allow space for a restaurant/bar, and a pool/clubhouse center for Carillon Parc residents.\n\nThe “grand hotel”design would feature an old world European architectural flavor.\n\nMatthews Southwest Hospitality is helping to develop the hotel. Based in Lewisville, Texas, Matthews Southwest has developed hotels and entertainment venues around North Texas, Canada and United Arab Emirates.\n\nScrapping the boutique hotel also permitted the creation of 96,000 square feet of additional office space. A nearby parking deck has been redesigned, too.\n\nRegarding living options, the Carillon Parc plan calls for 100 owner-occupied residential units spread out between the Piazza and Parc districts.\n\nThere have been enhancements to the Boulevard, office building pads, and the park’s water feature, including the addition of a grand staircase and elevator entry leading people from the Piazza to a pedestrian path. The central park has been enlarged from 8.5 to 10 acres; about one-quarter of land at Carillon Parc will be green/open space on the whole.\n\nCarillon Parc designs also have bell towers, trails, wayfinding, street pavers, and stops for rideshares and even future trolley service.\n\nAnother element of the Carillon Parc is how the project team’s designers will capitalize on the rolling topography of the site.\n\nFor example, plans call for the hotel to be built into the topography so that one part of it will stand seven stories tall, and another part of it will be six stories.\n\nAlso, various buildings with have multiple staircases that will offer people different perspectives of the surroundings. Tree preservation, too, will be a key aspect of the development.\n\nFormer Southlake Mayor John Terrell, a co-developer of Carillon Parc, addresses Southlake City Council on Sept. 17.\n\nThe new library space at Carillon Parc will be a vast improvement upon the existing library space in the basement of Southlake Town Hall. The latter space, city officials have said, will likely be repurposed for city or county office operations after the library functions depart.\n\nThe developers hope that Carillon Parc will lure a significant number of local businesses, including start-ups, and that there will be opportunities for such ventures as a culinary school and performing arts.\n\nTerrell said Carillon Parc is not designed to compete with Southlake Town Square, the existing major mixed-use development, but rather “work in concert with it to increase tourism and the number of people coming in to spend money.”\n\nThe project partners feel there’s an increasing monetary value to Carillon Parc. Terrell said thanks to the improvements in the concept plan and additional square footage, the overall value has risen to more than $300 million.\n\nCouncil members lauded the proposed design enhancements and expressed optimism that the project will be fully realized.\n\n“I think there are updates and upgrades here that are interesting and exciting and make a lot of common sense,” Mayor Pro Tem Shawn McCaskill said.\n\nMayor Laura Hill said Carillon Parc represents a chance for Southlake to expand its commercial and recreational presence along an increasingly busy Texas 114 corridor and begin to distinguish itself from the other growing towns and suburbs in North Texas.\n\n“I think we have a take a regional look at (the area) and hope this project moves forward quickly,” she added.\n\nTerrell said he understands the community’s skepticism given the silence surrounding the project. But, he added, the silence was necessary so that project partners could advance sensitive business transactions to advance the development.\n\n“We haven’t been very vocal, now we’re going to be very vocal going forward,” Terrell said.\n\nUndeveloped land lies behind the sign marking the entrance to the existing Carillon residential community. This is where the Carillon Parc mixed-use project will be located. Image: Google Streets\n\nEdmond Ortiz is a lifelong San Antonian and a 20-plus-year veteran in local journalism, He previously worked full-time at the San Antonio Express-News, and has been freelancing for outlets such as the Rivard Report.&#39;},
       {&#39;text&#39;: &#39;Ernie Manouse\n\nErnie Manouse (born September 1, 1969, in Binghamton, New York) is an American television host, radio personality, writer and producer. He currently hosts the interview show InnerVIEWS with Ernie Manouse, produced by HoustonPBS. His work with HoustonPBS has met critical acclaim in the southern United States, earning him numerous KATIE awards and regional Emmy Awards\n\nEarly life\nManouse was born Ernest David Manouse in Binghamton, New York. He is of Greek descent. After graduating from high school, and despite being accepted to Massachusetts Institute of Technology with a perfect math SAT score, he attended Loyola University Chicago and studied to be a music video director. While in college, he guest-hosted Outlook, a Chicago-based radio show, with a classmate. Their radio presentation received such a positive reaction that Outlook hired them permanently.\n\nCareer\nManouse began his career in television with NBC Network News, then moved into radio with WLS and WLUW in Chicago, and then moved back to TV at HoustonPBS. Ernie has since worked his way through many aspects of talk shows, from screening calls on the call-in radio shows Sex Talk and The Phyllis Levy Show to hosting his own brand of chat and magazine programs. He can also be seen on PBS Stations across the country hosting numerous pledge and entertainment specials, including three of public television\&#39;s most successful pledge events with financial guru Suze Orman.\n\nIn 1996, Ernie moved to Houston, Texas, and spent six years hosting and producing the daily magazine program WeekNight Edition, which evolved into WeekDAY and became Houston\&#39;s most celebrated local television program, earning multiple Emmy and Houston Press Club awards. Manouse shared with Matthew Brawley the 2006 Katie Award for &quot;Outstanding Interview/Talk Show&quot; for the southern region.\n\nIn October 2002, Manouse helped to create and produce the local primetime magazine show The Connection, which he hosted for two years.\nIn 2004, Manouse launched the syndicated series InnerVIEWS with Ernie Manouse. This award-winning series is distributed nationally to PBS stations across the country and airs in more than 100 cities in the U.S. and the Virgin Islands. The show features Manouse in unedited, one-on-one interviews with noted personalities such as Patti LuPone and Jamie Foxx. Manouse thoroughly researches his guests before interviewing them and arranges an informal setting to encourage spontaneous discussion.\n\nAnother area of broadcasting that Manouse has explored is late night talk, and on February 9, 2005, Manouse launched The After Party, combining arts coverage and light-hearted interviews reminiscent of Johnny Carson and Jack Paar. The show received positive reviews from both critics and audiences alike, garnering the coveted Emmy nomination for &quot;Best Entertainment/Variety program&quot; in its first season. The program ended its run on November 15, 2006, after over 50 episodes.\n\nIn 2006, Manouse produced and anchored A Conversation on RACE for HoustonPBS. He also produced the political Red, White &amp; Blue and moderated the 2002 Houston Mayoral Debates, the 2008 Texas Supreme Court Judicial Debate, and the 2008 Texas US Senate Debate. In 2009, Manouse became the anchor and producer of Houston 8, a weekly current events discussion series. He also hosted the 2009 HoustonPBS Spelling Bee, the largest regional qualifying spelling bee for the national Scripps Spelling Bee.\n\nAfter seven nominations for the Lone Star (Texas) regional chapter of the Emmy Awards, Manouse won three Emmys in 2009. He won for Best Information Series and Best On-Air Talent. He also won an Emmy for his work on the Houston Spelling Bee in the category of Best Event Coverage. He has won an additional two awards over the last few years, bringing his Emmy total to five.\nManouse is also a voice actor. He has done the English voiceovers for over a dozen Japanese anime videos produced by ADV Films, including Gilgamesh, Le Chevalier D\&#39;Eon, and Cromartie High School.\n\nCommunity involvement\nManouse is an active member of the Houston LGBT community. Manouse has hosted community events such as the U.S. Military Ball and the Cattle Baron\&#39;s Ball and served as a conversationalist at the University of Houston Honors College Great Conversation. He serves on the advisory board of both Stages Repertory Theatre and Dominic Walsh Dance Theater. He served as Vice President of Public Affairs for the Greater Houston United Services Organization (USO). He was also vice president of the Houston Gay and Lesbian Film Festival.\n\nReferences\n\nExternal links\n  USO Houston\n  InnerVIEWS with Ernie Manouse\n  Houston Gay and Lesbian Film Festival\n  Ernie Manouse\&#39;s website\n\nCategory:1969 births\nCategory:Living people\nCategory:American people of Greek descent\nCategory:American television talk show hosts\nCategory:LGBT producers\nCategory:Loyola University Chicago alumni\nCategory:Writers from Binghamton, New York\nCategory:LGBT broadcasters from the United States&#39;},
       {&#39;text&#39;: &quot;You&#39;ve reached your article limit\n\nSubscribe now to continue reading the Arkansas Times\n\nFriday, October 31, 2008\n\nOpposition Research: Tulsa\n\nIt&#39;s time now for a report on the Tulsa Golden Hurricane, courtesy of Biggs Barker. Bigg is a die-hard Hogs fan and computer genius who spent most of his teenage years in a federal prison for various hacking-related cybercrimes. Biggs (we&#39;re not sure that&#39;s his real name) now helps lead the government&#39;s domestic surveillance and wiretapping efforts.\n\nNeedless to say, the last few days before Tuesday&#39;s election are a very busy time for him. However, he was all too happy to take a few moments out of his hectic schedule to compile the following report about the University of Tulsa and its football team.\n\n2008 record: 8-0 (5-0 in Conference USA)\n\nRanking: No. 19 in AP poll, No 18. in USA Today and BCS polls\n\nOffense: Tulsa averages 55.6 points per game and 601.1 yards of total offense per game (346 yards in passing and 255.1 yards in rushing. Gulp.\n\nDefense: Tulsa is allowing 26.1 points per game and 382.8 yards of total offense per game (255.8 yards passing and 127 yards rushing).\n\nPlayers to watch: Quarterback David Johnson is averaging 332.6 yards of passing per game. For the year, he has completed 68.3 percent of his attempts and thrown for 32 touchdowns and nine interceptions. Once again, gulp. Running back Tarrion Adams is rushing for 80.4 yards per game, and receiver Brennan Marion is hauling in 103.4 yards per game.\n\nComments\n\nMore by Razorback Expats\n\nCharles Balentine remains well-known among Razorback fans for hitting the 3rd biggest shot in Arkansas history (we&#39;ll give you two guesses as to what #1 and #2 are), but many other details of his storied career are slipping away into the mists of time.\n\nRazorback news and notes from around the web (warning: some of these links aren&#39;t exactly timely, but then again you probably already knew not to count on us for hot-off-the-presses info):\n* Nate Allen rips Jeff Long a new one (he even busts out the Y-word).&quot;},
       {&#39;text&#39;: &#39;Selective internal manipulation of a single molecule by scanning tunneling microscopy.\nWe have studied the adsorption of the polyaromatic molecule 1,4&quot;-paratriphenyldimethylacetone, which we have nicknamed Trima. The originality of this linear molecule is that it was designed and synthesized to have two functionalities. First, chemisorb itself to the surface by its two ends rather like a bridge. Second, the central part of the molecule could then be rotated by injecting electrons with the tip of the scanning tunneling microscope (STM). The length of the molecule corresponds exactly to the spacing between five dimers in a row on the Si(100)-2 x 1 surface. We found that the molecule adsorbs as expected on the clean silicon surface by using complementary STM and synchrotron radiation studies. Manipulation of individual molecules with the STM tip showed selective internal modifications that were highly voltage dependent. These manipulations were found to be compatible with an electronic excitation of the pi-pi* transition of the molecule.&#39;},
       {&#39;text&#39;: &#39;Sign up for our COVID-19 newsletter to stay up-to-date on the latest coronavirus news throughout New York City\n\nThe latest edition of Anthology Film Archives’ program “The Cinema of Gender Transgressions,” “Trans Film,” is an eclectic selection of shorts, documentaries, and features that showcase queer, transgender, and non-binary subjects.\n\nThe weeklong program includes a 35-mm print of Neil Jordan’s 2005 film “Breakfast on Pluto” (March 10 at 7 p.m.; March 12 at 9 p.m.), a risky adaptation of Patrick McCabe’s novel. Patrick/ Kitten Brogan (Cillian Murphy) is first seen pushing a pram and giving lip to sassy construction workers. Kitten is brimming with self-esteem; the rest of the film shows the long, strange road of getting there.\n\nOrphaned as a child, Kitten’s foster mother did not appreciate young Patrick’s penchant for wearing female clothing, and the masters at the school Patrick attended looked askance at what they saw as outrageous antics, including questions about gender reassignment. Kitten leaves home to locate Patrick’s birth mother, and in the process finds herself.\n\nMurphy gives a seductive, show-stopping performance — he looks quite fetching decked out in leather, feathers, lipstick, and heels — and sports a cheeky attitude. This is a worthwhile film, a heady mix of sex, politics, and religion, despite some overly elaborate sweeping camera movements and a bizarre pair of talking birds.\n\n“Everyday Dis/Comforts” (March 12 at 7 p.m.; March 17 at 7:15 p.m.) is an uneven collection of four videos from around the world. “Video Home System” examines censorship in Pakistan, explains how foreign music and movies are pirated and adapted, and how the resulting content provides images of both empowerment and lament. One such example is Annie Lennox’s song “Why,” which is heard on the soundtrack as a man and two young girls perform along to the music. “Snap” is a fascinating triptych featuring queer and trans youth in Chile. As a series of Snapchat clips reveal episodes from their lives, these youth are seeing combating homophobia and transphobia. One subject, Alexa, records her gender reassignment operation. This is arguably the best film in the shorts program. After a brief introduction, “The Island of Perpetual Tickling” documents “ridiculously ticklish” performer Vika Kirchenbauer being tickled for nine straight minutes. It is a toss-up as to who need muster the greater endurance — Kirchenbauer or the viewer. The last entry in the program, “Piedad,” is a wondrous, darkly comic, and explicitly erotic short about sex workers performing fellatio — and some considerably more shocking sex acts.\n\nOne of the program’s highlights is the 2009 Russian-language film “Maggots and Men” (March 13 at 7:30 p.m.; March 14 at 5:45 p.m.) by trans director Cary Cronenwett. This experimental film features what is reportedly the largest cast of transgender actors assembled as it tells the story of the Kronstadt Uprising of 1921 against Russia’s new Bolshevik government. The narrative unfolds through letters Stephan Petrichenko (Stormy Henry Knight) writes to his sister, Anya, about his life as a sailor. His experiences, which include homoerotic exercising and skinny dipping as well as a romance with fellow sailor Yuri Kilgast (Travis Clough), soon segue into the political, as opposition to the government escalates into rebellion and mutiny. Cronenwett filmed “Maggots and Men” in stylized black and white, cross-cutting between a stage play recounting the history and scenes with Stephan on and off the ship. The approach recalls Guy Maddin crossed with gay filmmaker Sergei Eisenstein. “Maggots and Men” is playful, poetic, and polemical all at once. Cronenwett will attend the March 14 screening.\n\nOn March 13, “Maggots and Men” screens with Cronenwett’s 2015 film “Peace of Mind.” This documentary is a loving profile of Flo McGarrell, a queer, trans, and polyamorous friend of Conenewett’s who died in the 2010 earthquake in Haiti. McGarrell was the director of a nonprofit gallery, FOSAJ, in Jacmel, and in the film is remembered by various folks who admired him. There are also observations about the challenges McGarrell faced in finding respect and acceptance in an intolerant Haitian society, but also about the impact he nevertheless had on the region’s art and culture.\n\nDirector Chet Pancake will be on hand to present “Queer Genius” (March 14 at 7:30 p.m.; March 15 at 4:45 p.m.), a galvanizing documentary that profiles five queer female artists. The film opens with a segment on the late Barbara Hammer, who talks about her life, her archive, and her legacy as a visual artist. Rasheedah Phillips and Camae Ayewa (aka Moor Mother) run a Black Quantum Futurism collective in North Philadelphia and pair soundscapes with spoken word to explore science fiction and queer voices. They talk about their lives, theories, and experiences in compelling interviews. “Queer Genius” next showcases Jibz Cameron aka Dynasty Handbag, who is seen in her closets talking about her favorite outfits, as well as performing on stage. Rounding out the documentary is a portrait of famed lesbian poet Eileen Myles. She is seen reading her work and discussing her life, her sobriety, and her political attitudes. This documentary is an inspiring portrait of provocative and legendary artist-activists.\n\nThe final entry in the series is Philip Brooks and Laurent Bocahut’s 1998 documentary, “Woubi Chéri” (March 15 at 7:30 p.m.; March 17 at 9:15 p.m.), about the gay and transgender community in Abidjan, Ivory Coast.\n\nTHE CINEMA OF GENDER TRANSGRESSIONS: TRANS FILM | Anthology Film Archives, 32 Second Ave. at Second St. | Through Mar. 17 | anthologyfilmarchives.org&#39;},
       {&#39;text&#39;: &#39;\n30 Wn. App. 240 (1981)\n633 P.2d 892\nROBERT HENRY, Respondent,\nv.\nTHE TOWN OF OAKVILLE, ET AL, Appellants.\nNo. 3756-II.\nThe Court of Appeals of Washington, Division Two.\nAugust 25, 1981.\n*241 Dan Glenn and Buzzard &amp; Glenn, for appellants.\nJack L. Burtch, for respondent.\nMaureen J. Dightman and Cynthia M. Weed, amici curiae.\nPETRIE, J.\nThe Town of Oakville appeals an adverse judgment in an action in which plaintiff, Robert Henry, successfully challenged the validity of the notice requirements of the Open Public Meetings Act of 1971 for special and adjourned meetings. RCW 42.30.080-.090. The trial court invalidated three town ordinances which had authorized a bond issue for water system improvements and established new water rates to repay the bond debt. The threshold issue before this court, however, is whether the trial court had authority to resolve the issues presented when the holder of the bonds was neither named nor served as a party defendant. We conclude that it did not have authority to consider the validity of these ordinances in the absence of the bondholder.\nThe 1970 comprehensive water and sewer plan for Grays Harbor County recommended construction of certain water system improvements for the Town of Oakville, a fourth class town of 625 inhabitants.[1] The town council decided to finance the improvements through water system bonds. On October 15, 1973, at a council meeting &quot;continued&quot; from a *242 regular meeting of October 8, the council enacted ordinance No. 283 authorizing a $32,000 bond issue. Pursuant to payment provisions in the ordinance, the town later enacted two ordinances increasing water rates to pay the bond debt (ordinances Nos. 287 and 289).\nPlaintiff objected to the new water system. After his initial protests against the system proved ineffective, he brought this action seeking (1) a judgment declaring that the ordinances had been adopted contrary to law and were void; (2) an injunction against future enforcement of the ordinances; (3) damages from the individual council members; and (4) attorney\&#39;s fees and costs. The only defendants named were the town itself and the individuals who were members of the town council at the times it acted on these ordinances. Before the case went to trial, the town council met in a regular session and ratified each ordinance. The ratification ordinances are not in evidence.\nAfter a bench trial, the court ruled that the Open Public Meetings Act of 1971 required advance written notice of special and adjourned meetings be given to local newspapers, regardless of whether the newspapers had filed a request for such notice. Because the town council provided no such notice for the special and adjourned meetings at which the ordinances were approved, the court held they were void under the act. RCW 42.30.060.[2] The trial court specifically rejected proposed findings of fact intended to reflect that proper notices of adjourned meetings had been posted pursuant to RCW 42.30.090 and that proper notices had been posted after passage of the basic ordinances pursuant to RCW 35.27.300.[3] Nevertheless, the court failed to *243 find that the proper notices had not been posted. The court also ruled that the ratification had been invalid.[4] In a posttrial brief filed in support of its motion for reconsideration, the town for the first time challenged the court\&#39;s jurisdiction on the ground the bondholder was not a party. The record before us does not contain the trial court\&#39;s express response to this objection. Nevertheless, the court entered judgment. We therefore infer that the motion for reconsideration was considered and denied. Defendant Town appealed.\n[1] We turn first to the question whether the trial court had jurisdiction to proceed in a declaratory judgment action challenging the validity of ordinances authorizing the issuance of municipal bonds and providing for their payment in the absence of the bondholder, here the Farmers Home Administration of the United States Department of Agriculture. The failure to join an affected party in a declaratory judgment action relates directly to the trial court\&#39;s jurisdiction. Williams v. Poulsbo Rural Tel. Ass\&#39;n, 87 Wn.2d 636, 643, 555 P.2d 1173 (1976). An objection grounded in the failure to join an affected party may properly be considered for the first time on appeal. Williams v. Poulsbo Rural Tel. Ass\&#39;n, supra; RAP 2.5(a). Thus, defendant\&#39;s bringing the matter to the trial court\&#39;s attention on a motion for reconsideration was timely.\nPlaintiff would avoid the application of the Uniform Declaratory Judgments Act provisions relating to parties, RCW 7.24.110, and ignore the fact his complaint was labeled one for declaratory relief. Instead, plaintiff argues this court should apply the joinder rules of CR 19(a). Whether we apply the statute or the rule, however, we conclude *244 the bondholder was a necessary party to this action and the court should not have considered the merits of the ordinances.\nRCW 7.24.110 provides in part:\nWhen declaratory relief is sought, all persons shall be made parties who have or claim any interest which would be affected by the declaration, and no declaration shall prejudice the rights of persons not parties to the proceeding.\nThe bonds are revenue bonds, issued pursuant to the town\&#39;s authority under RCW 35.92.100 and payable only from\nthe special fund of the Town known as the &quot;Farmers Home Administration Water Revenue Bond Redemption Fund&quot; ...\nOrdinance No. 283. The authorizing ordinance established the special fund to pay and secure the principal and interest on the bonds. The ordinance required the town to impose and collect rates and charges sufficient to permit the fund to meet the town\&#39;s obligations on the bonds. To ensure these obligations were met, the town council therefore enacted ordinance No. 287, revising the town water rates. Later, the town council enacted ordinance No. 289 as an amendment to ordinance No. 287 to provide separate rates for industrial users.\nAs provided in ordinance No. 283, the bonds were duly issued and sold to the Farmers Home Administration. The first payment was due January 1, 1976, with annual payments due thereafter for 40 years. The judgment before this court, however, declares all three ordinances null and void. As plaintiff requested, the judgment also forever enjoins the town from enforcing these ordinances or taking any further action regarding the authority granted in them.\n[2] Plaintiff argues that the bondholder\&#39;s interest is not &quot;affected&quot; by this declaration and the bondholder is not prejudiced. He points out in support of his argument that the bondholder, as a good-faith purchaser, could maintain an independent and probably successful action to recover *245 on the bonds despite the invalidity of the ordinances. Thompson v. Perrine, 103 U.S. 806, 26 L.Ed. 612 (1881) (judgment that bonds invalid of no effect on bona fide purchaser not party to action and said judgment no defense to action by bondholders on bonds); see also Johnson v. Berg, 147 Wash. 57, 265 P. 473 (1928); RCW 35.92.100; RCW 62A.8-202(2)(b). While we acknowledge the availability of such a remedy, we do not interpret this availability to disqualify the bondholder as a person claiming &quot;an interest which would be affected by the declaration&quot; of invalidity. On the contrary, the very fact this judgment leaves the bondholder in a position in which it must sue to enforce its rights demonstrates to us its qualification as a party with an affected interest. The declaratory judgment statute requires that such a party be joined.\nFurthermore, CR 19(a) provides in part:\nA person who is subject to service of process and whose joinder will not deprive the court of jurisdiction over the subject matter of the action shall be joined as a party in the action if ... (2) he claims an interest relating to the subject of the action and is so situated that the disposition of the action in his absence may (A) as a practical matter impair or impede his ability to protect that interest...\n(Italics ours.)\n[3] A necessary party under CR 19(a) has recently been defined definitively as one who &quot;has sufficient interest in the litigation that the judgment cannot be determined without affecting that interest or leaving it unresolved.&quot; Harvey v. Board of County Comm\&#39;rs, 90 Wn.2d 473, 474, 584 P.2d 391 (1978). It is clear, as we have already indicated, that the Farmers Home Administration has an interest in the subject matter such that the judgment would affect its interest and would, in fact, impede its ability to protect that interest.\nPlaintiff\&#39;s reliance on 28 U.S.C. § 1491 as a bar to state jurisdiction is misplaced. That statute merely gives the United States Court of Claims jurisdiction to hear contract *246 actions against the United States, United States v. King, 395 U.S. 1, 3, 23 L.Ed.2d 52, 89 S.Ct. 1501 (1969). Although the bondholder would be joined as a party defendant, this action is clearly not a contract action against the federal government. Plaintiff\&#39;s argument based on 28 U.S.C. § 1491 is therefore without merit.\nFrom the foregoing analysis it is clear that under both RCW 7.24.110 and CR 19(a), the Farmers Home Administration should have been a party to this lawsuit. See, e.g., Stallcup v. Tacoma, 13 Wash. 141, 42 P. 541 (1895), appeal dismissed, 165 U.S. 719, 41 L.Ed. 1185, 17 S.Ct. 998 (1897); Northwest Greyhound Kennel Ass\&#39;n v. State, 8 Wn. App. 314, 506 P.2d 878 (1973).\nHaving determined that the trial court and this court lack jurisdiction to proceed, we would ordinarily remand with direction to dismiss unless the bondholder is joined as a party hereto within 90 days of the mandate issued herein. See Williams v. Poulsbo Rural Tel. Ass\&#39;n, supra. Before remanding, however, we are constrained to express guidelines to aid in whatever proceedings might follow in light of the trial court\&#39;s ruling that the town council\&#39;s subsequent ratification was ineffective.\n[4] The well established rule is that where a governing body takes an otherwise proper action later invalidated for procedural reasons only, that body may retrace its steps and remedy the defects by reenactment with the proper formalities. Jones v. Centralia, 157 Wash. 194, 212, 220, 289 P. 3 (1930); LaRose v. King County, 20 Wn. App. 808, 814, 584 P.2d 393 (1978); 4 E. McQuillin, Municipal Corporations 597-98 (3d ed. rev. 1979); 64 Am.Jur.2d Public Securities and Obligations § 381 (1972); see generally Board of Supervisors v. Schenck, 72 U.S. (5 Wall.) 772, 18 L.Ed. 556 (1867); see also Spokane Educ. Ass\&#39;n v. Barnes, 83 Wn.2d 366, 378, 517 P.2d 1362 (1974). Appropriate legislation authorizes towns to provide for water system improvements, to issue bonds to finance such improvements, and to create special funds for revenues to pay off the bond debt. See, e.g., RCW 35.92.100 et seq. Ordinances *247 enacted in the exercise of a municipality\&#39;s power are presumed valid. 56 Am.Jur.2d Municipal Corporations §§ 355, 382 (1971); see Seattle v. Wright, 72 Wn.2d 556, 559, 433 P.2d 906 (1967). A person challenging the validity of municipal legislative action has the burden to show the action taken was improper and thus rebut the presumption. See LaMon v. Westport, 22 Wn. App. 215, 219, 588 P.2d 1205 (1978). We see no evidence of any procedural or substantive improprieties in the enactment of the ratification ordinances unless some impropriety lies in the factually unresolved areas of whether the town complied with the provisions of RCW 42.30.090 and 35.27.300.\n[W]here the procedure followed has not been in accordance with law, proceedings had thereunder must be held void; but this nowise precludes the ultimate municipal authority, ... from again exercising in a lawful manner its authority for the purpose of correcting errors and mistakes due, not to a basic want of power, but to defective procedure which has, in some respects, caused the municipal machinery to cease to function.\nJones v. Centralia, 157 Wash. at 212.\nAccordingly, the judgment is reversed and the case remanded for further proceedings not inconsistent with this opinion.\nREED, C.J., and PETRICH, J., concur.\nReconsideration denied November 6, 1981.\nReview denied by Supreme Court January 22, 1982.\nNOTES\n[1]  In 1977, the Town of Oakville adopted the optional municipal code, RCW Title 35A, and became the City of Oakville. The events involved in this action occurred while Oakville was a town, however, and we therefore retain that designation in this opinion.\n[2]  But see Kirk v. Pierce County Fire Protection Dist. 21, 95 Wn.2d 769, 630 P.2d 930 (1981) in which the court declared that written notice of special meetings need only be given to those media who have filed a request therefor.\n[3]  RCW 42.30.090 provides in part: &quot;Whenever any meeting is adjourned a copy of the order or notice of adjournment shall be conspicuously posted immediately after the time of the adjournment on or near the door of the place where the regular, adjourned regular, special or adjourned special meeting was held.&quot;\n\nRCW 35.27.300 provides:\n&quot;Every ordinance shall be published at least once in a newspaper published in the town or, if there is no such newspaper, it shall be printed and posted in at least three public places therein.&quot;\n[4]  In addition, the court dismissed the action against individual council members because it found they had not knowingly violated the act. See RCW 42.30.120.\n&#39;},
       {&#39;text&#39;: &#39;Q:\n\nsend an email in python through google smtp\n\nAlright so, I have been trying to send an email through python 3 using the smtplib module. Here is my code. I left out information such as credentials that could be used to identify me.\nimport smtplib\nFROM = \&#39;me@gmail.com\&#39;\nTO = [&quot;receiver@gmail.com&quot;]\nSUBJECT = &quot;Hello!&quot;\nTEXT = &quot;This message was sent with Python\&#39;s smtplib.&quot;\nmessage = &quot;&quot;&quot;\\\nFrom: %s\nTo: %s\nSubject: %s\n%s\n&quot;&quot;&quot; % (FROM, &quot;, &quot;.join(TO), SUBJECT, TEXT)\nusername = \&#39;me@gmail.com\&#39;\npassword = \&#39;password\&#39;\nserver = smtplib.SMTP(\&#39;smtp.gmail.com:587\&#39;)\nserver.ehlo()\nserver.starttls()\nserver.login(username,password)\nserver.sendmail(FROM, TO, message)\nserver.quit()\n\nThere is just a little problem though, the first time I tried to run my script it gave the following error.\nserver = smtplib.SMTP(\&#39;smtp.gmail.com:587\&#39;)\nAttributeError: module \&#39;smtplib\&#39; has no attribute \&#39;SMTP\&#39;\n\nSo I thought, &quot;Well this is weird, I\&#39;ll try another setup.&quot; The thing is though, now even importing smtplib at all gives an error from another file not referencing it as shown as.\nTraceback (most recent call last):\n  File &quot;C:\\Users\\Tatatat0\\Documents\\python\\business.py&quot;, line 6, in &lt;module&gt;\n    import smtplib\n  File &quot;C:\\Users\\Tatatat0\\AppData\\Local\\Programs\\Python\\Python35\\lib\\smtplib.py&quot;,\n    import email.utils\n  File &quot;C:\\Users\\Tatatat0\\Documents\\python\\email.py&quot;, line 47, in &lt;module&gt;\n    server = smtplib.SMTP(\&#39;smtp.gmail.com:587\&#39;)\nAttributeError: module \&#39;smtplib\&#39; has no attribute \&#39;SMTP\&#39;\n\nAny idea what could be going on and/or how I could properly use smtp through python?\n\nA:\n\nThe problem is that your code is in a Python script file named email.py. \nWhen you import smtplib in business.py, smtplib tries to import email.utils, but it is accessing your version of email.py, not the one from the standard library.\nThe easy way to fix it is to rename your script. You will also want to remove the email.pyc file as this will continue to be imported even though the .py file has been removed.\n\n&#39;},
       {&#39;text&#39;: &#39;Field of the Invention\nThis invention relates to a suspended ceiling system having ceiling panels, T-bar shaped beams (ceiling runners) joined to create a grid, and clips which can be attached to the grid for holding the ceiling panels thereto. Advantageously, the clips of the present invention allow the easy removal of the ceiling panels. In addition to this, the clips can also be easily attached to or removed from the grid.\nSystems of suspended ceiling panels have been popular for both commercial and residential buildings. These systems allow the installation of a ceiling which can be acoustically absorbent and is aesthetically pleasing. These ceiling systems, moreover, can be quickly and easily installed. The ceiling systems are particularly desired for hiding pipes, wiring, and duct systems that are common in many buildings.\nSuspension ceilings having a variety of different features directed to the attachment of ceiling panels to a ceiling grid have been developed. One suspension ceiling system is disclosed in U.S. Pat. No. 4,640,064. This system combines snap-up pans and lay-in panels. The system includes runners formed with channels formed by opposed lateral flanges, depending side walls and inturned lips. Yet another system is described by U.S. Pat. No. 2,059,483 which requires a channel bar and clips which are inserted into the channel of the channel bar. The clips are attached to building panels which are thereby held to the channel bar. U.S. Pat. No. 4,463,537 describes a suspended ceiling or wall system employing clips fabricated to permit the semi-permanent attachment of the individual clips to a suspended grid tee system. The system contains a clip leg with extruded wands angling therefrom for frictionally coupling decorative molding thereto. The molding system, in turn, supports a plurality of decorative plaques.\nU.S. Pat. No. 4,463,537 describes a clip for suspending ceiling panels. The clip, at one end, attaches to the ceiling panel, and at the other end, has a hook element for removably attaching to an existing ceiling panel grid.\nEven though there is a variety of suspended ceiling systems there is still a need for a suspended ceiling system which provides easily removable panels which can also be easily attached to the ceiling runner grid system. In addition to this, for cosmetic purposes, the ceiling system should preferably not show any part of the ceiling runners after the suspended ceiling has been installed. The present invention provides such a ceiling system.&#39;},
       {&#39;text&#39;: &#39;\nConfiguration Ideas\n\nHere are some theoretical configuration ideas that we could implement some\ntime.  Note the naming convention: %Namespace.Directive. If you want one\nimplemented, give us a ring, and we\&#39;ll move it up the priority chain.\n\n%Attr.RewriteFragments - if there\&#39;s %Attr.IDPrefix we may want to transparently\n    rewrite the URLs we parse too.  However, we can only do it when it\&#39;s a pure\n    anchor link, so it\&#39;s not foolproof\n\n%Attr.ClassBlacklist,\n%Attr.ClassWhitelist,\n%Attr.ClassPolicy - determines what classes are allowed. When\n    %Attr.ClassPolicy is set to Blacklist, only allow those not in\n    %Attr.ClassBlacklist. When it\&#39;s Whitelist, only allow those in\n    %Attr.ClassWhitelist.\n\n%Attr.MaxWidth,\n%Attr.MaxHeight - caps for width and height related checks.\n    (the hack in Pixels for an image crashing attack could be replaced by this)\n\n%URI.AddRelNofollow - will add rel=&quot;nofollow&quot; to all links, preventing the\n    spread of ill-gotten pagerank\n\n%URI.HostBlacklistRegex - regexes that if matching the host are disallowed\n%URI.HostWhitelist - domain names that are excluded from the host blacklist\n%URI.HostPolicy - determines whether or not its reject all and then whitelist\n    or allow all in then do specific blacklists with whitelist intervening.\n    \&#39;DenyAll\&#39; or \&#39;AllowAll\&#39; (default)\n\n%URI.DisableIPHosts - URIs that have IP addresses for hosts are disallowed.\n    Be sure to also grab unusual encodings (dword, hex and octal), which may\n    be currently be caught by regular DNS\n%URI.DisableIDN - Disallow raw internationalized domain names. Punycode\n    will still be permitted.\n\n%URI.ConvertUnusualIPHosts - transform dword/hex/octal IP addresses to the\n    regular form\n%URI.ConvertAbsoluteDNS - Remove extra dots after host names that trigger\n    absolute DNS.  While this is actually the preferred method according to\n    the RFC, most people opt to use a relative domain name relative to . (root).\n\n    vim: et sw=4 sts=4\n&#39;},
       {&#39;text&#39;: &#39;Westman Islands Will Continue Hunting Puffins\n\nNews\n\nWestman Islands Will Continue Hunting Puffins\n\nJuly 30, 2008 11:44Updated: January 30, 2014 20:16\n\nPuffin hunters of Bjargfélagid hunting association in the Westman Islands, off Iceland’s southern coast, decided in a meeting on Monday to continue hunting puffins until August 15 like they would normally do.\n\nThe puffing hunting season began two weeks later than usual this year, because few puffin chicks have survived for the past few years, 24 Stundir reports.\n\nBjargfélagid therefore met to discuss whether puffin hunting should be discontinued, but concluded that it is likely that more chicks will survive this year since there are more sand eels in the ocean surrounding the islands.\n\nAccording to Morgunbladid, the Iceland Marine Research Institute has indeed found more sand eels in Icelandic waters than last year.\n\nNext weekend the Westman Islands will celebrate an annual outdoor festival where puffins, a local delicacy, will be served according to tradition. Members of Bjargfélagid say that despite lack of puffins for the festival, they will hunt in moderation.\n\nOriginally, Bjargfélagid had only intended to hunt puffins until July 31, but due to bad weather at the beginning of the season, hunting has not been successful this year.\n\nMeanwhile, ecologists have reported dead puffin chicks in puffin colonies around Iceland, on Breidafjördur in west Iceland and Vopnafjördur in east Iceland, and in the Westman Islands.\n\nErpur Snaer Hansen, director of ecological research at the South Iceland Nature Institute, said he had first noticed dead puffin chicks in the Westman Islands on Saturday. Hansen said if this development continues, the institute will recommend puffin hunting be discontinued.&#39;},
       {&#39;text&#39;: &#39;MILLINOCKET, Maine — A 15-year-old girl is hiking through Maine as she nears the end of the Appalachian Trail in her attempt to become the youngest person to hike the trail from end-to-end alone.\n\nNeva Warren of Spring Hill, Fla., began her trip in Georgia on April 1.\n\nOn Wednesday, she had about 15 miles to go to Mount Katahdin, the northern end of the 2,200-mile trail. After reaching the peak, she was going back to another part of Maine to hike a 100-mile stretch that she passed over earlier.&#39;},
       {&#39;text&#39;: &#39;#!/usr/bin/perl\n# -- so option\n \n##$f=&quot;10 +  1/(1+ 100**(sin(x*3)-y)) &quot;;\n$f = &quot;10 + sin(x/10)*cos(y/3)&quot;;\n$err=0.001;\n$errg=0.05;\n$nbiteration=3;\n$bamg=&quot;../../src/bamg/bamg&quot;;\n$quadoption=&quot;&quot;;\n$bamgoption=&quot; -AbsError -NbJacobi 3  -ratio 2 -anisomax 30&quot;;\n$quadoption=&quot; -2q -thetaquad 30 -coef 2&quot;;\n\n# ---  change x in $x and y in $y \n$_=$f;\ns/x/\\$x/g;\ns/y/\\$y/g;\n$f=&quot;$_;&quot;;\nprint &quot;The function = f(x,y) = $f \\n&quot;;\n\n#--------------------------\n$suffixe=&quot;.mesh&quot;;\n$iteration=0;\n$GH=&quot;Gh$suffixe&quot;;\n$TH=&quot;Th$iteration$suffixe&quot;;\n$, = \&#39; \&#39;;               # set output field separator\n$\\ = &quot;\\n&quot;;              # set output record separator\n##  -------------------------------------------------------------\n##  --- construction the Geometry file Gh.mesh \n##  a naca0012 wing in a big circle radius 5 \n##   20 points on the up wing \n##   20 points on the down wing \n##    8 points on circle of radius r \nopen(GH,&quot;&gt;$GH&quot;)  || die &quot;Can\&#39;t redirect stdout&quot;;\n$Pi = 3.14159265358979;\n$i20 = 20;\n$i8 = 8;\n$r = 5;\n$c0x = 1;\n$c0y = 0;\nprint GH \&#39;Dimension\&#39;, 2;\nprint GH \&#39;MaximalAngleOfCorner 46\&#39;;\n\nprint GH \&#39;Vertices\&#39;;\nprint GH $i20 + $i20 + $i8;\n\n# the vertex on naca012  wing ( clock wise)\nfor ($i = -$i20; $i &lt; $i20; $i++) {\n    $X = $i / $i20;\n    $X = $X ** 4;\n\n    $t = 1.008930411365 * $X;\n    $Y = 5 * .12 * (0.2969 * sqrt($t) - 0.126 * $t - 0.3516 * $t ** 2 + 0.2843\n\n      * $t ** 3 - 0.1015 * $t ** 4);\n    if ($i &lt; 0) {\n        $Y = -$Y;\n    }\n    print GH $X, $Y, 3;\n}\n\n# vertex on circle  (counter clock wise)\nfor ($i = 0; $i &lt; $i8; $i++) {\n    $t = $i * $Pi * 2 / $i8;\n    print GH $c0x + $r * (cos($t)), $c0y + $r * sin($t), 5;\n}\n\nprint GH \&#39;Edges\&#39;, $i20 + $i20 + $i8;\n\n#  edge on wing  \n$k = 1;\n$j = $i20 + $i20 - 1;\n# previous points\nfor ($i = 0; $i &lt; $i20 + $i20; $j = $i++) {\n    print GH $j + $k, $i + $k, 3;\n}\n# previous, current vertex\n\n# edge on circle \n$k = $i20 + $i20 + 1;\n$j = $i8 - 1;\n# previous points\nfor ($i = 0; $i &lt; $i8; $j = $i++) {\n    print GH $k + $j, $k + $i, 5;\n}\n# previous, current vertex\n\n#   one subdomain, region on left side of the wing\n#   because clock wise sens.\nprint GH \&#39;SubDomain\&#39;, 1;\nprint GH 2, 1, 1, 0;\nclose GH;\n##  -------------- END construct of the geom \n## \n\n# -- make the DATA file for the mesh to also  save the arguments \nopen(BAMG,&quot;&gt;DATA_bamg&quot;)  || die &quot;Can\&#39;t open  DATA_bamg&quot;;\nprint BAMG &quot;$quadoption $bamgoption  -g $GH -o $TH  -v 9&quot;;\nclose(BAMG);\n\n## constructio the inital  mesh \n!system($bamg) || die &quot;Error in bamg construction of initial  mesh $Th&quot;;\n\n##  the adpatation loop \nwhile ($iteration&lt;$nbiteration) {\n\n    \n    $BB=&quot;$iteration.bb&quot;;\n    \n##  construction of the solution  \n    $errsol=0;\n    open (TH,&quot;&lt;$TH&quot;) ||  die &quot;Can\&#39;t open  $TH&quot;;\n    open (BB,&quot;&gt;$BB&quot;) ||  die &quot;Can\&#39;t open  $BB&quot;;\n    open (PLOT,&quot;&gt;PLOT&quot;) || die &quot;Can\&#39;t open PLOT&quot;;\n    while (&lt;TH&gt;) {\n\tif(/^Vertices$/) {\n\t    $nbv=&lt;TH&gt;;\n\t    chop($nbv);\n\t    print BB &quot;2 1 $nbv 2&quot;;\n\t    for ($i=1;$i&lt;=$nbv;$i++) {\n\t\t($x,$y,$ref)=split(/[\\ \\t\\n]+/, &lt;TH&gt;);\n\t\t$fxy=eval $f;\n\n\t\t$xx[$i]=$x;\n\t\t$yy[$i]=$y;\n\t\t$ff[$i]=$fxy;\n\n\t\tprint BB $fxy;\n\t    };\n\t};\n\tif(/^Triangles$/) {\n\t    print &quot; Nb of Triangles = $nbt \\n&quot;;\n\t    $nbt=&lt;TH&gt;;\n\t    chop($nbt);\n\t    for ($i=1;$i&lt;=$nbt;$i++) {\n\t\t($i0,$i1,$i2,$ref)=split(/[\\ \\t\\n]+/, &lt;TH&gt;);\n\t\tprint PLOT &quot;$xx[$i0] $yy[$i0] $ff[$i0]&quot;;\n\t\tprint PLOT &quot;$xx[$i1] $yy[$i1] $ff[$i1]&quot;;\n\t\tprint PLOT &quot;$xx[$i2] $yy[$i2] $ff[$i2]&quot;;\n\t\tprint PLOT &quot;$xx[$i0] $yy[$i0] $ff[$i0]&quot;;\n\t\tprint PLOT &quot;&quot;;\n\n\t\t$x   = ($xx[$i0]+$xx[$i1]+$xx[$i2])/3;\n\t\t$y   = ($yy[$i0]+$yy[$i1]+$yy[$i2])/3;\n\t\t$fm  = ($ff[$i0]+$ff[$i1]+$ff[$i2])/3;\n\t\t$fxy = eval $f;\n\t\t$vv=($fm-$fxy);\n\t\t$vv= ($vv&lt;0)?-$vv:$vv;\n\t#\tprint &quot; $i0 $i1 $i2 $xx[$i0] $xx[$i1] $xx[$i2] &quot;;\n\t#\tprint &quot; $i $x $y $fm $fxy err= $errsol diff=$vv&quot;;\n\t\t$errsol = ($errsol&gt;$vv) ? $errsol : $vv;\n\t    };\n\t};\n\n    };\n    close TH;\n    close BB;\n    close PLOT;\n    print &quot; ---------------------------------------------\\n&quot;;\n    print &quot;\\n\\n Iteration $iteration\\n Erreur L_infini = $errsol \\n\\n&quot;;\n    print &quot; ---------------------------------------------\\n&quot;;\n\n##  -----------------------\n    \n    $iteration++;\n    $BTH=$TH;\n    $TH=&quot;Th$iteration$suffixe&quot;;\n    \n    open(BAMG,&quot;&gt;DATA_bamg&quot;)  || die &quot;Can\&#39;t open  DATA_bamg&quot;;\n    print BAMG &quot;$quadoption  $bamgoption  -Mbb $BB -errg $errg -err $err   -b $BTH -o $TH  -v 9&quot;;\n    close(BAMG);\n    !system($bamg) ||    die &quot;Error in bamg construction of adapted $iteration  mesh $Th&quot;;\n}\n\nprint &quot;Normal End\\n&quot;;\n&#39;},
       {&#39;text&#39;: &#39;Publishing in the various fields of medical science obeys several reasons, of which increasing knowledge -- perhaps independent on forecasted translation --, dissecting pathophysiology, sharing experiences with peers, communicating on clinical trials, reporting on evidence bases for treatments, and offering views to be discussed within the community such as ethical issues and compassionate care, etc. (this list is obviously non-exhaustive). All such items apply to transfusion medicine and blood transfusion-related issues.\n\nTransfusion -- since its earliest times -- has never be alike a &quot;quiet water pond&quot;, and many progresses have been achieved to serve military medicine on the battlefield (a special issue on *Transfusion* *in* *the* *Armed* *Forces* is under way and should be released in the journal in 2021).\n\nThe recent occurrence of the disastrous COVID-19 situation has further highlighted that transfusion had to question the safety of blood donors, blood component recipients, availability of blood where and when needed, at times of nation-, or region-, or city-wide lock-downs, and also ethical issues relative -- for example -- to convalescent plasma therapy. This COVID-19 situation occurred at a time where not all other transfusion issues were resolved, such as blood transmissible infections with major threats such as HIV, HVB, HCV, etc. and regional attacks of viruses and parasites (Dengue viruses, *Plasmodiae* *spp*., *Babesia* *spp*., *Trypanosoma* *cruzi*, West Nile virus, etc.), each altering blood availability as well a patient safety; indeed, those emergent and reemergent pathogens are prevalent in a large part of the world in countries developing their economy and may pose a threat to economically wealthy countries as well, as a consequence of the global climate change. At the time this Editorial was prepared, a civilian disaster has struck Beirut, the capital of Lebanon; more than 3000 citizens have been injured (and more than 130 died); many are missing; among the injured, many require surgery and blood transfusion: this situation calls once more on how to build up a safe blood inventory in case of an emergency and how to prioritize actions the field of transfusion safety. When times comes after the situation soothes, &quot;*Transfusion* *Clinique* *et* *Biologique*&quot; will commission a special issue on that very relevant topic.\n\nAs all other peer-reviewed, non-predatory journals in the field of transfusion medicine, &quot;*Transfusion* *Clinique* *et* *Biologique*&quot; offers to bridge expertise of investigators and needs of field practitioners. A &quot;Bridge over trouble water&quot;, however, as medicine is rather an ocean than a pond and water is subjected to tides and tempests. Tides would govern quality and safety that non-reluctantly come on stage for the safe handling of patients in need of blood transfusion; &quot;Patient Blood Management&quot;, for instance, could be viewed as a &quot;high tide coefficient&quot; in this temporality. Tempests would trouble waters of medical disciplines, and in general relate to infectious epidemics (but also civilian catastrophes) that regularly shake transfusion and even politic systems.&quot;&quot;...Your time has come to shineAll your dreams are on their waySee how they shineOh, if you need a friendI\&#39;m sailing right behindLike a bridge over troubled waterI will ease your mindLike a bridge over troubled waterI will ease your mind.&quot;&quot;\n\nPaul Simon (Paul Simon and Arthur Garfunkel, 1970).\n\nIn such a troubled world, the &quot;*Transfusion* *Clinique* *et* *Biologique*&quot; Journal evolves in a &quot;The Times They Are A Changing&quot; period:&quot;&quot;...Come writers and criticsWho prophesize with your penAnd keep your eyes wideThe chance won\&#39;t come againAnd don\&#39;t speak too soonFor the wheel\\\&#39;s still in spinAnd there\\\&#39;s no tellin\&#39; whoThat it\\\&#39;s namin\&#39;For the loser nowWill be later to winFor the times they are a-changin\&#39;...&quot;&quot;\n\n(Bob Dylan, 1964).\n\nThe Journal has indeed experienced a profound mutation a couple of years back when the Board endorsed the decision to commute to English as the preferred medium over French, to broaden both authorship and readership. This transformation was aimed at accompanying the seen and foreseen developments and progresses in the transfusion-related fields. The Journal has actually succeeded in broadening both (authorship and readership), and its Clarivate™ (formerly ISI) Impact Factor has started an ascending move (now 1.2), for what it is worth. This has not been without damages as we -- at the Journal office -- see less communications coming from historical authors and readers in Northern and Western Africa, and France. Of note, to shortcut this happening (in Africa), a forthcoming special issue dedicated to the Transfusion in Africa is under way and should be released in the Journal in early 2021. Meanwhile, it is our strong belief that bridging is more solid when arches are firmly planted in the ground, inlaid in robust evidence based-experiences coming from the largest as possible scope of transfusion practitioners. It is our strong belief at &quot;*Transfusion* *Clinique* *et* *Biologique*&quot; that experience sharing is of utmost importance to colleagues operating in less favored areas; the Journal still addresses their concerns more than many other Journals in the field, as shown by the growing number of published papers originating from China, India, Iran, Brazil, Mexico, and Middle-East countries, to cite some.\n\nSharing fruitful experiences and also negative ones (to prevent unsuccessful duplication, unneeded costs and unacceptable harm to patients), should be a motto in the hopes and glory of publishing. &quot;*Transfusion* *Clinique* *et* *Biologique*&quot; has committed itself to this objective and both the scientific\\* and executive board members are grateful to authors who build its reputation, and to readers who trust in its robustness to better care patients, the ultimate goal. This objective is served by the commitment of a largely international Editorial Board\\* whom I am glad to say a big &quot;Thank you&quot; for their time expertise and dedication, and their role in the growing success of &quot;*Transfusion* *Clinique* *et* *Biologique*&quot;. From our side at the Journal office, we endeavor to improve the overall quality of publication and make all due effort to fasten the process (among other actions).\n\nDisclosure of interest {#sec0005}\n======================\n\nThe author declares that he has no competing interest.\n\nThe author -- EIC of the Journal -- wishes, in particular, to warmly thank Editorial Board members\\*, i.e. Prs and Drs A.\xa0Al-Riyami, L.\xa0Amorim Filho, T.\xa0Burnouf, JJ.\xa0Cabaud, L.\xa0Castilho, J.\xa0Chiaroni, F.\xa0Cognasse, B.\xa0Danic, D.\xa0de Korte, M.\xa0de Montalembert, V.\xa0Deneys, MP.\xa0Emonds, W.\xa0El-Nemer, G.\xa0Folléa, S.\xa0Fontana, C.\xa0Gachet, M.\xa0Goldman, O.\xa0Hequet, Z.\xa0Ivanovic, S.\xa0Laperche, B.\xa0Lassale, K.\xa0Magnussen, C.\xa0Martinaud, Z.\xa0McQuilten, P.\xa0Moncharmont, P.\xa0Morel, Y.\xa0Ozier, T.\xa0Peyrard, C.\xa0Politis, B.\xa0Pozzetto, M.\xa0Prudent, JY.\xa0Py, C.\xa0Tayou Tagny, P.\xa0Tiberghien, JD.\xa0Tissot, P.\xa0van den Burg, APJ.\xa0Vlaar, T.\xa0Vuk, and the Deputy EIC, Pr F.\xa0Pirenne.\n&#39;},
       {&#39;text&#39;: &quot;I recently took some photographs for Nashville Business Journal. (Above) Is Brian Uhl, An owner at Caban (right) are cooks, Pedro Villalobos and Jose Angeles at Yellow Porch in Nashville. The Article was about how the summer&#39;s drought will affect food costs. Read the entire story here.&quot;},
       {&#39;text&#39;: &#39;Q:\n\nNeed to change inputs to a function before they are used?\n\nI am trying to write a  function that intakes two lists which represent the digits of a natural number, in reverse and SUMS them. There may also be an arbitrary number of trailing 0\&#39;s in the lists.\nplus :: [Int] -&gt; [Int] -&gt; [Int]\n-- Ex: &quot;plus [0,1,2,0] [2,1,0]&quot; meaning 210+12\n\nI have 3 separate functions that perform different parts of the problem and I cant get them to work together:\n\ncleanString puts the digits back in order (most significant first) and removes any extra 0\&#39;s (cleanString [0,1,2,0] outputs [2,1,0]):\nfromDigits takes a list like [2,1,0] and gives 210:\nthen the actual &quot;plus&quot; function is where I cant get it to run the input lists through cleanString before they go into fromDigits and add the resulting two ints. Compile error at fromDigits (x.cleanString).\n\ncleanString :: [Integer]-&gt;[Integer]\n--reverse the string, then trim any leading zeroes\ncleanString x = dropWhile(&lt;1) y where y=reverse x\n\nfromDigits :: [Integer] -&gt; Integer\nfromDigits xs = aux xs 0\n    where aux [] acc = acc\n          aux (x:xs) acc  = aux xs ((acc * 10) + x)\n\nplus :: [Integer]-&gt;[Integer] -&gt; Integer\nplus x y = (fromDigits (x.cleanString))+(fromDigits (y.cleanString))\n\nA:\n\nx isn\&#39;t a function, so it doesn\&#39;t make sense to . it with anything. You shouldn\&#39;t be doing x.cleanString, but rather cleanString x. Same for y. With those changes, your program seems to work for me:\nplus x y = (fromDigits (cleanString x))+(fromDigits (cleanString y))\n\nIf you want to use . even though you don\&#39;t have to, you can, just on functions instead of on x or y:\nplus x y = ((fromDigits.cleanString) x)+((fromDigits.cleanString) y)\n\n&#39;},
       {&#39;text&#39;: &quot;It&#39;s actually not really that funny - it&#39;s just pointlessly smutty. Now I like a bit of smut just like anyone else, but it&#39;s irrelevant here and diminishes the Obama brand.\n\nSure, you&#39;ll get a bunch of 15 year olds watching the video on Youtube, but to the people who really matter for this product (people who might give a donation to Obama) this tone of voice is a negative rather than a positive. The great shlep had a warmth to it that people could relate to - quirky yet middle ground.\n\nThis, however, lacks wit (being dirty isn&#39;t witty - it&#39;s just dirty) and drags the liberal brand in America back into the kooky wierd cliche that they have been working so hard to overcome. Like, would you trust an economy to someone with this tone of voice?\n\nNow I&#39;m sure Obama had nothing to do with this, and would not endorse it in anyway. But the chuckleheads who made this really need to pull their finger out and realise that being shocking and puerile is the lowest form of advertising, and any CD worth their salt who sees this on their reel will think the lesser of them for it.&quot;},
       {&#39;text&#39;: &quot;Cross Examination: NINJA\n\nAfter being thoroughly questioned for my nefarious skills at reading words on paper and having a father who likes men, my ex’s Bitch Lawyer seemed to have lost a grip on her plan of attack. Her entire paycheque depended on her ability to somehow make it my fault that my abusive ex had sent my naked photos to our coworkers and gotten fired for it. She left the room to speak with him in the hallway, where he’d been banished because of the restraining order.\n\nI could hear his urgent whispers and the sound of him rustling through his notes. It was such an awkward sort of anticipation, waiting for her to come back and hit me with her best shot. As the hours passed, it just got more and more bizarre.\n\n“…is it true that you ignored the State Department’s warnings after September 11th and traveled alone in places that are dangerous for women?”\n\n“I was 14 years old on September 11th, and the first time I ever left the states was when I was 21. I went on an African safari so… no.”\n\n“But you have traveled to places the State Department considers dangerous?”\n\n“I really don’t know. If you can list these countries I’ll let you know if I’ve been to them.”\n\nShe stepped out from behind the table where she’d been standing all morning and closed the gap between us. The witness stand was on a platform so I was still at eye level with her.\n\n“You’re not easily intimidated, are you?”\n\n“I don’t understand the question.”\n\n“It takes a lot for you to be intimidated. Are you intimidated by me?”\n\nIt felt like an elementary school blinking contest, and I was prepared to let my eyes shrivel up like raisins and fall out of my face before I’d lose to this biatch.\n\n“Nope,” I said slowly.\n\nI knew this would only help her make whatever idiotic point she was gunning for, but I couldn’t help it.\n\n“Ms. Lorens, you’re someone that people call when they’re in trouble, aren’t you?”\n\n“Can you clarify what you mean by people?”\n\n“At the hospital, you are someone that they call when a patient is getting violent, is that right?”\n\n“Uh, no. I’m in executive management, I don’t have anything to do with responding to panic alarms.”\n\n“But when you and Mr. Psycho Ex were dating, you worked on the wards, is that right?”\n\n“Yes.”\n\n“And when there was a violent altercation, didn’t they call on you to come and handle the situation?”\n\nREALLY?!\n\n“No, definitely not.”\n\n“Ms. Lorens, my client tells me that you are known for being able to wrestle patients to the ground and that there was one incident in particular where you took on an ex-con all by yourself and everyone just stood back while you protected the other patients.”\n\nMy jaw was to the floor. How did this woman make it through law school if she was stupid enough to believe the paranoid and delusional ramblings of my ex?\n\n“First of all, we don’t wrestle patients to the ground. We’re a trauma-informed facility that will do practically anything to avoid putting our hands on another person. We use verbal intervention and redirection. If someone were so violent that they had to be ‘wrestled’ I wouldn’t be anywhere near that situation. My role in any sort of escalation was to offer someone an Oreo or tell them I’d bring a new DVD with me the next day. “\n\nI paused to take a breath, but just couldn’t stop.\n\n“And for what it’s worth, ex-cons don’t necessarily look like what you see on TV, our hospital is full of people who are just like you and me.”\n\n“That may be so, but Ms. Lorens, wouldn’t you consider yourself to be fearless?”\n\nA Taylor Swift song began playing in my mind, but I don’t think that’s what she meant.\n\n“No.”\n\n“You claim to be afraid of Mr. Psycho Ex and yet you willingly work in a dangerous place and have traveled as a single woman all over the world. Does that make sense to you?”\n\n“Yes, it makes sense because I experienced his behavior while we were dating.”\n\n“And yet you stayed with him for almost an entire year?”\n\nI nodded.\n\n“Ms. Lorens, I’m going to need you to answer me with a yes or no.”\n\n“Yes.”\n\n“Why would you stay with someone you’re afraid of? You’ve made some very bold claims about his behavior—that he talked about killing your male coworkers or killing you, and yet you stayed. Why is that?”\n\n“I don’t know. I can’t speak to the psychology of why women stay in abusive relationships.”\n\n“You’re an educated woman who seems to do whatever she wants, yet you claim to have let him treat you so badly without doing anything about it?”\n\n“I did do something about it. I told the police and I told my employers.”\n\n“A year later. Why’d you wait so long?”\n\n“I kept hoping it was over, but he just kept coming back and things kept getting worse.”\n\n“Ms. Lorens, are you claiming to be afraid of him so that you can have revenge against him?”\n\n“No.”\n\n“Why would you have even sent such personal photos to someone who you claim was so unstable? You seem smarter than that.”\n\n“I sent the photos at a point in our relationship where things weren’t so bad. I never imagined he would use them against me.”\n\nI’d spent the last year of my life trying to convince myself that I wasn’t a “victim”—that I was strong and that I shouldn’t believe the shitty thoughts that threatened my brain, telling me I deserved what he’d done to me and that I was worthless. Yet here I was, having to argue with someone about the fact I was a victim. My blood was boiling but I had to remember my rules of cross-examination:\n\nGoal #1: Keep your shit together.\n\nGoal #2: Be as unhelpful as possible.\n\nGoal #3: Destroy him.\n\nAfter extensively judging me for allowing a man to treat me so badly, she told me to open the evidence binder in front of me and turn to Exhibit C-12.\n\nIt was a copy of the Virgin Mobile phone records I’d printed after being able to access the account he’d set up with my personal information. She spent a fair amount of time questioning me about how I’d gotten these records.\n\n“I right clicked and hit print.”\n\nShe asked a thousand variations of “how do we know you didn’t forge these documents?” and “how do we know you didn’t send those photos yourself” and “did you actually see Mr. Psycho ex purchase the pre-paid phone?”\n\nAfter thoroughly establishing just how fake and unreliable she considered my records to be, she had me flip to Exhibit C-13. These were the Virgin Mobile records that she’d subpoenaed from Sprint, their parent company.\n\nThis was the first I’d seen of them and they were a mess of numbers and codes in a non-descript excel file. My employer’s attorney immediately objected to having these records entered as evidence and while they debated it out with the judge I flipped back and forth between the two sets of records. At first look, they seemed completely inconsistent but as someone who has a knack for identifying century-old burial patterns, I began to identify various places where the information lined up.\n\nThe judge eventually allowed the records into evidence and Bitch Lawyer proceeded to begin her line of questioning. I was still staring at the numbers and didn’t look up when she began to speak. This did not sit well with her and she bobbed her head, enunciating my name like it was an insult.\n\n“Msssss. Lorensssss?”\n\nShe pursed her lips, waiting for me to look up.\n\n“What are you looking at?”\n\nHer tone was full of accusation.\n\n“… the records you just told me to turn to… and it’s interesting because these completely confirm my records, which you claim were forged.”\n\nShe began to panic.\n\n“Judge, I can’t have her flipping through and looking at things she’s not supposed to be looking at, this is the exact sort of behavior I’ve been trying to demonstrate—“\n\n“Counsel,” the judge interrupted, “You just instructed the witness to turn to the exhibit. Do you or do you not want her to look at them?”\n\nShe told me to shut the binder and not to look at another thing.\n\n“I’m going to subpoena an expert witness from Sprint to come and testify about these records, I’ll suspend this line of questioning until then.”\n\nI was finally released for the remainder of that day. I’d have to come back multiple times but I wouldn’t have to talk about the records until after a Sprint expert was found. I met with my employer’s attorney a few days later and when she left the room to find a stapler, I flipped through the binder and took photos of the Sprint records—sure, not the most ethical move but I had to be ready for the performance of my life.\n\nHave you ever had to defend some aspect of your personality as though it were a flaw? What’s the most absurd lie someone has told about you? Would you bend the rules of ethics if you knew it would help the right side win?\n\nWant to keep in touch? Drop your email below and I&#39;ll send you FULL POSTS anytime I write something new. Only want to know book news? Get on the list here.\n\nDid she seriously ask you if you were “fearless”? That’s the stupidest line of questioning I’ve ever heard. Apparently she was trying to prove you were a sociopath or something.\nMy new theory is that Bitch Lawyer was into Psycho Ex and was trying to get him into bed with her… because that’s the only way her reasoning makes any sense whatsoever.\nBTW – I squealed like a happy child when I saw this post come up on my Reader! 🙂 Twas great lunchtime reading 🙂\n\nI know! So ridiculous. Parts of the other people’s testimonies are sealed (including my ex’s) so I wasn’t able to get transcripts but the trooper who did the security was in the room and he would give me all the details later. Apparently my ex went on and on about how I was this fierce bad ass, rolling around war torn countries and all this other madness. Special, so special.\n\nHey Cimmy– I’ll pop over and check it out, promise. I don’t want to commit to anything I can’t deliver on though and these next few weeks are jam packed for me… so much so that I have a couple guest posts coming up to help me survive. But I will come check it out and support you in whatever way I can 🙂\n\nGah this bitch has so much karma coming for her. Whoop! It’s a bitch. And so is she. There is no way I could be in the courtroom while you were testifying. I’d be thrown out after the first BOOYAH, IN YOUR FACE, and/or BURN that I yelled.\n\nHaha! That would have been amazing. There were empty seats, I totally could have brought along a brigade of supporters and you could have made signs and it would have been that much harder for me to keep a straight face the whole time!\n\nHaha! Oh man. High praise. I watched the first two seasons of that show like an addict… I don’t know what it is about it that will make me sacrifice sleep and health to hit “play next episode,” but man I do it every time.\n\nRIGHT?! It’s a real thing, actually! You have to fly them in from Kansas or some other random state (no offense, Kansas people) and pay all their expenses just to have them testify. And that’s what he ended up doing. What an asshat.\n\n(An aside: I’m multitasking at least 15 different things right now and almost didn’t proof before hitting “post”, which would have left this: .”..you are a BJ.” And that is why we proofread, kids, because Aussa is not a BJ.)\n\nHaha! At least you caught it, I know well that feeling where you’ve hit the “reply” button just as you see some horrifying typo on the screen. I’m not sure how I would have taken it if you’d called me your BJ… I would probably have googled it to see if it had an alternate meaning and then been completely distracted by the search engine results…\n\nBrave as always, Aussa, in the face of stupidity, meanness and obvious evil. I love the way you always, always, always paid attention to No. 3 on your list of behavior under cross-examination . Destroy the enemy, you do. This movie is going to No. 1 on the box office lists.\n\nWell, yeah. When you’re playing with a deck stacked against you, you do what you have to do, if it’s a reasonable bet that it will help. You don’t owe it to anyone to take the moral high ground when you are at risk through no fault of your own.\n\nUgh. I couldn’t turn away from the stink eye. I know I shouldn’t have kept looking at it, but I found myself mesmerized. Luckily, my desire to find out what happened next in your story overrode my fascination with the stink eye, and I managed to break away from my trance. Awesome story!\n\nHaha! It’s hard to know whether the gifs help tell the story or totally derail people’s ability to continue reading… I know that it can often take just as long to find and upload the gifs as it does to write the post because I find myself getting distracted left and right…\n\nThere are times I think that if women really understood how little recourse they have when confronted with abuse, how much victim-blaming goes on, how difficult it is to thread the legal maze, that they would never willingly have anything to do with men again. Just in case.\n\nAnd that is why we need you, guys-who-aren’t-dicks, to have our backs when this kind of shit comes down. In any way you can.\n\nVery true, Miep and honestly I think that this sort of thing is the reason why people often don’t speak up against their abusers. Why put yourself through this shit storm if you can try to just ignore it, wish it away, or run from it? If only I’d thought of throwing that back in her face when she was acting all judgey about the fact I’d waited so long to report him.\n\nIt happens all the time and at many levels. There is so much pressure to just ignore such bad behavior that one only calls it out as a last resort, when you realize you’re backed into a corner and that if you don’t fight back it will only get worse.\n\nAt the same time, it’s quite possible to recognize that breaking the silence will be perceived as threatening and that there will be punitive backlash. Then you get to watch the whole thing play out like some kind of bad melodrama.\n\nThe useful thing I learned from all this crap is that disrespecting boundaries is a huge red flag and to have a scorched earth policy towards anyone who does. This is complicated by some people being bad at seeing social cues. This is not a failing so much as a quirk, and it can be worked around with good communication.\n\nBut if you make “no” clear, and they don’t respect that, about anything at all really, it’s never going to end, you’re not being treated as a peer. You are dealing with someone with hidden agendas, and the sooner you cut them off, before their fixation on their chosen target – you – gets out of control, the better.\n\nI suspect that when women are accused of playing hard to get, they are often just testing this – how does he behave when he’s told no? Can he handle this without getting angry?\n\nI can understand that in any actual relationship, people absent-mindedly piss each other off in various ways – we are none of us perfect – but there is a real contract there, and a sense of entitlement is much less of a red flag.\n\nThe idea of “boundaries” and how to set them and recognize when they’re being violated is something that ought to be taught in schools. Or it should be one of those conversations you have to have with your kids. The Birds, Bees, and Boundaries.\n\nRight? I think she was having a VERY BAD day. I assume she probably just took his word for it and assumed that what he said was true and that I’d just be this stupid little weirdo who wouldn’t have a clue. As things went on she just began to look more and more angry and I don’t know if it was at me or him, ha.\n\nRight? When I reviewed all of this with my attorney, Betsy, she said that all of those slut-shaming and bullying tactics were for the benefit of my ex and NOT the judge. Apparently shaming the witness and trying to make them all embarrassed and upset is a way to win favor with the person who’s paying you but it doesn’t win any points with the judge. Seems like quite a risk.\n\nSeems like quite a crappy attorney. Anybody any good knows the whole thing is a stage play, and you play to those who count – the judge, and the jury if any. You never do something that might piss off the judge.\n\nBut if the judge is a known misogynist, you might play it like that. At the same time, judges are used to attempts to play them and find it disrespectful. Juries can be endlessly manipulated though, if you’re good at reading people.\n\nIn answer to your question… yes, all the time. In fact, I just wrote something yesterday in regards to defending a personality trait often deemed negative that really shouldn’t be anyways.\n\nAs a woman who has been through an abusive relationship myself, I wanted to reach over the Internet and over that bench and slap the crap out of that lawyer with my giant IQ. Intelligence has nothing to do with falling for a manipulative being. In fact, if anything, intelligence is closely linked to empathy, which allows a person to view the good in people — which is not a bad thing in my book.\n\nI’m sorry you are going through this. You have a good sense of humor about this; I suppose you have to in order to deal with the absurdity of your “opponents.”\n\nLuckily, most people are not like that idiot lawyer and your ex-boyfriend, and it sounds like the judge can see right through the b.s. Best wishes! I love your blog!\n\nHey, thank you! And yes– so true about intelligence and abusive relationships! That’s something that’s often written about, actually, that plenty of “well educated, successful” women find themselves in those situations. She was just a cruel hearted person going for the low blows, I think.\n\nDid you write about this personality trait on your blog, you mean? I will need to head over and check it out if so. Thanks so much for your support!\n\nI wonder if it is the same trick I know called “buying a large dead whole fish and laying it across the manifold of his car” or hiding some raw shrimp under the car mats and pushed up INTO the upholstery of his car seats…that trick? (Rotting flesh smell NEVER leaves…like EVER….thanks Myth Busters.)\n\nThis made me all PRE: “Booyah kid” and “in your FACE” and “DEAL WITH IT” at the same time…waiting not very patiently for the conclusion…ya know the part where you look elegant and cool and collected and LIKE A BOSS when he loses and bitch lawyer gets handled epically. GO Aussa, GO!\n\nYou mean you don’t wrestle ex cons to the ground on a daily basis? I was really hoping there might be a fight club feature somewhere in the future of your blog. But I think what you’re saying is no, right?\n\nThis definitely has me hooked. Does your legal team get to find their own Sprint expert for the next installment, or is the plan to just use literacy and numeracy skills?\n\nI’m so sorry… but I just can’t help myself. Why must women supposedly have testicular descriptions when they are tough? (Don’t they get to have some sort of powerful lady balls? The only thing I can think that is directly equivalent is, y’know, mammary.)\n\nAnd mainly because patriarchal society deems that being tough is equitable to being a man. Therefore if a woman is tough she needs to have great big hairy balls because it’s only attributed to being masculine.\n\nEnd of day it was a off hand remark. Probably best to leave it at that.\n\nFair enough. Not sure I found the particular video you mentioned (the guys didn’t seem to be Swedish) but I did find one that otherwise fit the description. Amusing to see what they said after the experience (“you guys are superheroes… amazing”.\n\nI haven’t seen that video but I’ve heard a lot of people refer to it! And I think that saying someone has balls isn’t necessarily offensive, it’s just a turn of phrase. I’m much more likely to consider being offended when female anatomy is used as an insult for weakness… but that’s just because I read the Vagina Monologues as a young impressionable teen. That being said, I kind of love the “c” word. Never use it but have a secret in-the-closet sort of fondness for it.\n\nOkay i got pissed. and i mean pissed at the biatch lawyer. Why would you stay in an abusive relationship.? Honestly she never paid any attention in law school.. It is exactly why women and some men do not leave. they are being abused.\nGot tat pissed me of so much.\n\nas for you question.remember me being called lazy.\nI turned to my boss gave him my keys and told him he did not have to pay me if i was SO lazy as people told me i was,. maybe he should go talk to all those subcontractors for me. LOL\nyesvi got to stay they were sorry.\nand a second time i did i walked out the office and left for good. damn asses. good to see them go dead after that 😀\n\nand if someone else is accused of something i know they did not do. i back them up 100%\n\n“and a second time i did i walked out the office and left for good. damn asses. good to see them go dead after that :D”\n\nThe last four business establishments I’ve been involved with (in management, more or less) all went south after I left. I’m not sure whether this speaks to my irreplaceability or to my having a penchant for lost causes 🙂\n\nI was one of he fixers. getting everything working. and when in management you get a good grip on contractors and knowing how to smooth things.. when things go sour and and nobody to smooth things over they walk away.\nmaybe it meant nothing but felt good anyway\n\n“I was one of he fixers. getting everything working. and when in management you get a good grip on contractors and knowing how to smooth things.. when things go sour and and nobody to smooth things over they walk away.”\n\nGood managers are often unappreciated because a sign of good management is what’s not happening as much as what is. They don’t know what they’ve got ’till it’s gone.\n\nWalking out on a job… sounds heavenly. When I was in high school I had a terrible sort of work ethic where I’d just sort of vanish from a job when I was tired of it. But I’ve done the responsible two weeks notice since then. It would be amazing to just up and leave though. Preferably with flames shooting up in your wake or something.\n\nAnd yeah– it was a really stupid move for her to ask me that. I assume she wanted me to start rambling and try to justify something and then give her some little tidbit to work with but she mostly just made herself look like an ignorant ass.\n\nI was one who always would back someone up ad be ethical and got screwed more than once . but if someone calls me lazy while i been getting shots to kill the pain in my back they can go to hell. no way will i work with an ass like that.and to think he been there for 4 weeks and never seen me.Oooh i flamed. he came to apologize. and i just stared. nobody tells me i am lazy when i put every waking minute of my day in that company. worked about 80-100 hours a week\nand they call me lazy.\n\nYou are a survivor, Aussa, not a victim. Huge difference. 🙂 My ex accused me of being an IV drug user because I came home with unused syringes and bottles of medicine (saline) in my pockets after working in CCU for 12 hours. It sounded horrible at the custody hearing. Worse, my attorney really didn’t do anything to defend me.\n\nYeah, that’s a scary thing to have to take into consideration when it comes to making a shady ethical move. When it comes to your traditional “revenge” opportunities, I opt against them for that very reason (and because it will destroy your soul). But with something like this… it’s just a gamble. Like, do the ends justify the means? Hmm. I started out as a Philosophy major and took so many classes on ethics and would be like “well, there’s the ethical choice and then there’s the choice I would realistically make in that situation.” Just being honest, ha.\n\nWell, your ex-wacko got one thing right about you: You ARE a fierce bad ass…Geezus can he be this backward and fail? And his lawyer? She went to an actual law school, right? Great line of questioning she has there…she was HIS lawyer, right? Filed under : “Hey asshole: Your lawyer, doin’ it WEIRD.”\n\nHaha! You know… I just might have to look her up to see where she went to law school. I’m pretty sure that when this whole thing first came about I extensively stalked her on the interwebs and from the surface she looked rather impressive so she can’t have flown with the phoenix or anything, I don’t think… Who knows, such a mystery! I was always under the impression you had to be of a high intelligence to make it through law school and pass the bar buuuuut… maybe not.\n\nFight fire with fire, bitch mode versus bitch mode. Do what you have to do to protect yourself and stand up with those who understand that staying with someone because you love them is more simple than deciding to leave. When you love someone and the relationship takes a turn for the better, well, it’s in one’s own benefit to stay.\n\nYou’re taking a stand, and proposing another firm example of abuse in relationships. Your humor breaks up the seriousness tone of this, but you are always appropriate. Keep up the great work.\n\nYou’re alleyway fight scene… it made me think of the segue-after-segue in High Fidelity:\n\nYes! I’m with you on fighting fire with fire! This whole thing was on the defense, I never went out looking for this mess, he brought it to my doorstep and he should have been prepared to accept that I’d fight back. And that High Fidelity clip is abso-freaking-lutely perfect. I haven’t seen that movie in years and I just watched it with a huge smile on my face because it basically describes my reality at the time haha.\n\nAnother amazing bit of the story. I think that somewhere between when you were being abused by the EX and when there was attempted abuse by the ATtorney, you learned how not to let someone screw with you. Good lesson, well learned. And surprisingly with no wrestling involved~\n\nThank you Elyse. Yeah… I feel like that kid in Slumdog Millionaire where all my various life experiences are all culminating for one purpose. It still amazes me that I let myself get into that situation in the first place but getting out of it and getting over it has definitely built me up for the better and taught me not to let anyone get away with anything like that ever again. And I mean, if I have to pull out my top-secret ex-con wrestling skills, so be it.\n\nEthics should never be treated as currency but they should always serve justice, and when they don’t they are either superfluous to requirements or up for grabs…nothing unethical about using or abusing ethics when one is focused on Goal #3. I’m off to see if I can find some way to get Liam Neeson to read your blog, you’ve hit “based on a true story” action/drama movie status and reckon he’d be impressed!\n\nI like your comment on ethics but I have to say I LOVE your mission to unite me with Liam Neeson. He has a new Liam Neeson-esque movie coming out soon and you have to know that I’m going to be first in line to see it. There are airplanes, bombs, and conspiracies. Gosh, I’m all over that like white on rice.\n\nLaw School 101: never ask a witness a question you don’t know the answer to already. It’s like you were cross-examined by Lionel Hutz…only without the charming &amp; intentional Phil Hartman-ish funny attached.\n\nI just moved into a new apartment. Last week the cops were called twice because of the violent fighting going on between the couple downstairs. Sunday evening, there was an officer standing outside my door monitoring the man moving out, per the woman’s demand. 12 hours later, he moved back in. Sadly, it makes sense, per the patterns/cycles of abusive relationships. They sound happy for a while…then, invariably, the screaming and cursing and violence resumes. After reading your blog, I envision her on a witness stand in the future, trying to explain to some twat of an attorney why she stayed.\n\nStaying after being hit is something I will never wrap my mind around. I accept that. Especially if the victim has viable options to go somewhere else. I think I witnessed my mother get beat up too many times as a kid and I decided early on that I didn’t want that for myself.\n\nYes! That’s exactly what my attorney said about questioning! She was like “that’s a great way to make yourself look like an idiot.” Bitch Lawyer was just dumb enough to believe I was as crazy and pathetic as he’d made me out to be.\n\nThat’s really upsetting about your neighbors :-/ It’s like the far more brutal version of people who are constantly in and out of facebook relationships. I still don’t exactly know how to explain why I myself stayed… but I would hope that the more we all talk about it, the more likely a woman would be to finally get up the courage to go.\n\nYou gotta love women who blame strong women for the shit other people do to them. Those are the kind of insinuations I’ve put up with from my family my whole life. And, I suspect, you too. Good training, I suppose. But how does that woman sleep at night?\n\nReminds me of a time my co-worker sued me for committing fraud with her corporate credit card. Good thing I had the email where she authorized me to book her a room. She didn’t show up, and forgot to cancel. Her card got hit with a cancellation fee and I guess that equaled fraud. She represented herself and referred to herself in the third person at the deposition. Her line of questioning went like this “is it true that you like to shop on your lunch break??” (LOL). Of course the case was dismissed. Smh.\n\nWOW. That sounds almost embarrassing. I’ll be the judge was face palming. She referred to herself in the third person? Someone needs to cancel her cable subscription and let her know that real life is not like TV.\n\nI’ll have to admit…she’d have me unraveled. I can’t stand when people attack you for being human. What the hell does being a strong confident woman ie: fearless…have to do with someone threatening you. I’m not afraid to walk down a dark alley by myself, but if some guy pulled out a knife and told me he would cut me, I’d be scared.\n\nExactly! That’s what my boyfriend kept saying afterwards! He was like… what the hell kind of point is that anyways?! To show that I’m not a coward and then to hear me say I’m afraid of him is like saying he has extra strength scary-ness.\n\nBeing attacked for being human was probably one of the most frustrating parts of this… but I just tried to keep in mind that anyone listening KNOWS how people are and she was just trying to knock me off balance so I would give her something, anything, to work with. It was exhausting.\n\nSo based on the last post and this one, you’re kind of intellectually terrifying. You’re ability to stone wall people and pick out information. That and you’re penchant for getting your hands on information you’re not supposed to have. You realize you’re not that far removed from being an amazing spy, right? 😉 I’ve never had to explain my flaws. They’re this weird undertone in the room whenever I’m around people I don’t want to be around. It screams “Leave me alone.” Except in public places. For whatever reason reading a book with a blank expression screams to strangers “Come talk to me!”\n\nHahahahahaha okay I love how you describe your flaws as a weird undertone in the room, I can totally feel that. I had the MOST awkward encounter with an acquaintance on my old college campus the other day… I mean… I was smiling and nodding but I’m pretty sure my body language was the equivalent of clawing at the walls to escape.\n\nAnd I will probably need to do a post soon about all the stupid things I do on a regular basis so that you guys don’t think I’m toooo intelligent. Because while I will admit I do have a knack for unraveling mysteries and acquiring forbidden info, I am also a little bit…. special at times. Like, super extra run into walls sort of special.\n\nYou’ve shown this “special”. Like when you were driving around the back woods 😛 But you have clutch and you make life interesting. When you have time, life is an adventure, when it comes down to the wire, you will slit throats. Metaphorically. I hope.\n\nHaha thank you Lucy! Oh, I can basically knock down buildings with my fists. Have you seen The Avengers? That entire movie is based off of my life, they just broke things up into multiple characters to make it more believable.\n\nYour timing was impeccable… I went grocery shopping today. I started your story while the kids and I had B&amp;J ice cream for desert. I just got them to bed and finished while munching on Doritos. Great ending!\n\nI’m surprised the judge let bitch-face go on like that. The judge usually tells a lawyer to stfu if she’s asking such dumb shit. Well, on tv anyway. That’s what your writing makes me think of… A tv series that I can’t wait to see the next episode of. I hope that doesn’t sound like I am making light of what you went through. Great job!\n\nYes, always happy to know that delicious snacks accompanied my story telling! And no– it doesn’t make light of it at all! It totally feels like a TV show. A TV show with stupid writers 😉 and you’re right about the judge– she totally shut her down multiple times. One of which I’ll be including in the next “Hooker” part …\n\nAmazing, as always. I just keep hanging on edge for the next installment. That being said, I hate the “victim game”. We tell ourselves we aren’t victims, but then we have to portray it to be taken seriously by not only court systems, but sometimes just people in general. Then they say we should be strong. But if you are too strong, or “fearless”, no one believes you. -facedesk-\n\nShe wasn’t the brightest lawyer was she? haha. She should have let well enough alone. Can’t wait for the next installment. As for your questions “:Have you ever had to defend some aspect of your personality as though it were a flaw? What’s the most absurd lie someone has told about you? Would you bend the rules of ethics if you knew it would help the right side win? ”\n\nYes I have had to defend my personality. I’m honest and blunt, seems to be a fault with mine according to my ex. My ex spread it about after I left him that I was having some kind of breakdown and I needed to be hospitalized. Dumb shit. I would most certainly and have bent the rules some to help me win. Hell yes!\n\nOh I know you bend rules, you rescuer of abused dogs! That is the exact sort of rule bending I love and respect! And who on earth can truly criticize being blunt and honest? It’s an incredibly useful trait, I would think. I tend not to be blunt except in certain situations but I work with a woman who is unbelievably blunt and direct. I admire her and try to learn from her how to handle a lot of situations I face.\n\nGreat post. Glad you give as good as you get; better actually. Nothing worse than having to defend yourself to people who you wouldn’t even let park your car or watch a pet fish, so to speak. You’re awesome.\n\nThat’s an excellent way of putting it, with the car parking and fish-sitting. It would be one thing if I felt like they had a right to be questioning me that way, or if they had some legit approach to the whole thing but the sheer lack of common sense made it all feel like such a circus. Thank you 🙂\n\nWoot! Woot! You rock Ninja Aussa! YeeHaw, reading these stories is like riding a gigantic roller-coaster, with each hill higher and each downward speed faster. Quite a ride. Well now, now that I’ve settled down and the adrenaline has subsided, I may have a clue for the Ninja – although your lawyer will likely know this anyway. The Sprint file you saw is likely in “CSV” format – Comma Separated Variables- the abbreviated explanation is that it considers all entries in alpha format, even numbers. It allows the handling and transfer of information between otherwise non-compatable systems. Most number-crunching systems recognise CSV and can use it as a bridge between otherwise incompatible platforms. You can Google it for more info and how to read a CSV file. I just realized that this story has already played out – so you already know if this is true or not. Sorry. Keep up the good work!\n\nWell Paul, you totally just made my brain hurt with that! Just kidding 😉 It ended up being a different format (thank goodness, because without your help I’m pretty sure that would have ruined me) and I was able to figure it out via some googling… but more on that later!!!!\n\nYeah, she is definitely not abiding by the unspoken rules of Girl World. And I said it in an earlier comment so I’ll just out myself again here but I totally like the c-word. I’m not sure this crazy biatch is even worthy of it though.\n\nAussa, you were the victim here. You did not do anything wrong in staying with him. You did not do anything wrong in taking nude photos. I am appalled by this lawyer. As a woman, how can she even pretend for one second to believe these terrible, victim blaming things? This is why I never became a lawyer.\n\nSeriously. Surely she CAN’T actually believe them, right? Who knows. But the fact that she had to employ some ignorant line of thought just to try and win her case is exactly why being a lawyer was not an option. I guess we both prefer to NOT line our pockets by damaging other people.\n\n“How did you get copies of these records?” “I right clicked and hit print.” Haha, well ask a stupid question, Miss Lawyer. I believe that yes she figured you’d be frightened or just ready to get out of there, therefore letting her client win because a lot of abuse victims probably do that. Encountering someone that strong probably did not enter her mind. Oops.\n\nI think you are totally right about her approach. I think she just didn’t even bother putting that much into the preparation because she assumed I would be weak and just as crazy as he made me sound. Woops for her!\n\nAnd… I’ve thought about it! I want to write a book about the psych ward… and if possible I would interlace this as the plot since it all took place at the same time and in the same place. Who knows, ah!\n\nI’m reading the court series of blogs out-loud to my husband, after I finished reading, he laughed and this is what he said:\n“Where was the lawyer even going with that? I mean, even if she proved that Aussa is fearless in the light of day, and wrestling convicts to the ground, that wouldn’t stop her from being afraid of what he’d do if he snuck up on her.\nNot being afraid of some things, even crazy things, like if crazy-rambler said she wrestled polar bears–come on you know he would say that if he thought they’d buy it–doesn’t mean you’re not afraid of other things. And being scared of what someone can do to you while you’re sleeping is a reasonable fear, especially when that person is crazy.”\n\nPerhaps you’d be amused to know he followed this by looking sideways at me, cracking a grin. — I’m sure I don’t know what he’s implying about me whatsoever.\n\nThanks for sharing this mix of crazy&amp;awesome Aussa, you absolutely rock! (And instigate much laughter at stupid-lawyer and crazy-exes expense. XD )\n\nEXACTLY! Your husband is so right! (PS totally cute that you read this out loud to him, and I am beyond flattered) My boyfriend said the same exact thing! Like… if I was this fearless ass kicking ninja that hitchhiked across war-torn Afghanistan but was still frightened of my ex doesn’t that mean he must have done something to scare the SHIZ out of me? Worst. Argument. Ever.\n\nHonestly, it’s just too good not to share… and I laugh too much for him not to get curious. haha\n\nNo kidding! Maybe she learned her tactics from TV lawyers too? She could totally apply to be part of the legal team at the hospital, as she’d clearly fit right in.\nBesides, if she really believed that are an indomitable ninja, or one woman para-trooper team, then she should have known better than to take you on. 😉\n\nYou’re boyfriend clearly could have stomped this lawyer in court. But he’d have to get in line because you were stomping her first.\n\nNoooooooooooo! I was so excited to see the new post, only to have my hopes that I would hear the end of the story dashed! Waiting for resolution is not one of my MANY talents (she says humbly). Seriously, I want to see that bitch and bastard get their asses handed to them!\n\nHahaha! So sorry Jana, I promise the ending is coming soon 😉 I’m just giving my origin story, you know? We are halfway through, all that remains is “hooker” and “spy.” Oh and a nice little cherry on top that I absolutely CANNOT wait to blog about/possibly illustrate. I’m cackling in anticipation over here, do you hear that?\n\nSeriously. She totally replaced him as the proxy for all his crazy. It’s one thing for him to be totally psycho, delusional, and hell bent on ruining my life but for a professional woman to sink to such lows? Good lord, she could have defended him and upheld his rights to representation and all that crap without playing so dirty.\n\nThis was my worst fear when I was gearing up for my court date. I admire your bravery in writing about all this. I was terrified of my intelligence and confidence being used against me to prove I could not have stayed with an abuser. This line of questioning is insulting and victim blaming. I don’t know how you went through all that. I would have stabbed that bitch in the eye with a pen. I am actually really infuriated by this. I cant wait for the conclusion!\n\nI think that a lot of women deal with that worry. It’s bad enough to be looking at your life and thinking “how the hell did I end up here, I thought I was smart?” but to have someone else take up that same argument and use it against you? It totally feels like you can’t win. Victim blaming absolutely happens and people need to be more aware of it so they can spot it and also see it in their own reactions and judgments. And oh girl, I could have done all sorts of things to her with a pen. Wait, did I just say that? Strike that from the record, please.\n\nShe sounds like a stand in they rolled in until a real lawyer could be found! Frightening to believe our lives might hang in the balance of numbskulls like that! Don’t know how you cope but I think I might LOSE IT just about now and go NINJA on her ass!!\n\nI should have wrestled her to the ground like an ex-con 😉 Luckily the judge didn’t seem nearly as stupid as Bitch Lawyer or my employer’s attorney who was probably sitting at her table trying to remember her cell phone password. Maybe they got a 2-for-1 Groupon on law degrees or something.\n\nYou unequivocally rock.\nIf I’m ever lucky enough to meet you, first round is on me.\n\nI don’t defend who I am, flaws and all. I just am. Fortunately, I don’t really listen (or care) what anyone other than my wife thinks of me, though I’ve never been in a situation like yours.\nAnd yeah, I would do ethically questionable thins if I thought I had to.\n\nAw, thank you! There needs to be a big blogger party where we can all get together and trade the unabridged versions of our stories!\n\nI like your take on not defending yourself, and that aspect of your personality definitely comes through on your blog and in the comments you read. It’s a much healthier way to live, that’s for damn sure. If anything, this whole set of experiences, from the trial to the shiz at work, has taught me to place very little importance on other people’s opinions.\n\nI don’t like mean stupid people who think they are smart. I gotta believe you come out on top of this one.\nYou’re putting this into a book, right?!?\nOn another note: “You have to fly them in from Kansas or some other random state (no offense, Kansas people)”\nNone taken, dear Aussa 🙂\nI’m eagerly waiting for the next installment!\n\nHahahaha! I knew there had to be more than a few Kansas people on here. I could think of two off hand, so now you make three 🙂 I like to justify my geography ignorance by considering about 2/3 of the states in this country to be “random”……\nAnd.. maybe a book! Who knows. It’s on the edge of thought… perhaps this Autumn, that’s when I’m hoping to start something new.\n\nJust seeing her frustrated face was enough for me, haha. When the boyfriend and I left, we were silent the whole way out– you have this odd feeling that your every move is scrutinized– but once we got to his car the first thing both of us said was something along the lines of “Woah, she just had a BAD day!”\n\nYou know, for us OCD and addictive personality types who have an intense “need to know” (which is why I avoid friends who are into planning me surprise parties or magicians who won’t share secrets!) your compelling blog could become all consuming, like crack. Just write a teeny little bit more tonight so I can read just a little more. But I swear I can quit any time….\n\nFrom my experience with attorneys the past couple of years, your ex’s attorney is a total dummy that needs to brush up on Women abuse issues and prepare better to serve her jack ass client. The timming on this post is perfect because I will be going through questionning on Wednesday by an attorney that’s exactly like your ex’s who rolls her eyes at my attorney. I don’t understand why they keep up the nasty fighting when it’s clear that their client is a thief or in your case a stalker. I guess they do it for the money. You’re so kick ass and it’s time for a slutty post next week, lol.. Hugs:)\n\nI wish there was a better way for our legal system to uphold justice without revictimization. You really do rock and it’s so impressive how you maintained your cool through all of that AND had the sense to look at those docs and find the pattern.\n\nTo answer your question, yes I’ve broken the rules many times as a social worker. Although I would say, I merely found a way to work the system to help a patient. Sometimes it’s just so hard to give a cold answer to someone in dire straights. If there was a way, I found it and gave it to them.\n\nI think it’s a testament to your humanity that you’re willing to stretch the rules for the sake of your clients. I know I’ve been in situations where I’ve been looking to someone for help and seen how they could so easily just do one small thing to help me but the system didn’t allow it. Beyond frustrating.\n\nAussa, you probably understand better than most that the other party’s attorney wit=ll do everything to twist your words, defame your character and all with an unctuous smile. Yes, I’ve been in a situation where I was on the stand and had to defend myself. I could cheerfully have laid them out and skinned them slowly and willingly served the punishment such was the extreme provocation. It’s been years and I still cannot go into the details of that time. It too almost a decade for me to enter a courthouse let alone a courtrooms and has sent me into the depths of despair. I refused to tell my family what was happening, so I was there alone and had no support – even my stupid barrister wasn’t really on my side. Coming from my background it was even ore traumatic – well it felt so to me, I know that if anything should happen to me the last person I would call is a police officer and that;s very sad. I would rather be beaten to a pulp and have them try to explain that away as my fault. no doun=bt they would try.\nSome scars do seem to linger far too long. I have hidden it well until something trigeres the memories. More fool me for reading.\nIt was an excellent post.\nSusan x\n\nOh Susan, I’m sorry that this brought up dark memories 🙁 Your experience sounds awful and I’m sorry that it ended in such a way that you hold a mistrust for the people who should be protecting and defending you. I wish it weren’t so but it does seem like quite a few people can relate to your experiences. To not have your family with you… has to be the hardest thing, I would think. That’s a good reminder to be a good enough friend or family member that our people always feel safe coming to us when this kind of shit starts flying.\nI hope you are doing well and that these memories don’t linger for long.\n\nMany thanks Aussa. In some ways it’s good to be reminded that others, far too many others go through very similar situations. It was my choice to ‘go it alone’ because i knew, only too well, the kind of tactics employed by solicitors and barristers,Q.C’s.. I had no wish to make anyone have to listen to spurious allegations so I didn’t ask. The horror of knowing the court was full was bad enough… the rest is a nightmare for another age, 🙂\nIt might have been totally different if I hadn’t been ill – car accident, thyroid cancer and the Lymes and Fibro. I think that was the hardest part. Beleaguered from the start lol. All is well.\nSusan x\n\nI always want to leave a comment on these posts, but honestly I’m always left speachless. I cannot wait for the next post! I wonder if that sad, bitch lawyer ever gets on a plane to go somewhere “dangerous” other than her own mind.\n\nReblogged this on The Frontal Lobe and commented:\nPart 2: Ninja. If you haven’t read Part 1: Hacker, then you need to visit her blog and read it first (or scroll down, I reblogged it when she first published it.) Frankly you should just follow her.\n\nGo Aussa! YES, I would bend the rules of ethics if it meant the right side would get a chance to win. Oftentimes, I adopt the thinking that karma will prevail and that in the end, the truth will be known. Except if I am in any sort of danger in which case anything goes when it comes to defending myself. Mr. Psycho chose the wrong Ninja to mess with! 🙂\n\nYeah! I knew I could count on you to be on the ethics-bending side of the debate 😉 I mostly think that karma wins out in the end and that the truth comes out but I like to think of myself as an agent within that process… just helping it along haha.\n\nAs I mentioned before, I was on a jury to decide whether or not a man was guilty of violating a restraining order. The closest I came to bending the rules, were that we found him guilty even though there was a reasonable doubt. It was apparent to all of us that the man was dangerous, despite the reasonable doubt. I can’t recall if they were in the same courtroom together, but I think they were brought in at different times.\n\nThat is a difficult position to be in, Lori. And I’m more the type to err on the side of trying to make the decision that will prevent someone from coming to harm… as opposed to upholding a legal standard or something. I feel like I deal with these sorts of conflicts at work sometimes on a far less serious basis, where I have to try and distance myself from a situation and make decisions on the basis of some overarching principle. Not my favorite sort of conundrum, that’s for sure.\n\nHaha! There were so many deadpan lines like that… I’ve been on the receiving end of someone who answers all questions as literally as possible and I know it can be super frustrating so I figured I’d give it a shot. Next part… coming soon!\n\nI really shouldn’t read your blog while I’m at work! I don’t know about a book but you could definitely have your own show…”The Life and Times of Aussa Lorens”..I can see it now.\nBut before that, we need the conclusion of your awesomeness!!\n\nHaha! You know…. I’m actually kind of scared to read my own blog at work because I don’t know what sorts of red flags it might send up in whatever system filters for things like porn, haha. According to my search results a lot of people seem to think I have something extra scandalous to offer when they visit…\n\nHaha! Perhaps, but I don’t think it’s the kind of attention you’ll want 😉 I imagine there are a few disappointed people out there who went online looking for “sexting pics” and came across my brutal tales haha.\n\nre “make it my fault that my abusive ex had sent my naked photos to our coworkers and gotten fired for it.”\n\nThis drives me absolutely crazy. I’m amazed at how we see the world through the eyes of the powerful– In this case the eyes of men. Women and men both learn to do this, too. The powerful–whether white, male, rich, or straight, have more access to media, writing laws, Etc. We need to try harder to see the world from all perspectives.\n\nInteresting, how people like her (and I use the term “people” loosely!), can lump together your ability as a fearless traveler, a strong administrator (wrestling or oreo-giving), and your calmness in the face of bullying-lawyer tactics, as somehow translating into also meaning you couldn’t possibly be fearful of a wack-job ex who scares even me, even from a distance, both physically and psychologically–And I consider myself the kind of woman who would take his brand of BS by treating him to a strong left roundhouse with a frying pan to the head…\n\nI have so many things I could think of to say to her, but they all translate to basically– argh! Gotta hand it to you for staying calm on the stand!!\n\nIf I was a judge, I would have SUCH a hard time listening to badgering like this!\n\nRight?! Like… when did it become a BAD thing to be a generally bold person? Like… if you claim to have confidence or a sense of adventure then suuuurrrreeeely no one could ever intimidate or frighten you? Right. I’m sure she thinks of herself as an intelligent, confident, and successful woman but I’m pretty sure I could come up with a way to scare the bejeesus out of her….\n\nHAHAHA Right? Maybe she had the hotts for him and was taking it out on me and trying to score points in the courtroom so she could score points in the bedroom, wapow! Talk about bending ethical rules, yuck.\n\nMy first roommate in college was a SWF experience, wherein she told all the girls in the hall that she was sleeping with my boyfriend. She’d also told them that some of my clothes and accolades were hers, while saying some of her shortfalls were mine. I didn’t know any of this until she left mid-October. She dropped out to go home, to live with her 30-year-old married boyfriend, who was her boss at Chuck E. Cheese.\nShe was obsessed with me, and had the strangest way of showing it. Had I not been 18, and still naive, I don’t think I could slept in the same room. Looking back, I don’t know how I managed.\nShe copied me in every possible way, and she lied about me daily. Eek!\n\nWhaaaat the hell???? Joey this is a WEIRD story. Like, possibly a short story that ought to be written out. She was basically trying to assume your identity and did everything short of making a skin suit out of you while you were sleeping. That is super messed up!\n\nI have to say that this post hit me in the gut for two reasons. One, I was married to an abusive man (for too long) and because we had children together have had to deal with his convoluted thinking and behavior (and watch my kids deal with it because the courts DO NOT protect children) for years.\n\nTwo, my sister was married to the ultimate winner (by the way, I have no idea why we both picked POS’s because our Dad was a rockstar husband and father, but extensive counseling allowed me to stop feeling unworthy and to be able to find a good man…but I digress). My sister’s ex is a pedophile. She kicked him out and later found the evidence in her home. She turned it all in to the police and everyone, EVERYONE, was flabbergasted that nothing happened. No arrest. Nothing. I spoke to the Georgian (USA) branch of the FBI personally and they essentially told me they didn’t have time for him because there were men out there actively killing children and until we could prove he’d physically hurt someone then he’d be on the back burner. Never mind that he’d stalked neighbor girls, had photos of students on middle school and high school campuses, and that he’d attempted to kidnap his daughter (who was his “preferred” age at the time – 10 years old). Oh and never mind the death threats, putting dead animals on my sister’s car, or paying people to break into her house in the middle of the night…I could go on. Basically, this spectacular human being is still out there and, unfortunately, is wealthy. This means he can pay attorneys to continually harass my sister. In her divorce trial she was accused of all sorts of things. Eventually (because she’d been harassed and beaten down for years) she gave up every single penny to secure supervised visitation for her children.\n\nSo you don’t let that douchebag of an abusive husband and his lawyer get a thing or have you question you are the victim and he is the monster. Monster’s love to make you feel like it was somehow your fault. I no longer feel that way, but I watch my sister (seven plus years later) still kicking herself and feeling like it is all her responsibility.\n\nWhew. Hey thanks for letting me get that out!\nAll my best and kick butt in court!\n\nOh my gosh, Chantel. I feel like I relate to so much of what you said, even just outside of the story I’m currently blogging. Dang. What you said about feeling unworthy– I had an incredibly hard time with that… and it’s so difficult to fully explain once you’re on the other side of it but when you’re in the middle of it… it’s like being at the bottom of a well.\n\nI can’t believe all of that about your sister’s ex. That is disgusting. But sadly believable– I had a similar situation with my dad and the police didn’t want to bother with it despite their being evidence.\n\nWhat you said about him paying people to break into her home and leave dead animals on her car though…. gave me chills. Is that really a thing that other people go through? Because something like this happened to me in college and we could never figure out what was happening. I haven’t even figured out how to blog about it yet but it went on for YEARS. Terrifying years of my life.\n\nGosh, such awful things that people do to each other sometimes :-/ I’m glad that you and your sister have gotten away from these men though. That’s a hard won victory but not one to ever be taken lightly.\n\nThanks so much for coming over to here from Michelle’s blog– she’s awesome!!\n\nMore? This went on even longer? I mean, as a reader, I’m thrilled, but OMG WHAT A CLUSTERFUCK OF MADNESS! (Is clusterfuck one word or two? These are my problems.)\nHer logic was SO hypocritical. What a cold turd of a woman. How can she say that shit and sleep at night?\nIdiots. The system is full of idiots. She seemed pretty “confident”. Maybe your ex should harass her next.\n\nI am of the opinion that clusterfuck is one word, but WordPress seems to disagree. What does it know anyway??? And oh yes, it keeps going. Just a bit more and then we can all party when it’s over and burn sage so that it never comes back.\n\nAnd I would imagine that he probably turned into a nightmare for her in the long run. I mean… I can only speculate but I doubt it ended well…\n\nThis bit made me laugh so much – I was prepared to let my eyes shrivel up like raisins and fall out of my face before I’d lose to this biatch – and it’s quite something that this made me laugh because I’m really squeamish about eye things so this should have made me freak out and yet it didn’t! Ha! Absurd lies someone has told about me, ah yes…\n\nHahahaha I know it doesn’t mean anything but I PROMISE it’s all true. I have an incredible fear of anyone ever calling me a liar so I resist the urge to hyperbolize even when it would make a story all the sweeter. I am thinking I may do a Q&amp;A post down the line and (get tipsy) with Sars or my boyfriend and have them record a vlog with me to corroborate the fact I’m not making all of this up 😉\n\nAnd! Yes, lawyers are evil. Oops 😉 No– I take it back. Betsy was kick ass so I guess lawyers are just people… half evil, half good.\n\nI’ve always wanted to write a book. I assumed I’d be all for fiction… but then my life got incredibly ridiculous so all the real writing I’ve ever done is the telling of these sorts of stories. I’d like to write a couple memoiry type books (damn, sounds so self-absorbed, doesn’t it?) and then try my hand at fiction… I have stories in my mind but am unsure of whether I’ve got the skill to tell them. It would certainly be an adventure.\n\nI find fiction is a matter of transporting yourself into a person that is not you but that is you. I think you have the chops, certainly, so it’s just a matter of putting a few words down and trying. I would just highly encourage not writing in first person at first, as I find that generally leads back to blogging. Third person really challenges you to find a different voice, though oddly enough it’s the first-person stories I like the best. Give er a shot, I’ll certainly read.\n\nWriting a character that is NOT me sounds challenging and yet so intriguing… when I read a book written by someone with very little (at least demographically, on the surface) in common with their Main Character, I’m beyond impressed.\n\nI like to challenge myself to write from the perspective of people who have nothing to do with me. I think I’m most comfortable there. Writing about myself has always been difficult, and I just adore fiction and stories.\n\nGod, I hope so. I keep hoping that by the time I was done with him he finally learned his lesson but this pattern goes back so far it’s almost kind of hard to believe he could stop… at the very least maybe I got a smidgen of justice for those who didn’t stand up to him in the past.\n\nYou are awesome!!! Can’t wait for part three! The worst lie – my ex-narcissist at one point claimed that I was hiding gold coins in a bank vault in the Caymans … he really could be delusional at times!\n\nI cannot WAIT until the next installment!! Yes, people sure are special… What a maroon! LMAO.\nI had to once defend ALL aspects of my personality – I told a psycho ex-Greek that if he didn’t like the bajillion things he constantly complained about, then he shouldn’t see me anymore. Not that easy – though obviously below his standards, I could look forward to hundreds of “I know you’re home; I see your lights on!” messages on my answering machine every time I had company over or stayed home from work.\n\nOh my gosh, that is beyond creepy. For a guy to mistreat you and then go all crazy stalker when you leave him? I’ll never understand how that makes sense. Telling you he was outside your house is not okay. I’ve had a couple guys who were like that… it kind of makes you wonder how many have done the park-outside-your-house thing without telling you about it. *shudders*\n\nHave you ever had to defend some aspect of your personality as though it were a flaw? Yes.\nWhat’s the most absurd lie someone has told about you? I was loose. I hit her.\nWould you bend the rules of ethics if you knew it would help the right side win? Hell, yes.\nBTW – How in the world do you find time to write, respond to these comments and drop by my site? I am in awe.\nAlso – What a dick.\n\nI want to say this in the least awkward way possible but I don’t find it surprising that you’ve had to defend your personality– you obviously have a kick ass and off-beat approach to life. I admire it, you don’t even know.\n\nI’ve never just outright hit anyone in the face…. maybe someday hahahahaha\n\nAs for time… who knows! I wish I was able to read more blogs more frequently but I try to keep in touch with people as often as possible. I don’t have a TV so you guys are all I have for entertainment 😉\n\nOff beat? Moi? I come by it honestly. Have you met my parents?:)\nI didn’t hit her in the face… Yes. There. With my foot.\nWe have Spanish TV. I suggested we keep it on and try to learn from their soaps. TV is off now.\n\nHaha! I’ll admit, the cliffhangers are a bit fun…but they’re also my way of being like “and guess what, this shiz doesn’t end there!” I hope you brought a tent for your sit in, it’s about to get cold roundabouts here, brrrrr!\n\nWay to keep your eye on the prize — I am so proud of you! The best revenge you can get on her is to make her feel the way she is trying to make you feel — stupid, unprepared, and unreliable — and you did just that.\n\nAussa, like everyone else, I am hooked and can’t wait to hear the rest of the story…\n\nAnd this lawyer, she exceeds the stereotypical slimy lawyer jokes, but how she can do this crap to another woman, I just don’t understand. There is not enough money in the world to defend this douchebag.\n\nI am eager to hear how this ends! But I can just see and hear you holding to your story and watching the attorney squirm. My son is an attorney, and I’m not against all attorneys, but sometimes I am simply frustrated with our legal system. In my perfect world it would be about getting to the truth, and much less a game of wits. I think I could lie (if I wouldn’t get caught, ha) to advance a just cause. I admire your strength, Aussa. You’re pretty great…hope this story ends well for you!\n\nThank you! And… it will be over soon enough. At least, this part of it 😉 I don’t have a negative opinion of all attorneys either, though– like you– the entire system makes me a bit uncomfortable as well, especially when it comes down to strategy and not justice.\n\nHaha! FA REAL. I have said many a time that I am living some sort of low budget Lifetime movie where they just keep recycling the same worn out plots but with new faces and random twists here and there 😉 And weirdly enough I just found out tonight that the boyfriend HATES Julia Roberts. He can’t even give a proper explanation, just loathes her. Who loathes Julia Roberts? Hmm.\n\nI just realize the defense’s line of questioning just confirms that your ex is a crazy fucker. If you are fearless and dated a potentially dangerous person that just validates that he is a crazy fucker and you are fearless. It doesnt prove anything else. Why was the judge allowing this line of questioning? Maybe thr judge realized what a loon she is. Educated woman? How can that be debasing? By being an educatee woman she is defending this fuck isnt she? Fucking annoyance.\n\nOh yeah sometimes “ethics” made a law of state is an idiotic crapshoot. So unfortunately you have to bend them a bit.\n\nPeople usually call me immature, stupid, talentless and crazy so I know how you feel.\n\nI KNOW! That’s what sort of blew my mind about that entire approach… like… what does it prove, even if I’m some sort of ass-kicking macho woman? That he is scary enough to frighten an ass-kicking macho woman? Not really helping their case there.\n\nThe whole thing was a circus and the judge only stopped it a handful of times… I think that she was aware of the fact that regardless of her ruling it was going to be appealed so she wanted to allow as much evidence and questioning in as possible, to have her own back. Not sure– that’s just what some lawyer friends have suggested might have been going on.\n\nSorry people have called you such things– I don’t know why anyone feels it is okay to make such statements about another person. They really ought to turn all that focus and energy back around on themselves and leave the rest of us alone.\n\nYeah, I can’t stand malice. When someone crosses over to behavior that is intended to harm another person… it activates the rage center of my brain. The exhibit thing was probably the funniest thing ever. I was all doe-eyed and innocent acting, like “but you just told me to…?” I think the judge may have actually pulled the glasses from her face and tossed them on the desk in front of her.\n\nAs you said: HOW had she made it through law school when she always seems to use such illogical thought patterns? But you played your part well by being as unhelpful as possible and not losing your cool. But I just can’t even imagine a lawyer using your propensity to travel alone as a single woman as some sort of ammunition for your psycho ex being innocent. Disgusting.\n\nOh and I laughed out loud at the claims that you had actually wrested “ex-cons” to the ground. Hahaha you ninja, you! Seriously, how could a lawyer seriously believe that, considering your position in the company and considering all sorts of other things like hospital protocol and such. Wow!!\n\nI mean, I TOTALLY would have wrestled ex-cons to the ground if it weren’t for hospital protocol of course. Riiiight…\nIf I could have spoken freely I probably would have started by saying “hey look, I’m sorry you’ve never even had the guts to fill out a passport application…”\n\nThank you. Again, I have to say that I’ve been grumpy and self-pitying plenty of times along the way but yeah… for the most part I feel pretty cheerful haha. I think that as long as you don’t do things that you’ll regret (lie, hurt people, seek revenge) you can weather these darker times and come out okay in the end if you fight for your happiness.\n\nHey Aussa, It’s still there. It’s weird. I didn’t know you lived in Compton. LOL.\nApparently this product worked wonders for you. At least it is a good picture and complimentary to and of you….If MY picture got stolen, it’d be used in a “DON’T DRESS LIKE THIS” or “Bad hair day EVERYDAY” blog or something…I’d be the “before” a make over pic…the internet CAN be a creepy strange place…..\n\nAh I totally forgot about this and need to harass them some more. Or perhaps write a post about it 😉 So funny. I went in to work and announced it to my coworkers and they started dying because I’m mildly notorious for saying things like “I’m going to start eating healthier on Monday, except I’m not give up alcohol or icecream and I don’t really want to restrict myself at all.” Hmm… right.\n\n“Aussa Lorens is an expert document forger and professional wrestler who is afraid of nothing. Her hobbies include devising elaborate ruses to prove family members are gay and backpacking across dangerous countries even though the State Department told her not to.”\n\nGirl, you are so good ; )You definitely captured that catch-22 that women in abusive relationships find themselves in: not wanting to be the victim but having to be the victim. It’s set up so you can’t win for losing, unless you have an enlightened judge and astute lawyer. I almost feel sorry for the Bitch Lawyer … what a pathetic way to make a living.\n\nHey Daniel! Thanks for coming over from Carrie’s, she’s pretty awesome, that one. And– right? That was one of those glorious moments that I couldn’t have planned but that just sort of fell into my lap, like the universe was saying “yes, have fun with this one.”\n\nThe fact that your ass clown of an ex found an ass clown of a lawyer is astounding. I cannot wait to read how you verbally take this Bitch Lawyer down. I’m reminded daily by a new co-worker (who is all of ten days old at our company) just how loud my voice is and how it carries over every other sound in the office. Which of course, makes me scream into my phone and at everyone who comes into my office for a chat.\n\nOkay you’ve given me a sudden new theory– maybe they were related?! Seriously, hmm….. maybe he was so broke that he had to hire one of his sisters. I know that he had like 7 sisters (not even exaggerating) and that at least one was a lawyer. HMMMM I should google that biatch. Because it would explain why she was such equal parts crazy and so willing to buy into all of his BS.\n\nThat’s awkward about your new coworker– you should remind him/her that new people are only meant to be seen and not heard and that their opinions are not welcome.\n\nSee, I’ve actually been on the witness stand and have been cross examined (and it has nothing to do with that body buried in my back yard!) and I would have twisted that poor woman’s head around like a pretzel. For example, when she uses phrases like, “…for almost a year?” That’s an open invitation! It would have gone something like this:\n\n“What do you mean, for almost a year?”\n\n“I mean, for the duration of the [blah blah blah]” (etc.)\n\n“Well do you mean MORE than a year or less?”\n\n[She would have scurried around trying to explain.]\n\n“By ‘almost’ do you mean it was close to being an actual ‘year’ or some other thing or object? Like a car? Or a towel?”\n\nAnd this would have gone on for a loooooong time!\n\nAlso, you’re allowed to “not answer” by saying things like, “I believe that is subjective. Each person is different as is every situation, so asking if I’m intimidated by ‘you’ is irrelevant because I do not know you and you were not there at the time of what is in question.” You know…stuff like that .;0)\n\nJesus H. Christ! What the f**??? I feel I’m starting all my comments on your case this way 🙂\n\nYour crazy-ass ex and his crazy-ass lawyer deserve each other. This just goes to show that you can get anyone you take a legal case, no matter how absurd it is. Did she really just take her client’s word for everything and not bother to do her homework? What an idiot! Name and shame her!!\n\nYes! I actually thought of you when it happened, I was like “well, it finally happened, like she said…” It was a post I did just before Christmas called “How To Pass Time At Work.” Of course they FP one of my shallowest posts ever 😉\n\n“Excuse me m’am, but you are fearless and smart, therefore my client must be innocent” has got to be the most asinine line of defense to date, but it sure is entertaining!\n\nAs far taking pictures of the Sprint records: Good for you. No one’s going to save your ass better than you; it’s just the way it is. And if you’re fearless and smart enough to ensure that, someone else’s arbitrary “ethics” can take a brief vacation.\n\nI have been reading your blog instead of watching the TV during breakfast for the past couple days. I have to say, its a lot of fun.\nYou have gone through so much shit in life, and the fact that you haven’t broken down completely and used it for your advantage instead, really speaks volumes about your personality.\nlove the boss ass bitch attitude!\nKeep writing!\n\nThe very first sentence of this comment gives me absolute warm fuzzies, I love it. I’ve replaced your morning TV routine, that feels like an accomplishment! Thanks so much for the kind words and I’ll try to keep it up 😉\n\nI noticed that you started following me on Twitter….Thank You! So I’ve been poking around your blog and ran into this story which I’m slowly working my way though. And, OMG…I can so relate on so many levels. I won’t go into it all, because you have so nailed it. So few people experience something like this (well, I hope that’s the case)…that it is really hard for other people to understand that weird psycho/stalker energy thing that happens. So many people don’t believe you, and that even makes you more of a victim.\n\nThank you so much for writing your story out. I’m so sorry you had to go through all of that. Argh. I’ve been through something very similar twice, so I relate.\n\nI wonder if ridiculous questions are compulsory. When I went to court I was accused of going to visit my rapist in his place of work “in various disguises”. I had to try not to laugh when I imagined myself channelling Mr Benn. That’s not even considering the fact that when this supposed stalking was going on I was actually detained under the mental health act which would have made it difficult. Another favourite ridiculous “suggestion” was that I had photos on my phone of my sisters taking cocaine and had shown him the pictures. My answer was “My younger sister would have been nine at the time. I’m pretty sure my nine year old sister was not taking drugs. My older sister also doesn’t take drugs but even if she did she would not do it in the presence of her 16 year old sister and I would not take photos of her breaking the law. I didn’t even have a camera phone back then”. When lawyers are coming out with such stupid things it is a sign they have no actual case and they are just grasping at straws to try discredit the victim/witness. Unfortunately in my case the jury were too stupid to understand the evidence and the law is weighted in favour of the defendent (often rightly, their freedom is at risk). I’m pretty sure they would have seen things differently if the fact he had skipped bail and then been found buying drugs (in an area which his bail conditions prohibited him from visiting) had been admissible. Also not turning up to court on the last day until the police started ringing all his family and then claiming he forgot which bus to get on (but remembered for the four days previously…) wouldn’t have looked too good to the jury if they had been allowed to know that. Ugh, yes I’m still pretty angry at the “justice system”. I sometimes think about writing to his barrister and letting him know how some of the things he “suggested” affected me but what with him being a lawyer that probably isn’t too wise lest I get accused of harassment.\n\nUgh, I would almost say to write the letter. How frustrating. Though I suppose it’s the damned judicial system. Having that sort of information held back from a jury is so frustrating… I’ve read the arguments for why that makes sense and is “right” but it certainly doesn’t always feel right. I’m glad that I didn’t know any of that and just kept blurting things out in the courtroom where the judge couldn’t un-hear them.\n\nThat’s so crazy about the little sister drugs and cell phone thing. RIDICULOUS.\n\nI would have slipped certain things in when I was on the stand but I’d be warned I would be in contempt of court and they would have to start all over again with a new jury so it wasn’t really in my best interests. I may well write that letter one day but I will check with my lawyer friends that I am not going to get into trouble first!\n\nHello, you totally wonderful hum@n being. I have been in court today, as witness for a tri@l ag@inst my ex fiance, who repeatedly @ss@ulted me. I found your blog above before I went to court… apologies for my “a”s… hve spilt ch@mpgne on my keybord… my ex was found guilty on all three counts of @ss@ult… job done… and throughout I kept repeating in my he@d… keep shit together… be as unhelpful @s possible..(! love this!) nd fin@lly, destroy him. I did. I won. Thnx for your inspirtion@l, witty, honest blog… bless you xxxxxxx\n\nI am so glad you won in court, huzzah! Congrats! And I’m sorry your keyboard is busted, though the fact that you spilled champagne on it is rather epic. Seriously, thank you so much for leaving this comment and I’m glad you were as unhelpful as possible– kick ass!\n\nTrackbacks\n\n[…] I was back on the stand. Several other witnesses had testified since I’d been there but I had no way of knowing what they’d said. If I was as much of a Hacker Ninja as they claimed, then I would have returned in the night to bug the place. But alas, I was too busy assuaging my anger with violent Zombie shows and multiple episodes of Revenge—a show about a girl whom I’m pretty sure my ex’s entire legal defense was based upon. […]\n\n[…] in the darkness and to give myself permission to laugh. Because honestly, what’s not funny about an attorney trying to convince a courtroom that I deserved to be abused simply because I have red ha… Tell me it’s not a little funny that I plunged an entire room into awkward silence by talking […]\n\n[…] no idea I was so damn scandalous. I’d apparently managed to sleep with half the hospital, rescue our patients from violent ex-cons, and hack into all sorts of secure databases. I had kicked so much arse that I was starting to […]&quot;},
       {&#39;text&#39;: &#39;EXCLUSIVE\n\nDonald Trump is taking his beef with ESPN to the masses -- he\&#39;s launched a petition to try and get the &quot;spineless&quot; network to play the national anthem during the &quot;Monday Night Football&quot; broadcast.\n\nESPN president Jimmy Pitaro had said last week that &quot;We generally have not broadcasted the anthem and I don\&#39;t think that will change this year.&quot;\n\nTrump was PISSED and sent an email to his supporters announcing that he\&#39;s started a petition to get &quot;The Star-Spangled Banner&quot; on TV.\n\n&quot;Just after we heard a sitting governor trash America, ESPN has now decided it will no longer play the National Anthem before Monday Night Football,&quot; the email from Trump said. The governor referred to is NY Gov. Andrew Cuomo ... who made headlines last week for saying America &quot;was never that great.&quot;\n\nTrump\&#39;s email continues ... &quot;If \&#39;America\&#39; is too offensive for anyone in our country, then what are they doing in America?&quot;\n\n&quot;I’m calling on you to join me in denouncing this SPINELESS surrender to the politically correct liberal mob. I was the first person to sign this petition. Now I need you to follow my lead and be the second.&quot;\n\nTrump began railing against ESPN at Tuesday\&#39;s rally in West Virginia -- where he told the crowd, &quot;It was just announced by ESPN that rather than defending our anthem, our beautiful, beautiful national anthem and defending our flag, they just won\&#39;t broadcast when they play the national anthem.&quot;\n\n&quot;We don\&#39;t like that,&quot; Trump added.\n\nPlay video content Fox News\n\n&quot;So, while the players are kneeling, some of them not all of them at all, you\&#39;re all proudly standing for our national anthem.&quot;&#39;},
       {&#39;text&#39;: &#39;If you own a parrot, you may owe it an apology. “Bird-brained” isn’t an insult: although a bird’s brain may seem diminutive, its small size only makes its mental capacities more impressive.\n\nScientists have known for some time that birds are capable of complex cognition—as tool-making crows and discriminating pigeons reveal. The question was how nature had gotten all that neural hardwiring into such a small package. Research published this month in the Proceedings of the National Academy of Sciences offers a new explanation: bird brains pack neurons more densely than those of other animals.\n\nFor a long time, the prevailing idea was that brain size most directly determined an animal’s intelligence and that neuron density didn’t vary much across species. In the last ten to twenty years that perception has changed, especially in mammalian brains where differences in neuronal density have been observed. Bird brains are so small that they clearly require some structural difference to allow them to carry out complex cognition in a compact space, but until now it wasn’t clear precisely how they differed.\n\nThe new study comes out of an international collaboration between universities in Prague, Vienna, Rio de Janeiro and Sao Paulo, and is the first to quantify the neurons in the avian brain. To do so, the researchers took samples from 28 different species and dissected them into anatomical sections. They then made homogeneous suspensions from each section, stained the nuclei, and divided each into tiny individual samples of suspended cells. These smaller samples each contain approximately the same number of cells, making it relatively easy to quickly and accurately count neurons. Using this method, an entire avian brain can be processed in one day in contrast to the old fashioned approach, which was much more labor- and time-intensive. (Historically, neuroanatomists had to cut very thin sections of the brain, staining them to show individual cells and counting every cell by hand. Across an entire brain, this method required a huge amount of time and had a high risk for human error.)\n\nAlthough many in the field expected the bird brain could be densely packed, the extent came as a surprise to the study authors. “My expectation was simply that bird brains should be different from mammals in size and number of neurons,” says neuroscientist Suzana Herculano-Houzel, now at Vanderbilt University, one of the senior authors on the paper. “But we didn’t have any idea that the difference would be so extreme that in a parrot brain you would have as many neurons as in a mid-size primate.”\n\nPrevious research on bird intelligence in songbirds and parrots—birds with impressive vocal capabilities—has shown that there are particular pathways in bird brains that enable this complex cognition. But these pathways are made up of millions of neurons, which seemed impossible for such small brains to accomodate. “[It seemed like] there must be something that’s lost to make space for this pathway,” says neurobiologist Erich Jarvis at the Howard Hughes Medical Institute, who studies these neural pathways and did not participate in the new research. “This paper gives me an explanation: these birds didn’t lose neurons for another trait, they just packed things into a tighter space.”\n\nFor the Birds?\n\nThe findings by Herculano-Houzel and her colleagues are just part of a larger effort to better understand bird brain anatomy and intelligence. Until the mid-twentieth century many scientists held the bias that birds were incapable of advanced cognition.\n\nIn fact, even the names given to bird neuroanatomy signal their perceived simplicity. A century ago, neurobiologist Ludwig Edinger compared the neuroanatomies of various animals so that he could assemble a more cohesive view of how their brains evolved. But Edinger’s understanding of evolution wasn’t accurate; he believed that evolution happened linearly in time and space. He thought that primitive areas of the brain must be at one edge of the brain and over time the more complex parts developed in layers on top of each other.\n\nBird brains have a very different structure from most other intelligent animals, which led Edinger to think that they must not be as smart as mammals. So when he went about naming bird brain structures, he gave them names like “paleostriatum” meaning “old striatum,” referring to a fairly primitive area involved in instinctual behaviors and basic motor coordination. He assumed that the brain had evolved from the striatum. But in fact, we now know it evolved from the pallium, an area that carries out reasoning and planning.\n\nIn 2005 an international group of experts argued in Nature Reviews Neuroscience that the derogatory nomenclature was hindering scientific advances because it inaccurately reflected the brain’s sophistication. Their plea ultimately led to new terminology for use in the research community. This change reflects a modern, nuanced view of bird evolution to which Herculano-Houzel hopes her work contributes. She and her colleagues chose to study a variety of species so that they could “get a glimpse into evolution,” she explains. “The idea is that if you understand what changes and what doesn’t change between modern species, then you could do the detective work to figure out what the first bird brains were made of.”\n\nThere’s still work to be done to prove that these densely packed neurons are directly impacting intelligence, says Jarvis. Nonetheless, he finds the new work impressive: “I hesitate to use the word breakthrough, but I think it’s a conceptual breakthrough.”&#39;}],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformer_lens</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">ActivationCache</span><span class="p">,</span> <span class="n">HookedTransformer</span><span class="p">,</span> <span class="n">HookedTransformerConfig</span>
<span class="kn">from</span> <span class="nn">transformer_lens.hook_points</span> <span class="kn">import</span> <span class="n">HookPoint</span>

<span class="c1"># cfg = HookedTransformerConfig(</span>
<span class="c1">#     d_model=128,</span>
<span class="c1">#     act_fn=&#39;relu&#39;,</span>
<span class="c1">#     n_layers=1,</span>
<span class="c1">#     d_mlp=512,</span>
<span class="c1"># )</span>
<span class="n">gelu_model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;gelu-1l&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded pretrained model gelu-1l into HookedTransformer
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gelu_model</span><span class="o">.</span><span class="n">cfg</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">HookedTransformerConfig</span><span class="p">(</span>
    <span class="n">n_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">d_model</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">n_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">d_head</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">n_ctx</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
    <span class="n">tokenizer_name</span><span class="o">=</span><span class="s1">&#39;EleutherAI/gpt-neox-20b&#39;</span><span class="p">,</span>
    <span class="n">act_fn</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5324,
 36,
 434,
 657,
 422,
 1294,
 48691,
 310,
 2130,
 281,
 638,
 14,
 2621,
 323,
 370,
 24,
 1525,
 187,
 187,
 1231,
 1849,
 2326,
 9828,
 273,
 2325,
 1832,
 14,
 34821,
 611,
 3027,
 13139,
 275,
 776,
 673,
 13,
 690,
 1805,
 685,
 2571,
 15,
 29578,
 13,
 2299,
 13,
 1132,
 3240,
 594,
 3587,
 327,
 253,
 1416,
 347,
 42321,
 23751,
 434,
 2325,
 1507,
 15,
 1198,
 370,
 1099,
 13,
 18943,
 1336,
 755,
 247,
 873,
 273,
 40613,
 326,
 8800,
 1652,
 1480,
 36199,
 281,
 3196,
 15,
 49529,
 434,
 9797,
 12317,
 273,
 4327,
 13,
 533,
 403,
 642,
 5545,
 3033,
 281,
 21097,
 3858,
 1969,
 387,
 1878,
 13,
 598,
 1919,
 597,
 923,
 247,
 5230,
 21436,
 18479,
 3185,
 273,
 247,
 2406,
 14,
 5045,
 378,
 15,
 11239,
 2920,
 13,
 627,
 434,
 625,
 281,
 352,
 685,
 816,
 38420,
 285,
 21643,
 21736,
 15,
 6000,
 7471,
 588,
 1421,
 281,
 247,
 23672,
 273,
 45364,
 320,
 1507,
 313,
 5371,
 2010,
 14677,
 281,
 253,
 6347,
 3972,
 5410,
 11431,
 6022,
 273,
 21491,
 3928,
 15,
 1198,
 441,
 13,
 326,
 434,
 1921,
 2217,
 281,
 3524,
 326,
 2325,
 1832,
 2506,
 626,
 1691,
 253,
 465,
 487,
 6934,
 327,
 42321,
 23751,
 434,
 3434,
 15,
 15222,
 13,
 359,
 812,
 897,
 690,
 10353,
 2092,
 323,
 776,
 2325,
 292,
 7536,
 15]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">DataCollatorWithPadding</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
<span class="k">def</span> <span class="nf">tokenize_function</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;input_ids&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]}</span>


<span class="n">tokenized_dataset_train</span> <span class="o">=</span> <span class="n">small_dataset_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tokenized_dataset_test</span> <span class="o">=</span> <span class="n">small_dataset_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data_collator</span> <span class="o">=</span> <span class="n">DataCollatorWithPadding</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">9</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">res</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;input_ids&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]}</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="n">tokenized_dataset_train</span> <span class="o">=</span> <span class="n">small_dataset_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">tokenized_dataset_test</span> <span class="o">=</span> <span class="n">small_dataset_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DataCollatorWithPadding</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;small_dataset_train&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer</span><span class="p">(</span><span class="s1">&#39;helloooooo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;input_ids&#39;: [14440, 33363, 3288], &#39;attention_mask&#39;: [1, 1, 1]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tokenized_dataset_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset({
    features: [&#39;text&#39;, &#39;input_ids&#39;],
    num_rows: 10000
})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># collator = DataCollatorWithPadding(tokenizer=model.tokenizer)</span>
<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> 
                                  <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                  <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                  <span class="n">report_to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">training_args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
    <span class="c1"># data_collator=collator,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moving model to device:  mps
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/dani/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/accelerate/accelerator.py:432: FutureWarning: Passing the following arguments to `Accelerator` is deprecated and will be removed in version 1.0 of Accelerate: dict_keys([&#39;dispatch_batches&#39;, &#39;split_batches&#39;, &#39;even_batches&#39;, &#39;use_seedable_sampler&#39;]). Please pass an `accelerate.DataLoaderConfiguration` instead: 
dataloader_config = DataLoaderConfiguration(dispatch_batches=None, split_batches=False, even_batches=True, use_seedable_sampler=True)
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moving model to device:  mps
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6430f89b1b674ed9baae5b6a2dd787ae", "version_major": 2, "version_minor": 0}</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">IndexError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/trainer.py:1780,</span> in <span class="ni">Trainer.train</span><span class="nt">(self, resume_from_checkpoint, trial, ignore_keys_for_eval, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1778</span>         <span class="n">hf_hub_utils</span><span class="o">.</span><span class="n">enable_progress_bars</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1779</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1780</span>     <span class="k">return</span> <span class="n">inner_training_loop</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1781</span>         <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span>         <span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="n">resume_from_checkpoint</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1783</span>         <span class="n">trial</span><span class="o">=</span><span class="n">trial</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1784</span>         <span class="n">ignore_keys_for_eval</span><span class="o">=</span><span class="n">ignore_keys_for_eval</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1785</span>     <span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/trainer.py:2085,</span> in <span class="ni">Trainer._inner_training_loop</span><span class="nt">(self, batch_size, args, resume_from_checkpoint, trial, ignore_keys_for_eval)</span>
<span class="g g-Whitespace">   </span><span class="mi">2082</span>     <span class="n">rng_to_sync</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">   </span><span class="mi">2084</span> <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="ne">-&gt; </span><span class="mi">2085</span> <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">epoch_iterator</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">2086</span>     <span class="n">total_batched_samples</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">   </span><span class="mi">2088</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">include_num_input_tokens_seen</span><span class="p">:</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/accelerate/data_loader.py:452,</span> in <span class="ni">DataLoaderShard.__iter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">450</span> <span class="c1"># We iterate one batch ahead to check when we are at the end</span>
<span class="g g-Whitespace">    </span><span class="mi">451</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">452</span>     <span class="n">current_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataloader_iter</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">453</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">454</span>     <span class="k">yield</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/torch/utils/data/dataloader.py:631,</span> in <span class="ni">_BaseDataLoaderIter.__next__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">628</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">629</span>     <span class="c1"># TODO(https://github.com/pytorch/pytorch/issues/76750)</span>
<span class="g g-Whitespace">    </span><span class="mi">630</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>  <span class="c1"># type: ignore[call-arg]</span>
<span class="ne">--&gt; </span><span class="mi">631</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">    </span><span class="mi">633</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_kind</span> <span class="o">==</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n">Iterable</span> <span class="ow">and</span> \
<span class="g g-Whitespace">    </span><span class="mi">634</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
<span class="g g-Whitespace">    </span><span class="mi">635</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span><span class="p">:</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/torch/utils/data/dataloader.py:675,</span> in <span class="ni">_SingleProcessDataLoaderIter._next_data</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">673</span> <span class="k">def</span> <span class="nf">_next_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span>     <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_index</span><span class="p">()</span>  <span class="c1"># may raise StopIteration</span>
<span class="ne">--&gt; </span><span class="mi">675</span>     <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_fetcher</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># may raise StopIteration</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">677</span>         <span class="n">data</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">pin_memory</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_device</span><span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/torch/utils/data/_utils/fetch.py:49,</span> in <span class="ni">_MapDatasetFetcher.fetch</span><span class="nt">(self, possibly_batched_index)</span>
<span class="g g-Whitespace">     </span><span class="mi">47</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_collation</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span>     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;__getitems__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">__getitems__</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">49</span>         <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">__getitems__</span><span class="p">(</span><span class="n">possibly_batched_index</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>         <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">possibly_batched_index</span><span class="p">]</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/datasets/arrow_dataset.py:2814,</span> in <span class="ni">Dataset.__getitems__</span><span class="nt">(self, keys)</span>
<span class="g g-Whitespace">   </span><span class="mi">2812</span> <span class="k">def</span> <span class="nf">__getitems__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2813</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Can be used to get a batch using a list of integers indices.&quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">2814</span>     <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2815</span>     <span class="n">n_examples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">batch</span><span class="p">))])</span>
<span class="g g-Whitespace">   </span><span class="mi">2816</span>     <span class="k">return</span> <span class="p">[{</span><span class="n">col</span><span class="p">:</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_examples</span><span class="p">)]</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/datasets/arrow_dataset.py:2810,</span> in <span class="ni">Dataset.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">   </span><span class="mi">2808</span> <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
<span class="g g-Whitespace">   </span><span class="mi">2809</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Can be used to index columns (by string names) or rows (by integer index or iterable of indices or bools).&quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">2810</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/datasets/arrow_dataset.py:2794,</span> in <span class="ni">Dataset._getitem</span><span class="nt">(self, key, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2792</span> <span class="n">format_kwargs</span> <span class="o">=</span> <span class="n">format_kwargs</span> <span class="k">if</span> <span class="n">format_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
<span class="g g-Whitespace">   </span><span class="mi">2793</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span><span class="n">format_type</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">format_kwargs</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2794</span> <span class="n">pa_subtable</span> <span class="o">=</span> <span class="n">query_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2795</span> <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">format_table</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2796</span>     <span class="n">pa_subtable</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span> <span class="n">format_columns</span><span class="o">=</span><span class="n">format_columns</span><span class="p">,</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="n">output_all_columns</span>
<span class="g g-Whitespace">   </span><span class="mi">2797</span> <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2798</span> <span class="k">return</span> <span class="n">formatted_output</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/datasets/formatting/formatting.py:583,</span> in <span class="ni">query_table</span><span class="nt">(table, key, indices)</span>
<span class="g g-Whitespace">    </span><span class="mi">581</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">582</span>     <span class="n">size</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">num_rows</span> <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">table</span><span class="o">.</span><span class="n">num_rows</span>
<span class="ne">--&gt; </span><span class="mi">583</span>     <span class="n">_check_valid_index_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">584</span> <span class="c1"># Query the main table</span>
<span class="g g-Whitespace">    </span><span class="mi">585</span> <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/datasets/formatting/formatting.py:536,</span> in <span class="ni">_check_valid_index_key</span><span class="nt">(key, size)</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span> <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">536</span>         <span class="n">_check_valid_index_key</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">537</span>         <span class="n">_check_valid_index_key</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">538</span> <span class="k">else</span><span class="p">:</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/datasets/formatting/formatting.py:526,</span> in <span class="ni">_check_valid_index_key</span><span class="nt">(key, size)</span>
<span class="g g-Whitespace">    </span><span class="mi">524</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">525</span>     <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">526</span>         <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is out of bounds for size </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">527</span>     <span class="k">return</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span> <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>

<span class="ne">IndexError</span>: Invalid key: 999976 is out of bounds for size 0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenized_dataset_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset({
    features: [&#39;text&#39;, &#39;input_ids&#39;],
    num_rows: 10000
})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_train_dataloader</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">94</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/accelerate/data_loader.py:452,</span> in <span class="ni">DataLoaderShard.__iter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">450</span> <span class="c1"># We iterate one batch ahead to check when we are at the end</span>
<span class="g g-Whitespace">    </span><span class="mi">451</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">452</span>     <span class="n">current_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataloader_iter</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">453</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">454</span>     <span class="k">yield</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/torch/utils/data/dataloader.py:631,</span> in <span class="ni">_BaseDataLoaderIter.__next__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">628</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">629</span>     <span class="c1"># TODO(https://github.com/pytorch/pytorch/issues/76750)</span>
<span class="g g-Whitespace">    </span><span class="mi">630</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>  <span class="c1"># type: ignore[call-arg]</span>
<span class="ne">--&gt; </span><span class="mi">631</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">    </span><span class="mi">633</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_kind</span> <span class="o">==</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n">Iterable</span> <span class="ow">and</span> \
<span class="g g-Whitespace">    </span><span class="mi">634</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
<span class="g g-Whitespace">    </span><span class="mi">635</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span><span class="p">:</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/torch/utils/data/dataloader.py:675,</span> in <span class="ni">_SingleProcessDataLoaderIter._next_data</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">673</span> <span class="k">def</span> <span class="nf">_next_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span>     <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_index</span><span class="p">()</span>  <span class="c1"># may raise StopIteration</span>
<span class="ne">--&gt; </span><span class="mi">675</span>     <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_fetcher</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># may raise StopIteration</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">677</span>         <span class="n">data</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">pin_memory</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_device</span><span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/torch/utils/data/_utils/fetch.py:54,</span> in <span class="ni">_MapDatasetFetcher.fetch</span><span class="nt">(self, possibly_batched_index)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>     <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">possibly_batched_index</span><span class="p">]</span>
<span class="ne">---&gt; </span><span class="mi">54</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/trainer_utils.py:787,</span> in <span class="ni">RemoveColumnsCollator.__call__</span><span class="nt">(self, features)</span>
<span class="g g-Whitespace">    </span><span class="mi">785</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<span class="g g-Whitespace">    </span><span class="mi">786</span>     <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_remove_columns</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">787</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/data/data_collator.py:271,</span> in <span class="ni">DataCollatorWithPadding.__call__</span><span class="nt">(self, features)</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="ne">--&gt; </span><span class="mi">271</span>     <span class="n">batch</span> <span class="o">=</span> <span class="n">pad_without_fast_tokenizer_warning</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">272</span>         <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">273</span>         <span class="n">features</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span>         <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span>         <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">276</span>         <span class="n">pad_to_multiple_of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_to_multiple_of</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">277</span>         <span class="n">return_tensors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">return_tensors</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span>     <span class="k">if</span> <span class="s2">&quot;label&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span>         <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/data/data_collator.py:66,</span> in <span class="ni">pad_without_fast_tokenizer_warning</span><span class="nt">(tokenizer, *pad_args, **pad_kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">deprecation_warnings</span><span class="p">[</span><span class="s2">&quot;Asking-to-pad-a-fast-tokenizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">     </span><span class="mi">65</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">66</span>     <span class="n">padded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="o">*</span><span class="n">pad_args</span><span class="p">,</span> <span class="o">**</span><span class="n">pad_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span>     <span class="c1"># Restore the state of the warning.</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>     <span class="n">tokenizer</span><span class="o">.</span><span class="n">deprecation_warnings</span><span class="p">[</span><span class="s2">&quot;Asking-to-pad-a-fast-tokenizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warning_state</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/tokenization_utils_base.py:3288,</span> in <span class="ni">PreTrainedTokenizerBase.pad</span><span class="nt">(self, encoded_inputs, padding, max_length, pad_to_multiple_of, return_attention_mask, return_tensors, verbose)</span>
<span class="g g-Whitespace">   </span><span class="mi">3286</span> <span class="c1"># The model&#39;s main input name, usually `input_ids`, has be passed for padding</span>
<span class="g g-Whitespace">   </span><span class="mi">3287</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">encoded_inputs</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">3288</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3289</span>         <span class="s2">&quot;You should supply an encoding or a list of encodings to this method &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">3290</span>         <span class="sa">f</span><span class="s2">&quot;that includes </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, but you provided </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">encoded_inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">3291</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3293</span> <span class="n">required_input</span> <span class="o">=</span> <span class="n">encoded_inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="g g-Whitespace">   </span><span class="mi">3295</span> <span class="k">if</span> <span class="n">required_input</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">required_input</span><span class="p">,</span> <span class="n">Sized</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>

<span class="ne">ValueError</span>: You should supply an encoding or a list of encodings to this method that includes input_ids, but you provided []
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wandb</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WANDB_MODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;disabled&#39;</span>
<span class="kn">import</span> <span class="nn">wandb</span> <span class="k">as</span> <span class="nn">wb</span>
<span class="n">wb</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello world&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hello world
</pre></div>
</div>
</div>
</div>
</section>
<section id="gelu-model">
<h3>GELU Model<a class="headerlink" href="#gelu-model" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">transformer_lens</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">ActivationCache</span><span class="p">,</span> <span class="n">HookedTransformer</span><span class="p">,</span> <span class="n">HookedTransformerConfig</span>
<span class="kn">from</span> <span class="nn">transformer_lens.hook_points</span> <span class="kn">import</span> <span class="n">HookPoint</span>

<span class="c1"># cfg = HookedTransformerConfig(</span>
<span class="c1">#     d_model=128,</span>
<span class="c1">#     act_fn=&#39;relu&#39;,</span>
<span class="c1">#     n_layers=1,</span>
<span class="c1">#     d_mlp=512,</span>
<span class="c1"># )</span>
<span class="n">gelu_model</span> <span class="o">=</span> <span class="n">HookedTransformer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;gelu-1l&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded pretrained model gelu-1l into HookedTransformer
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logits</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[[11.2926, -5.7966, -5.7007,  ..., -5.8662, -5.7967, -5.7530],
         [ 5.7718, -5.3477, -5.2548,  ..., -5.4195, -5.3171, -5.4112],
         [ 5.0246, -5.4987, -5.4025,  ..., -5.5617, -5.4628, -5.5536],
         [ 7.8723, -5.9839, -5.8257,  ..., -6.0378, -5.8949, -5.9977]]],
       device=&#39;mps:0&#39;, grad_fn=&lt;AddBackward0&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;am&#39;,
 &#39;Z&#39;,
 &#39;v&#39;,
 &#39;Y&#39;,
 &#39;X&#39;,
 &#39;dq&#39;,
 &#39;Z&#39;,
 &#39;W&#39;,
 &#39;9&#39;,
 &#39;p&#39;,
 &#39;Z&#39;,
 &#39;mp&#39;,
 &#39;z&#39;,
 &#39;Z&#39;,
 &#39;G&#39;,
 &#39;9&#39;,
 &#39;p&#39;,
 &#39;Z&#39;,
 &#39;2&#39;,
 &#39;h&#39;,
 &#39;ha&#39;,
 &#39;W&#39;,
 &#39;9&#39;,
 &#39;3&#39;,
 &#39;Z&#39;,
 &#39;W&#39;,
 &#39;Z&#39;,
 &#39;o&#39;,
 &#39;Y&#39;,
 &#39;X&#39;,
 &#39;dv&#39;,
 &#39;Z&#39;,
 &#39;W&#39;,
 &#39;lm&#39;,
 &#39;aml&#39;,
 &#39;hd&#39;,
 &#39;2&#39;,
 &#39;9&#39;,
 &#39;kc&#39;,
 &#39;2&#39;,
 &#39;Z&#39;,
 &#39;z&#39;,
 &#39;ZA&#39;,
 &#39;o&#39;,
 &#39;=&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_tokens</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">predicted_tokens</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;-&#39;,
 &#39;i&#39;,
 &#39;am&#39;,
 &#39;am&#39;,
 &#39;am&#39;,
 &#39;am&#39;,
 &#39;am&#39;,
 &#39;Y&#39;,
 &#39;9&#39;,
 &#39;Z&#39;,
 &#39;Y&#39;,
 &#39;y&#39;,
 &#39;Y&#39;,
 &#39;Y&#39;,
 &#39;Z&#39;,
 &#39;9&#39;,
 &#39;Z&#39;,
 &#39;Y&#39;,
 &#39;9&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;p&#39;,
 &#39;9&#39;,
 &#39;p&#39;,
 &#39;Z&#39;,
 &#39;Y&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;p&#39;,
 &#39;Y&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;Y&#39;,
 &#39;d&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;9&#39;,
 &#39;p&#39;,
 &#39;Y&#39;,
 &#39;Z&#39;,
 &#39;Z&#39;,
 &#39;z&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_tokens</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[(</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">predicted_token</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">predicted_token</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tokens</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">predicted_tokens</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;A&#39;, &#39;A&#39;),
 (&#39;AT&#39;, &#39;A&#39;),
 (&#39;TT&#39;, &#39;A&#39;),
 (&#39;GAT&#39;, &#39;A&#39;),
 (&#39;CC&#39;, &#39;A&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;ACT&#39;, &#39;A&#39;),
 (&#39;AC&#39;, &#39;AA&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;AG&#39;, &#39;A&#39;),
 (&#39;GT&#39;, &#39;A&#39;),
 (&#39;AT&#39;, &#39;A&#39;),
 (&#39;AC&#39;, &#39;CT&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;TAG&#39;, &#39;A&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;GAC&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;AG&#39;, &#39;A&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;GT&#39;, &#39;AG&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;ATT&#39;, &#39;AG&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;CT&#39;),
 (&#39;ACT&#39;, &#39;A&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;A&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;GGT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;GC&#39;),
 (&#39;GT&#39;, &#39;AG&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;CC&#39;, &#39;AT&#39;),
 (&#39;GTC&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;AC&#39;),
 (&#39;CA&#39;, &#39;AT&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AC&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;ACT&#39;, &#39;AC&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;A&#39;),
 (&#39;T&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;A&#39;),
 (&#39;CAG&#39;, &#39;A&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;AAAA&#39;, &#39;A&#39;),
 (&#39;GC&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GT&#39;, &#39;AG&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AC&#39;),
 (&#39;GGT&#39;, &#39;AC&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;GG&#39;),
 (&#39;AG&#39;, &#39;A&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;A&#39;),
 (&#39;AC&#39;, &#39;AA&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;T&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AA&#39;),
 (&#39;AG&#39;, &#39;AA&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;GCT&#39;, &#39;A&#39;),
 (&#39;A&#39;, &#39;AC&#39;),
 (&#39;ACC&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;ATA&#39;, &#39;CT&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;ACC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;A&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;CCT&#39;, &#39;A&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;GGT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;T&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AG&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;GG&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;AA&#39;, &#39;AT&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;GAA&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;GTT&#39;, &#39;A&#39;),
 (&#39;TG&#39;, &#39;AC&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;CCC&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;ATCC&#39;, &#39;AC&#39;),
 (&#39;GTT&#39;, &#39;A&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;A&#39;),
 (&#39;TT&#39;, &#39;TT&#39;),
 (&#39;T&#39;, &#39;AC&#39;),
 (&#39;CA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;TT&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;A&#39;),
 (&#39;ACT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;CA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;GC&#39;),
 (&#39;GTT&#39;, &#39;A&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;GCT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;TG&#39;, &#39;AC&#39;),
 (&#39;CC&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;TAG&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;ATCC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;GG&#39;),
 (&#39;AA&#39;, &#39;AT&#39;),
 (&#39;ACT&#39;, &#39;AC&#39;),
 (&#39;ACT&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;CCA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;GC&#39;),
 (&#39;C&#39;, &#39;GG&#39;),
 (&#39;GC&#39;, &#39;AG&#39;),
 (&#39;GCC&#39;, &#39;AT&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;A&#39;),
 (&#39;CCT&#39;, &#39;GC&#39;),
 (&#39;CAT&#39;, &#39;AC&#39;),
 (&#39;G&#39;, &#39;ATT&#39;),
 (&#39;CA&#39;, &#39;AT&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AG&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;CC&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;AC&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;TT&#39;),
 (&#39;TT&#39;, &#39;TT&#39;),
 (&#39;GAC&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;G&#39;, &#39;ACC&#39;),
 (&#39;TA&#39;, &#39;CT&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;AAAA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AAA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;AT&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AC&#39;),
 (&#39;GGT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;ACT&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;CA&#39;, &#39;AC&#39;),
 (&#39;ATCC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;AT&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;A&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;CAT&#39;, &#39;AC&#39;),
 (&#39;AGT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;GC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;TG&#39;, &#39;AC&#39;),
 (&#39;AGT&#39;, &#39;AC&#39;),
 (&#39;CC&#39;, &#39;AC&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;CAG&#39;, &#39;AC&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;GGT&#39;, &#39;AC&#39;),
 (&#39;AAA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GG&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;CCC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GTT&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;CC&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AT&#39;),
 (&#39;TA&#39;, &#39;AC&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;TT&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;CAG&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;TT&#39;, &#39;TT&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;GG&#39;),
 (&#39;AT&#39;, &#39;GG&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;TG&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;CC&#39;, &#39;AT&#39;),
 (&#39;CA&#39;, &#39;AT&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;CG&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;CAT&#39;, &#39;AC&#39;),
 (&#39;CA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;GG&#39;),
 (&#39;GG&#39;, &#39;AT&#39;),
 (&#39;GCT&#39;, &#39;AC&#39;),
 (&#39;G&#39;, &#39;CA&#39;),
 (&#39;TA&#39;, &#39;CT&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;TT&#39;),
 (&#39;TT&#39;, &#39;TT&#39;),
 (&#39;GTT&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;CTC&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GAC&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;AT&#39;, &#39;AG&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;AT&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;AC&#39;),
 (&#39;CA&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GCT&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;CG&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GAA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;GG&#39;),
 (&#39;CA&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;GG&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GT&#39;, &#39;AG&#39;),
 (&#39;GT&#39;, &#39;AG&#39;),
 (&#39;AA&#39;, &#39;AT&#39;),
 (&#39;ACT&#39;, &#39;AT&#39;),
 (&#39;A&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;GA&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;GC&#39;),
 (&#39;ATCC&#39;, &#39;AC&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;C&#39;, &#39;AA&#39;),
 (&#39;GT&#39;, &#39;AG&#39;),
 (&#39;CC&#39;, &#39;AT&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;ATT&#39;, &#39;AC&#39;),
 (&#39;CTT&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AG&#39;),
 (&#39;CC&#39;, &#39;AT&#39;),
 (&#39;G&#39;, &#39;ATT&#39;),
 (&#39;TA&#39;, &#39;CT&#39;),
 (&#39;AT&#39;, &#39;TT&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;AT&#39;, &#39;TT&#39;),
 (&#39;GAT&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;CT&#39;, &#39;AT&#39;),
 (&#39;AT&#39;, &#39;AC&#39;),
 (&#39;GCC&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;AT&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;ACC&#39;, &#39;AT&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;GC&#39;, &#39;AT&#39;),
 (&#39;ACC&#39;, &#39;AT&#39;),
 (&#39;GG&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AT&#39;),
 (&#39;AA&#39;, &#39;AT&#39;),
 (&#39;AC&#39;, &#39;AC&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AT&#39;),
 (&#39;AG&#39;, &#39;AC&#39;),
 (&#39;TT&#39;, &#39;AC&#39;),
 (&#39;T&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AG&#39;),
 (&#39;CT&#39;, &#39;AC&#39;),
 (&#39;AA&#39;, &#39;AC&#39;),
 (&#39;GT&#39;, &#39;AC&#39;),
 (&#39;ATCC&#39;, &#39;AC&#39;),
 (&#39;GTT&#39;, &#39;AC&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;GAG&#39;, &#39;AC&#39;),
 (&#39;CCT&#39;, &#39;AC&#39;),
 (&#39;TC&#39;, &#39;AC&#39;),
 (&#39;AC&#39;, &#39;AC&#39;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logits</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">59</span><span class="p">]])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">188</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[188]], device=&#39;mps:0&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">gelu_model</span>
<span class="k">def</span> <span class="nf">strings_to_tokens</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">string</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">pad_sequence</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;we are so back lmao&#39;</span><span class="p">,</span> <span class="s1">&#39;omg&#39;</span><span class="p">,</span> <span class="s1">&#39;pad see ew&#39;</span><span class="p">]</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">strings_to_tokens</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[  662,   403,   593,   888,   299,   781,    81],
        [  298,    73,     0,     0,     0,     0,     0],
        [10737,   915,   300,    89,     0,     0,     0]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">gelu_model</span>
<span class="n">logits</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_with_cache</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>
<span class="n">decode</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;wewewewewewewe&#39;, &#39;ishingomTheThe###&#39;, &#39;selfpadpadpadThe##&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;bound method Module.parameters of HookedTransformer(
  (embed): Embed()
  (hook_embed): HookPoint()
  (pos_embed): PosEmbed()
  (hook_pos_embed): HookPoint()
  (blocks): ModuleList(
    (0): TransformerBlock(
      (ln1): LayerNormPre(
        (hook_scale): HookPoint()
        (hook_normalized): HookPoint()
      )
      (ln2): LayerNormPre(
        (hook_scale): HookPoint()
        (hook_normalized): HookPoint()
      )
      (attn): Attention(
        (hook_k): HookPoint()
        (hook_q): HookPoint()
        (hook_v): HookPoint()
        (hook_z): HookPoint()
        (hook_attn_scores): HookPoint()
        (hook_pattern): HookPoint()
        (hook_result): HookPoint()
      )
      (mlp): MLP(
        (hook_pre): HookPoint()
        (hook_post): HookPoint()
      )
      (hook_attn_in): HookPoint()
      (hook_q_input): HookPoint()
      (hook_k_input): HookPoint()
      (hook_v_input): HookPoint()
      (hook_mlp_in): HookPoint()
      (hook_attn_out): HookPoint()
      (hook_mlp_out): HookPoint()
      (hook_resid_pre): HookPoint()
      (hook_resid_mid): HookPoint()
      (hook_resid_post): HookPoint()
    )
  )
  (ln_final): LayerNormPre(
    (hook_scale): HookPoint()
    (hook_normalized): HookPoint()
  )
  (unembed): Unembed()
)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acts</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decode</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;wewewewewewewe&#39;, &#39;ishingomTheThe###&#39;, &#39;selfpadpadpadThe##&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gelu_model</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HookedTransformerConfig:
{&#39;act_fn&#39;: &#39;gelu&#39;,
 &#39;attention_dir&#39;: &#39;causal&#39;,
 &#39;attn_only&#39;: False,
 &#39;attn_types&#39;: None,
 &#39;checkpoint_index&#39;: None,
 &#39;checkpoint_label_type&#39;: None,
 &#39;checkpoint_value&#39;: None,
 &#39;d_head&#39;: 64,
 &#39;d_mlp&#39;: 2048,
 &#39;d_model&#39;: 512,
 &#39;d_vocab&#39;: 48262,
 &#39;d_vocab_out&#39;: 48262,
 &#39;default_prepend_bos&#39;: True,
 &#39;device&#39;: device(type=&#39;mps&#39;),
 &#39;dtype&#39;: torch.float32,
 &#39;eps&#39;: 1e-05,
 &#39;final_rms&#39;: False,
 &#39;from_checkpoint&#39;: False,
 &#39;gated_mlp&#39;: False,
 &#39;init_mode&#39;: &#39;gpt2&#39;,
 &#39;init_weights&#39;: False,
 &#39;initializer_range&#39;: 0.035355339059327376,
 &#39;model_name&#39;: &#39;GELU_1L512W_C4_Code&#39;,
 &#39;n_ctx&#39;: 1024,
 &#39;n_devices&#39;: 1,
 &#39;n_heads&#39;: 8,
 &#39;n_key_value_heads&#39;: None,
 &#39;n_layers&#39;: 1,
 &#39;n_params&#39;: 3145728,
 &#39;normalization_type&#39;: &#39;LNPre&#39;,
 &#39;original_architecture&#39;: &#39;neel&#39;,
 &#39;parallel_attn_mlp&#39;: False,
 &#39;positional_embedding_type&#39;: &#39;standard&#39;,
 &#39;post_embedding_ln&#39;: False,
 &#39;rotary_adjacent_pairs&#39;: False,
 &#39;rotary_base&#39;: 10000,
 &#39;rotary_dim&#39;: None,
 &#39;scale_attn_by_inverse_layer_idx&#39;: False,
 &#39;seed&#39;: None,
 &#39;tokenizer_name&#39;: &#39;NeelNanda/gpt-neox-tokenizer-digits&#39;,
 &#39;tokenizer_prepends_bos&#39;: False,
 &#39;trust_remote_code&#39;: False,
 &#39;use_attn_in&#39;: False,
 &#39;use_attn_result&#39;: False,
 &#39;use_attn_scale&#39;: True,
 &#39;use_hook_mlp_in&#39;: False,
 &#39;use_hook_tokens&#39;: False,
 &#39;use_local_attn&#39;: False,
 &#39;use_split_qkv_input&#39;: False,
 &#39;window_size&#39;: None}
</pre></div>
</div>
</div>
</div>
</section>
<section id="sae">
<h3>SAE<a class="headerlink" href="#sae" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">einops</span>

<span class="n">sae_input_dim</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">d_mlp</span>
<span class="n">sae_hidden_dim</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">sae_input_dim</span>
<span class="n">sae_output_dim</span> <span class="o">=</span> <span class="n">sae_input_dim</span>

<span class="k">class</span> <span class="nc">SAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">input_dim</span><span class="o">=</span><span class="n">sae_input_dim</span><span class="p">,</span>
                 <span class="n">hidden_dim</span><span class="o">=</span><span class="n">sae_hidden_dim</span><span class="p">,</span>
                 <span class="n">init_range</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_range</span> <span class="o">=</span> <span class="n">init_range</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">init_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">relu</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">inputs_centered</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">inputs_centered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">,</span>
                                  <span class="s1">&#39;batch input_dim, hidden_dim input_dim -&gt; batch hidden_dim&#39;</span><span class="p">)</span>
        <span class="n">act_input</span> <span class="o">=</span> <span class="n">act_input</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">act_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_d</span><span class="p">,</span>
                               <span class="s1">&#39;batch hidden_dim, input_dim hidden_dim -&gt; batch input_dim&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_d</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sae</span> <span class="o">=</span> <span class="n">SAE</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acts_flat</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="s1">&#39;b s act -&gt; (b s) act&#39;</span><span class="p">)</span>
<span class="n">encodings</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">acts_flat</span><span class="p">)</span>
<span class="n">encodings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[0.0000, 0.1662, 0.0000,  ..., 0.0000, 0.7530, 0.0000],
        [0.0000, 0.0000, 0.0000,  ..., 0.0000, 1.2454, 0.0000],
        [0.0000, 0.2556, 0.0000,  ..., 0.0000, 1.8661, 0.0000],
        ...,
        [0.1642, 0.2159, 0.1225,  ..., 0.0000, 1.0308, 0.0000],
        [0.3733, 0.2535, 0.0264,  ..., 0.5381, 0.9750, 0.0000],
        [0.3934, 0.2057, 0.0000,  ..., 0.7450, 0.9278, 0.0000]],
       device=&#39;mps:0&#39;, grad_fn=&lt;ReluBackward0&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sae_output</span> <span class="o">=</span> <span class="n">sae</span><span class="p">(</span><span class="n">acts_flat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sae_output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([21, 2048])
</pre></div>
</div>
</div>
</div>
</section>
<section id="generating-activation-dataset">
<h3>Generating activation dataset<a class="headerlink" href="#generating-activation-dataset" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="n">sae</span><span class="p">,</span> <span class="n">l1_coeff</span><span class="o">=</span><span class="mf">0.006</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">sae_output</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">rec_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">acts</span> <span class="o">-</span> <span class="n">sae_output</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">l1_loss</span> <span class="o">=</span> <span class="n">l1_coeff</span> <span class="o">*</span> <span class="n">features</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rec_loss</span> <span class="o">+</span> <span class="n">l1_loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">dataset_name</span> <span class="o">=</span> <span class="s1">&#39;JeanKaddour/minipile&#39;</span>
<span class="n">train_text</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[:1024]&#39;</span><span class="p">)</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">512</span>

<span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">tokenized_row</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">)</span>
    <span class="n">pad_length</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="n">tokenized_row</span><span class="p">[</span><span class="s1">&#39;token_type_ids&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_length</span>
    <span class="k">return</span> <span class="n">tokenized_row</span>


<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_text</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_row</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2df4bc3db53c46d2a524d361f02315b1", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Truncation was not explicitly activated but `max_length` is provided a specific value, please use `truncation=True` to explicitly truncate examples to max length. Defaulting to &#39;longest_first&#39; truncation strategy. If you encode pairs of sequences (GLUE-style) with the tokenizer you can select this strategy more precisely by providing a specific strategy to `truncation`.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>512
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">all_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">_</span> <span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">run_with_cache</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">]</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="s1">&#39;batch sequence d_mlp -&gt; (batch sequence) d_mlp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">all_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">all_acts</span><span class="p">,</span> <span class="n">acts</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">all_acts</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">f</span><span class="o">=</span><span class="s1">&#39;mlp_activations_64bs_512l_minipile1024_gelu1l.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training">
<h3>Training<a class="headerlink" href="#training" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_acts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="s1">&#39;mlp_activations_64bs_512l_minipile1024_gelu1l.pkl&#39;</span><span class="p">)</span>

<span class="n">rand_indices</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">all_acts</span> <span class="o">=</span> <span class="n">all_acts</span><span class="p">[</span><span class="n">rand_indices</span><span class="p">]</span>
<span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([524288, 2048])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">l1_coeff</span> <span class="o">=</span> <span class="mf">0.006</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">sae</span> <span class="o">=</span> <span class="n">SAE</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">sae</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">sae</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)):</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">all_acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">batch_size</span>
    <span class="n">epoch_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">)):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">all_acts</span><span class="p">[</span><span class="n">i_batch</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:</span> <span class="p">(</span><span class="n">i_batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">get_loss</span><span class="p">(</span><span class="n">acts</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">sae</span><span class="o">=</span><span class="n">sae</span><span class="p">,</span> <span class="n">l1_coeff</span><span class="o">=</span><span class="n">l1_coeff</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">epoch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i_batch</span><span class="o">%</span><span class="k">100</span> == 0 or (i_batch &lt; 100 and i_batch % 10 == 0 and i==0)):
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">i_batch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/3 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/0: 8.264573097229004
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/10: 0.7321810722351074
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/20: 0.2547191381454468
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/30: 0.17331887781620026
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/40: 0.13515867292881012
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/50: 0.11307991296052933
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/60: 0.1077914908528328
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/70: 0.10253268480300903
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/80: 0.09983061999082565
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/90: 0.09604736417531967
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/100: 0.08958395570516586
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/200: 0.07334491610527039
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/300: 0.062314774841070175
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/400: 0.05602551996707916
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0/500: 0.05334043875336647
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 512/512 [00:36&lt;00:00, 14.14it/s]
 33%|███▎      | 1/3 [00:36&lt;01:12, 36.22s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/0: 0.05227159336209297
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 4/512 [00:00&lt;00:33, 15.02it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/100: 0.04738108813762665
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/200: 0.045205436646938324
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/300: 0.04433976486325264
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 79%|███████▉  | 404/512 [00:27&lt;00:07, 14.69it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/400: 0.042124148458242416
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/500: 0.04332846775650978
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 512/512 [00:34&lt;00:00, 14.82it/s]
 67%|██████▋   | 2/3 [01:10&lt;00:35, 35.24s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/0: 0.042585015296936035
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/100: 0.040313106030225754
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/200: 0.0392337292432785
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 59%|█████▉    | 304/512 [00:20&lt;00:13, 14.94it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/300: 0.039021700620651245
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/400: 0.037467144429683685
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/500: 0.038338176906108856
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 512/512 [00:34&lt;00:00, 14.91it/s]
100%|██████████| 3/3 [01:45&lt;00:00, 35.04s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="n">all_losses</span> <span class="o">=</span> <span class="n">losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">losses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">losses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">all_losses</span><span class="p">,</span> <span class="n">log_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">max_ratios</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mean_ratios</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">square_ratios</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">test_feature_index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)):</span>
    <span class="n">test_feature</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">test_feature</span><span class="p">[</span><span class="n">test_feature_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">test_feature</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">test_mlp_activation</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">test_feature</span><span class="p">)</span>
    <span class="n">encoded_features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">test_mlp_activation</span><span class="p">)</span>
    <span class="n">max_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mean_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">square_ratio</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">max_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">mean_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">square_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">square_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="c1"># px.line(encoded_features[0].cpu().detach().numpy())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 16384/16384 [01:50&lt;00:00, 148.36it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">max_ratios</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">mean_ratios</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ratios</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_feature</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sae_hidden_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">test_feature_index</span> <span class="o">=</span> <span class="mi">39</span>
<span class="n">test_feature</span><span class="p">[</span><span class="n">test_feature_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">test_feature</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">test_mlp_activation</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">test_feature</span><span class="p">)</span>
<span class="n">encoded_features</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">test_mlp_activation</span><span class="p">)</span>
<span class="n">test_feature_to_max</span> <span class="o">=</span> <span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">test_feature_index</span><span class="p">]</span><span class="o">/</span><span class="n">encoded_features</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">encoded_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">W_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">mlp_out</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">test_mlp_activation</span><span class="p">,</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">W_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;batch d_mlp, d_mlp d_model -&gt; batch d_model&#39;</span><span class="p">)</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">mlp_out</span><span class="p">,</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">W_U</span><span class="p">,</span>
                       <span class="s1">&#39;batch d_model, d_model d_vocab -&gt; batch d_vocab&#39;</span><span class="p">)</span>
<span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([2048, 512])
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;itage&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># px.line(sorted(logits[0].detach().cpu().numpy(), reverse=True))</span>
<span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sorted_inds</span>
<span class="k">for</span> <span class="n">token_ind</span> <span class="ow">in</span> <span class="n">sorted_inds</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token_ind</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>itage
zel
itt
akers
bra
anc
orthy
ater
orph
eler
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sae</span><span class="p">,</span> <span class="s1">&#39;sae-0430.pt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformer_lens.utils</span> <span class="kn">import</span> <span class="n">get_dataset</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">load_sample_training_dataset</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a6254c8223a34f35880261a97799a5c9", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data: 100%|██████████| 42.8M/42.8M [00:02&lt;00:00, 19.9MB/s]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7267835ecb8442b4a2afe66e476aff18", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gelu_model</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">original_architecture</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;neel&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">((</span><span class="n">act</span><span class="o">-</span><span class="n">reconstruction</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="plugging-sae-into-transformer">
<h3>Plugging SAE into transformer<a class="headerlink" href="#plugging-sae-into-transformer" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
<span class="n">sae</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;sae-0430.pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mlp_activations_64bs_512l_minipile1024_gelu1l.pkl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">feats</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_str</span> <span class="o">=</span> <span class="s1">&#39;Hello from the other side this is incredible&#39;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_str</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">input_str_tokenized</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>

<span class="n">mlp_acts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sae_feats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mlp_acts_reconstructed</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">save_mlp_acts_hook</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
    <span class="n">mlp_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sae_reconstruction_hook</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
    <span class="n">mlp_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">flat_value</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;b s d_mlp -&gt; (b s) d_mlp&#39;</span><span class="p">)</span>
    <span class="c1"># Encode MLP acts into SAE features</span>
    <span class="n">flat_sae_feats</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">flat_value</span><span class="p">)</span>
    <span class="n">reshaped_sae_feats</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">flat_sae_feats</span><span class="p">,</span> <span class="s1">&#39;(b s) hidden_dim -&gt; b s hidden_dim&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">sae_feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reshaped_sae_feats</span><span class="p">)</span>
    <span class="c1"># Decode SAE features to reconstruct MLP activations</span>
    <span class="n">flat_mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">flat_sae_feats</span><span class="p">)</span>
    <span class="n">reshaped_mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">flat_mlp_acts_reconstructed</span><span class="p">,</span>
                                                       <span class="s1">&#39;(b s) d_mlp -&gt; b s d_mlp&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">mlp_acts_reconstructed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reshaped_mlp_acts_reconstructed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reshaped_mlp_acts_reconstructed</span>


<span class="n">gelu_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">sae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="p">(</span><span class="n">input_tokens</span><span class="p">)</span>
<span class="n">logits_sae</span> <span class="o">=</span> <span class="n">gelu_model</span><span class="o">.</span><span class="n">run_with_hooks</span><span class="p">(</span>
    <span class="n">input_tokens</span><span class="p">,</span>
    <span class="n">fwd_hooks</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span>
        <span class="s1">&#39;blocks.0.mlp.hook_post&#39;</span><span class="p">,</span>
        <span class="n">sae_reconstruction_hook</span>
    <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">logits_sae</span> <span class="o">=</span> <span class="n">logits_sae</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">mlp_acts</span> <span class="o">=</span> <span class="n">mlp_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sae_feats</span> <span class="o">=</span> <span class="n">sae_feats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mlp_acts_reconstructed</span> <span class="o">=</span> <span class="n">mlp_acts_reconstructed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sorted_inds</span><span class="p">[:,</span> <span class="p">:</span><span class="n">top_k</span><span class="p">])</span>
    
<span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">271</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sorted_inds</span><span class="p">[:,</span> <span class="p">:</span><span class="n">top_k</span><span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>

<span class="nn">Cell In[271], line 4,</span> in <span class="ni">get_top_tokens</span><span class="nt">(logits, model, top_k)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sorted_inds</span><span class="p">[:,</span> <span class="p">:</span><span class="n">top_k</span><span class="p">])</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/tokenization_utils_base.py:3825,</span> in <span class="ni">PreTrainedTokenizerBase.decode</span><span class="nt">(self, token_ids, skip_special_tokens, clean_up_tokenization_spaces, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">3822</span> <span class="c1"># Convert inputs to python lists</span>
<span class="g g-Whitespace">   </span><span class="mi">3823</span> <span class="n">token_ids</span> <span class="o">=</span> <span class="n">to_py_obj</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">3825</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3826</span>     <span class="n">token_ids</span><span class="o">=</span><span class="n">token_ids</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3827</span>     <span class="n">skip_special_tokens</span><span class="o">=</span><span class="n">skip_special_tokens</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3828</span>     <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="n">clean_up_tokenization_spaces</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3829</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3830</span> <span class="p">)</span>

<span class="nn">File ~/.virtualenvs/mi-notebooks/lib/python3.11/site-packages/transformers/tokenization_utils_fast.py:625,</span> in <span class="ni">PreTrainedTokenizerFast._decode</span><span class="nt">(self, token_ids, skip_special_tokens, clean_up_tokenization_spaces, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">623</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">624</span>     <span class="n">token_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">token_ids</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">625</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="n">skip_special_tokens</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">627</span> <span class="n">clean_up_tokenization_spaces</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">628</span>     <span class="n">clean_up_tokenization_spaces</span>
<span class="g g-Whitespace">    </span><span class="mi">629</span>     <span class="k">if</span> <span class="n">clean_up_tokenization_spaces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">630</span>     <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_tokenization_spaces</span>
<span class="g g-Whitespace">    </span><span class="mi">631</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span> <span class="k">if</span> <span class="n">clean_up_tokenization_spaces</span><span class="p">:</span>

<span class="ne">TypeError</span>: argument &#39;ids&#39;: &#39;list&#39; object cannot be interpreted as an integer
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_inds</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">top_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pos_top_tokens</span> <span class="o">=</span> <span class="n">sorted_inds</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span>
        <span class="n">pos_top_tokens_decoded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">top_k_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">top_k</span><span class="p">):</span>
            <span class="n">pos_top_tokens_decoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">pos_top_tokens</span><span class="p">[</span><span class="n">top_k_ind</span><span class="p">]))</span>
        <span class="n">top_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_top_tokens_decoded</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_tokens</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_tokens_orig</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
<span class="n">top_tokens_recons</span> <span class="o">=</span> <span class="n">get_top_tokens</span><span class="p">(</span><span class="n">logits_sae</span><span class="p">,</span> <span class="n">gelu_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">input_str_token</span><span class="p">,</span> <span class="n">top_k_orig</span><span class="p">,</span> <span class="n">top_k_recons</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_str_tokenized</span><span class="p">,</span> 
                                                     <span class="n">top_tokens_orig</span><span class="p">,</span> 
                                                     <span class="n">top_tokens_recons</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input: </span><span class="si">{</span><span class="n">input_str_token</span><span class="si">}</span><span class="se">\t</span><span class="s1">Original top 5:</span><span class="si">{</span><span class="n">top_k_orig</span><span class="si">}</span><span class="se">\t</span><span class="s1">Reconstructed top 5:</span><span class="si">{</span><span class="n">top_k_recons</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input: Hello	Original top 5:[&#39;0&#39;, &#39; I&#39;, &#39; Thanks&#39;, &#39;1&#39;, &#39; Thank&#39;]	Reconstructed top 5:[&#39;1&#39;, &#39;oth&#39;, &#39;k&#39;, &#39;EE&#39;, &#39;2&#39;]
Input: Ġfrom	Original top 5:[&#39; my&#39;, &#39; I&#39;, &#39;0&#39;, &#39; Welcome&#39;, &#39; 2&#39;]	Reconstructed top 5:[&#39;k&#39;, &#39;t&#39;, &#39;est&#39;, &#39;h&#39;, &#39;self&#39;]
Input: Ġthe	Original top 5:[&#39; same&#39;, &#39; I&#39;, &#39; website&#39;, &#39; Welcome&#39;, &#39; name&#39;]	Reconstructed top 5:[&#39;t&#39;, &#39;k&#39;, &#39;eter&#39;, &#39;self&#39;, &#39;body&#39;]
Input: Ġother	Original top 5:[&#39; website&#39;, &#39;Hello&#39;, &#39; course&#39;, &#39; part&#39;, &#39; blog&#39;]	Reconstructed top 5:[&#39; is&#39;, &#39; are&#39;, &#39;.&#39;, &#39;h&#39;, &#39;le&#39;]
Input: Ġside	Original top 5:[&#39; of&#39;, &#39; I&#39;, &#39;Hello&#39;, &#39; and&#39;, &#39;0&#39;]	Reconstructed top 5:[&#39; are&#39;, &#39; is&#39;, &#39; have&#39;, &#39; has&#39;, &#39; may&#39;]
Input: Ġthis	Original top 5:[&#39;Hello&#39;, &#39; blog&#39;, &#39; is&#39;, &#39;Hi&#39;, &#39; I&#39;]	Reconstructed top 5:[&#39;text&#39;, &#39; is&#39;, &#39; are&#39;, &#39;atable&#39;, &#39;le&#39;]
Input: Ġis	Original top 5:[&#39; my&#39;, &#39;Hello&#39;, &#39; work&#39;, &#39; the&#39;, &#39; a&#39;]	Reconstructed top 5:[&#39; is&#39;, &#39; are&#39;, &#39;i&#39;, &#39; has&#39;, &#39;yl&#39;]
Input: Ġincredible	Original top 5:[&#39; and&#39;, &#39; work&#39;, &#39;Hello&#39;, &#39; I&#39;, &#39;,&#39;]	Reconstructed top 5:[&#39;h&#39;, &#39;le&#39;, &#39;body&#39;, &#39;f&#39;, &#39;ff&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crossentropy</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">logits_sae</span><span class="p">,</span> 
                                             <span class="n">target</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>
<span class="n">crossentropy</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor(-215541.6250, device=&#39;mps:0&#39;, grad_fn=&lt;DivBackward1&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor(10.7419, device=&#39;mps:0&#39;, grad_fn=&lt;DivBackward1&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">logits_sae</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./03-sae"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mechanistic Interpretability Notebooks</p>
      </div>
    </a>
    <a class="right-next"
       href="../00-basic-concepts/01-fourier-transform.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Frequency-Domain Analysis and Fourier Transforms</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monday-4-29-24">Monday 4/29/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tuesday-4-30-24">Tuesday 4/30/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thursday-5-2-24">Thursday 5/2/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monday-5-6-24">Monday 5/6/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tuesday-5-7-24">Tuesday 5/7/24</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#messy-from-here-on">Messy from here on</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hf-dataset">HF dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gelu-model">GELU Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sae">SAE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-activation-dataset">Generating activation dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plugging-sae-into-transformer">Plugging SAE into transformer</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dani Balcells
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>